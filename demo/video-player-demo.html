<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æ’­æ”¾æ¼”ç¤º - æ•™å¸ˆè§†é¢‘ä¿±ä¹éƒ¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; padding-top: 20px; }
        .main-container { max-width: 1200px; margin: 0 auto; }
        
        /* æ’­æ”¾å™¨åŒºåŸŸ */
        .player-wrapper {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video { width: 100%; height: 100%; outline: none; }
        
        /* åˆ—è¡¨åŒºåŸŸ */
        .list-wrapper {
            background: #fff;
            border-radius: 8px;
            height: 600px; /* å›ºå®šé«˜åº¦ */
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .video-item {
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #eee;
            padding: 10px;
        }
        .video-item:hover { background-color: #f8f9fa; }
        .video-item.active { background-color: #e7f1ff; border-left: 4px solid #0d6efd; }
        
        .item-title { font-weight: bold; font-size: 15px; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;}
        .item-meta { font-size: 12px; color: #666; }
        
        .empty-state { text-align: center; color: #999; margin-top: 100px; }
    </style>
</head>
<body>

<div class="container main-container">
    <h3 class="mb-4 text-primary fw-bold"><span class="text-dark">ğŸ¬</span> è§†é¢‘ä¿±ä¹éƒ¨æ’­æ”¾å™¨</h3>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label fw-bold">ç™»å½• Token</label>
                    <input type="text" id="authToken" class="form-control form-control-sm" placeholder="ç²˜è´´ Bearer Token">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Club ID</label>
                    <input type="number" id="clubId" class="form-control form-control-sm" value="3001">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm w-100" onclick="loadVideoList()">ğŸ”„ åŠ è½½è§†é¢‘åˆ—è¡¨</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="player-wrapper mb-3">
                <video id="mainVideo" controls poster="">
                    <p class="text-white">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HTML5 è§†é¢‘ã€‚</p>
                </video>
            </div>
            
            <div class="bg-white p-3 rounded shadow-sm">
                <h4 id="displayTitle">è¯·å…ˆé€‰æ‹©è§†é¢‘</h4>
                <div class="d-flex justify-content-between text-muted small mt-2">
                    <span>
                        ğŸ‘¤ ä¸Šä¼ è€…: <span id="displayUploader">-</span>
                        <span class="mx-2">|</span>
                        ğŸ•’ æ—¶é•¿: <span id="displayDuration">-</span>
                    </span>
                    <span id="displayTime">-</span>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="list-wrapper">
                <div class="p-3 border-bottom bg-light fw-bold sticky-top">
                    ğŸ“º æ’­æ”¾åˆ—è¡¨
                </div>
                <div id="videoListContainer">
                    <div class="empty-state">
                        <p>æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»â€œåŠ è½½è§†é¢‘åˆ—è¡¨â€</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // é…ç½®åç«¯åœ°å€
    const API_BASE_URL = 'http://localhost:3000/api/v1';
    let currentVideos = []; // å­˜å‚¨å½“å‰çš„è§†é¢‘æ•°æ®

    // æ ¼å¼åŒ–æ—¶é—´ (ç§’ -> mm:ss)
    function formatDuration(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m}:${s < 10 ? '0' + s : s}`;
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(isoString) {
        return new Date(isoString).toLocaleString();
    }

    // åŠ è½½è§†é¢‘åˆ—è¡¨
    async function loadVideoList() {
        const token = document.getElementById('authToken').value.trim();
        const clubId = document.getElementById('clubId').value;
        const listContainer = document.getElementById('videoListContainer');

        if (!token) return alert('è¯·å…ˆå¡«å†™ Token');
        if (!clubId) return alert('è¯·å¡«å†™ Club ID');

        listContainer.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary"></div><p>åŠ è½½ä¸­...</p></div>';

        try {
            // è°ƒç”¨ GET /videos æ¥å£
            const res = await axios.get(`${API_BASE_URL}/videos`, {
                params: { clubId: clubId, pageSize: 50 }, // è·å–å‰50æ¡
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.data.code !== 0) throw new Error(res.data.msg);

            const videos = res.data.data.list;
            currentVideos = videos;

            renderList(videos);

            // å¦‚æœæœ‰è§†é¢‘ï¼Œé»˜è®¤æ’­æ”¾ç¬¬ä¸€ä¸ª
            if (videos.length > 0) {
                playVideo(0);
            }

        } catch (err) {
            console.error(err);
            listContainer.innerHTML = `<div class="text-danger p-3 text-center">åŠ è½½å¤±è´¥: ${err.message}</div>`;
        }
    }

    // æ¸²æŸ“åˆ—è¡¨ HTML
    function renderList(videos) {
        const container = document.getElementById('videoListContainer');
        
        if (videos.length === 0) {
            container.innerHTML = '<div class="empty-state">è¯¥ä¿±ä¹éƒ¨æš‚æ— è§†é¢‘</div>';
            return;
        }

        let html = '';
        videos.forEach((video, index) => {
            html += `
                <div class="video-item" onclick="playVideo(${index})" id="video-item-${index}">
                    <div class="d-flex align-items-start">
                        <div class="me-2 text-muted small">${index + 1}.</div>
                        <div>
                            <div class="item-title">${video.title}</div>
                            <div class="item-meta">
                                <span>${video.uploaderName || 'æœªçŸ¥ç”¨æˆ·'}</span> â€¢ 
                                <span>${formatDuration(video.duration)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    // æ’­æ”¾æŒ‡å®šç´¢å¼•çš„è§†é¢‘
    function playVideo(index) {
        const video = currentVideos[index];
        if (!video) return;

        // 1. æ›´æ–° UI é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.video-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`video-item-${index}`)?.classList.add('active');

        // 2. æ›´æ–°æ’­æ”¾å™¨
        const player = document.getElementById('mainVideo');
        const displayTitle = document.getElementById('displayTitle');
        const displayUploader = document.getElementById('displayUploader');
        const displayDuration = document.getElementById('displayDuration');
        const displayTime = document.getElementById('displayTime');

        // å…³é”®ï¼šåç«¯è¿”å›çš„ playUrl
        // æ³¨æ„ï¼šå¦‚æœä½ é…ç½®çš„ä¸ƒç‰›åŸŸåæ˜¯ http çš„ï¼Œè€Œä½ æœ¬åœ°ä¹Ÿæ˜¯ httpï¼Œé€šå¸¸æ²¡é—®é¢˜ã€‚
        // æ··åˆå†…å®¹(Mixed Content) å¯èƒ½ä¼šåœ¨ HTTPS ç¯å¢ƒä¸‹æ‹¦æˆª HTTP è§†é¢‘ã€‚
        console.log('æ­£åœ¨æ’­æ”¾ URL:', video.playUrl);
        
        player.src = video.playUrl;
        player.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨æ‹¦æˆªï¼Œéœ€ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»', e));

        // 3. æ›´æ–°ä¿¡æ¯å±•ç¤º
        displayTitle.innerText = video.title;
        displayUploader.innerText = video.uploaderName || 'æœªçŸ¥';
        displayDuration.innerText = formatDuration(video.duration);
        displayTime.innerText = formatDate(video.createdAt);
        
        // 4. æ»šåŠ¨åˆ—è¡¨åˆ°å½“å‰é¡¹
        document.getElementById(`video-item-${index}`)?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
</script>

</body>
</html>