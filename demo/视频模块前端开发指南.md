# 视频模块前端开发指南

## 1. 概述

本模块采用 **“后端签发凭证 -> 前端直传七牛云 -> 后端保存元数据”** 的流程。
前端不再将大文件发送给后端服务器，而是直接上传到云存储，从而节省服务器带宽并提升上传速度。

### 核心依赖

* **HTTP 客户端**: Axios (或其他 fetch 封装)
* **七牛云 SDK**: `qiniu-js`
* CDN: `https://cdn.staticfile.org/qiniu-js/3.4.1/qiniu.min.js`
* NPM: `npm install qiniu-js`

---

## 2. 核心流程图解

1. **准备阶段**: 用户选择文件 -> 前端解析视频时长 (`duration`)。
2. **获取凭证**: 请求 `GET /api/v1/videos/token` 获取上传 Token。
3. **执行上传**: 调用 `qiniu.upload()` 将文件推送到七牛云。
4. **保存数据**: 上传成功后，将七牛返回的 `key` (文件名) 和 `hash` (ETag) 发送给后端 `POST /api/v1/videos` 进行归档。

---

## 3. 详细实现指南

### 3.1 视频上传 (Upload)

#### 步骤一：获取视频元数据 (时长)

后端接口要求必须提交视频时长 (`duration`)。在上传前，我们需要利用 HTML5 `<video>` 标签预加载文件来获取此时长。

```javascript
/**
 * 解析本地视频文件时长
 * @param {File} file - 用户选择的文件对象
 * @returns {Promise<number>} - 视频时长（秒）
 */
function getVideoDuration(file) {
    return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.onloadedmetadata = function() {
            window.URL.revokeObjectURL(video.src);
            resolve(Math.round(video.duration)); // 四舍五入取整
        };
        video.onerror = function() {
            reject("无法解析视频文件");
        };
        video.src = URL.createObjectURL(file);
    });
}

```

#### 步骤二：获取上传凭证

* **接口**: `GET /videos/token`
* **认证**: Bearer Token
* **响应**:
```json
{
  "uploadToken": "...", // 七牛上传凭证
  "domain": "http://...", // 访问域名
  "region": "z1",         // 存储区域 (z0, z1, z2, na0, as0)
  "bucket": "videoclub1"  // 存储桶名
}

```

#### 步骤三：调用七牛 SDK 上传

```javascript
// 引入 qiniu-js 后
const key = `video_${Date.now()}_${file.name}`; // 建议重命名防止覆盖
const putExtra = {
    fname: file.name,
    params: {},
    mimeType: file.type || null
};
const config = {
    useCdnDomain: true,
    region: qiniu.region[region] // region 来自步骤二的响应 (如 'z1')
};

// 开始上传
const observable = qiniu.upload(file, key, uploadToken, putExtra, config);

// 监听状态
observable.subscribe({
    next(res) {
        // res.total.percent 为上传进度 (0-100)
        console.log('进度: ' + res.total.percent.toFixed(2) + '%');
    },
    error(err) {
        console.error('上传失败', err);
    },
    complete(res) {
        // 上传成功，res 包含 key 和 hash
        // -> 进入步骤四
        saveToBackend(res, duration);
    }
});

```

#### 步骤四：保存元数据到后端

* **接口**: `POST /videos`
* **Body 参数**:
* `clubId`: (Number) 俱乐部ID
* `title`: (String) 视频标题
* `objectKey`: (String) **关键**，来自七牛上传成功的 `res.key`
* `etag`: (String) **关键**，来自七牛上传成功的 `res.hash`
* `duration`: (Number) 步骤一获取的时长
* `fileSize`: (Number, 可选) `file.size`
* `mimeType`: (String, 可选) `file.type`

---

### 3.2 视频播放与列表

#### 获取视频列表

* **接口**: `GET /videos`
* **参数**: `clubId` (必填), `page`, `pageSize`
* **响应字段说明**:
* `playUrl`: 完整的播放地址（已拼接好域名）。
* `storage.provider`: 存储提供商，目前固定为 `qiniu`。

#### 播放器实现注意事项

1. **混合内容 (Mixed Content) 问题**:
* 目前的七牛测试域名仅支持 **HTTP** (`http://t9mr2u4r9...`)。
* 如果您的前端项目部署在 **HTTPS** 环境下，浏览器会拦截 HTTP 视频请求。
* **解决方案**: 开发阶段请使用 `http://localhost` 调试。生产环境需绑定自定义域名并配置 SSL 证书。


2. **自动播放**:
* 现代浏览器通常禁止带声音的自动播放 (`autoplay`)。如果设置自动播放，建议同时设置静音 (`muted`)。

---

## 4. TypeScript 类型定义

供使用 React/Vue + TS 的项目参考：

```typescript
// 上传凭证响应
interface UploadTokenResponse {
  uploadToken: string;
  domain: string;
  region: string;
  bucket: string;
}

// 视频对象结构
interface VideoItem {
  videoId: number;
  clubId: number;
  title: string;
  playUrl: string;   // 播放地址
  sourceUrl: string; // 源文件地址
  coverUrl: string | null;
  duration: number;
  uploaderName: string;
  createdAt: string;
  storage: {
    provider: 'qiniu';
    bucket: string;
    objectKey: string;
  };
}

```

---

## 5. 常见问题 (FAQ)

**Q1: 上传时提示 `409 Conflict`?**

* **原因**: 后端开启了重复文件检测。如果您尝试上传一个**内容完全相同**的文件（即使文件名不同，但 ETag 哈希相同），后端会拒绝保存。
* **解决**: 请上传不同的视频文件进行测试，或联系后端清理旧数据。

**Q2: 播放时浏览器报 `403 Forbidden`?**

* **原因**: 这里的 403 通常是因为使用了 HTTPS 协议访问了不支持 HTTPS 的七牛测试域名。
* **解决**: 检查 `playUrl` 是否以 `https://` 开头。如果是，请在浏览器地址栏强制改为 `http://` 访问，或者后端修改配置将域名协议改回 `http`。

**Q3: `qiniu is not defined`?**

* **原因**: 未正确引入七牛 SDK。
* **解决**: 确保在 HTML 中引入了 `<script src="...qiniu.min.js"></script>` 或者在项目中 `import * as qiniu from 'qiniu-js'`.