<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理 - 教师视频俱乐部</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div id="page-task" class="page active">
        <div class="header">
            <div class="header-left">
                <button class="btn btn-text" onclick="goBackToHome()" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span class="platform-name">教师视频俱乐部</span>
                <span style="color: #999; font-weight: normal;"> | 教学任务</span>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="avatar" id="task-user-avatar">王</div>
                    <span id="task-user-name">王老师</span>
                </div>
            </div>
        </div>
        
        <div class="task-page-container">
            <h3 style="margin: 20px 0; color: #333;">教学视频任务</h3>
            
            <!-- 任务列表容器 -->
            <div class="task-list-container" id="taskList">
                <!-- 这里会自动显示2个任务 -->
            </div>
        </div>
    </div>

<script>
    // ========== 0. 页面状态 ==========
    let clubTaskList = [];
    let taskPageInitialized = false;
    let currentClubId = null;
    let currentClubName = '';

    // ========== 1. 页面加载后获取任务详情 ==========
    async function initTaskPage() {
        if (taskPageInitialized) return;
        taskPageInitialized = true;

        console.log('任务页面初始化');
        
        // 更新用户显示
        updateUserDisplay();
        
        // 拉取任务列表并显示子任务
        await loadTasksAndDetail();
    }
    
    document.addEventListener('DOMContentLoaded', initTaskPage);

    // ========== 2. 更新用户显示 ==========
    function updateUserDisplay() {
        if (window.Auth && window.Auth.getUser()) {
            const user = window.Auth.getUser();
            const avatarElements = document.querySelectorAll('#task-user-avatar');
            const nameElements = document.querySelectorAll('#task-user-name');
            
            avatarElements.forEach(element => {
                if (element) element.textContent = user.name.charAt(0);
            });
            nameElements.forEach(element => {
                if (element) element.textContent = user.name;
            });
        }
    }

    // ========== 3. 从URL获取任务ID ==========
    function getTaskIdFromURL() {
        // 方法1：从hash参数获取
        const hash = window.location.hash;
        const params = new URLSearchParams(hash.split('?')[1]);
        let taskId = params.get('taskId');
        
        // 方法2：从App状态获取
        if (!taskId && window.App && window.App.state && window.App.state.currentTaskId) {
            taskId = window.App.state.currentTaskId;
        }
        
        // 方法3：从Tasks模块获取
        if (!taskId && window.Tasks && window.Tasks.currentTaskDetail) {
            taskId = window.Tasks.currentTaskDetail.taskInfo.taskId;
        }
        
        console.log('获取到的任务ID:', taskId);
        return taskId ? parseInt(taskId) : null;
    }

    // ========== 3.1 获取俱乐部ID（任务列表查询用） ==========
    function getClubIdFromContext() {
        const hash = window.location.hash;
        const params = new URLSearchParams(hash.split('?')[1]);
        let clubId = params.get('clubId');
        
        if (!clubId && window.App && window.App.state && window.App.state.currentClubId) {
            clubId = window.App.state.currentClubId;
        }
        
        if (!clubId && window.Clubs && window.Clubs.getCurrentClub) {
            const currentClub = window.Clubs.getCurrentClub();
            if (currentClub) {
                clubId = currentClub.id || currentClub.clubId;
                currentClubName = currentClub.name || '';
            }
        }

        if (!clubId && window.Utils) {
            const savedClub = Utils.getFromStorage('current_club');
            if (savedClub) {
                clubId = savedClub.id || savedClub.clubId;
                currentClubName = savedClub.name || '';
            }
        }
        
        if (clubId) {
            currentClubId = parseInt(clubId);
        }
        
        return currentClubId;
    }

    // ========== 4. 先拉取任务列表，再加载任务详情 ==========
    async function loadTasksAndDetail() {
        try {
            const clubId = getClubIdFromContext();
            if (!clubId) {
                showMessage('无法获取俱乐部信息', 'error');
                goBackToHome();
                return;
            }

            if (!window.API || !API.getTasks) {
                throw new Error('任务接口不可用');
            }

            const listResult = await API.getTasks(clubId);
            if (listResult && listResult.code === 0 && Array.isArray(listResult.data)) {
                clubTaskList = listResult.data;
                console.log('已获取任务列表', clubTaskList.length);
            } else {
                clubTaskList = [];
                console.warn('任务列表为空或格式不正确');
            }

            let taskId = getTaskIdFromURL();
            if (!taskId && clubTaskList.length > 0) {
                taskId = clubTaskList[0].taskId || clubTaskList[0].id;
            }

            if (!taskId) {
                showMessage('暂无可用任务', 'warning');
                return;
            }

            await loadTaskDetail(taskId);
        } catch (error) {
            console.error('加载任务列表或详情失败:', error);
            showMessage('加载任务失败: ' + error.message, 'error');
        }
    }

    // ========== 5. 加载任务详情 ==========
    async function loadTaskDetail(taskId) {
        try {
            showMessage('正在加载任务...', 'info');
            
            // 确保Tasks模块已加载
            if (!window.Tasks) {
                throw new Error('任务模块未加载');
            }
            
            // 获取任务详情
            const taskDetail = await Tasks.getTaskDetail(taskId);
            const taskInfo = taskDetail?.taskInfo || taskDetail;
            
            if (!taskInfo) {
                throw new Error('获取任务详情失败');
            }

            if (taskInfo.clubId) {
                currentClubId = taskInfo.clubId;
            }
            if (!currentClubName && window.Clubs && Array.isArray(window.Clubs.myClubs)) {
                const found = window.Clubs.myClubs.find(c => c.id === currentClubId || c.clubId === currentClubId);
                if (found) currentClubName = found.name || '';
            }
            
            // 仅使用接口文档的 subTasks 字段
            const mergedTask = {
                ...taskInfo,
                subTasks: Array.isArray(taskInfo.subTasks) ? taskInfo.subTasks : []
            };
            
            // 显示任务详情
            displayTaskDetail(mergedTask);
            
        } catch (error) {
            console.error('加载任务详情失败:', error);
            showMessage('加载任务失败: ' + error.message, 'error');
            
            // 如果失败，3秒后返回
            setTimeout(() => {
                goBackToHome();
            }, 3000);
        }
    }

    // ========== 6. 显示任务详情和子任务 ==========
    function displayTaskDetail(taskInfo) {
        console.log('显示任务详情:', taskInfo);
        
        // 更新页面标题
        const titleElement = document.querySelector('.task-page-container h3');
        if (titleElement && taskInfo.title) {
            titleElement.textContent = taskInfo.title;
        }
        
        // 显示子任务
        displaySubTasks(taskInfo);
    }

    // ========== 7. 显示子任务 ==========
    function displaySubTasks(taskInfo) {
        const taskListContainer = document.getElementById('taskList');
        
        if (!taskListContainer) {
            console.error('找不到任务列表容器');
            return;
        }

        // 兼容不同字段命名
        const subTasks = Array.isArray(taskInfo.subTasks)
            ? taskInfo.subTasks
            : Array.isArray(taskInfo.subtasks)
                ? taskInfo.subtasks
                : [];

        // 清空容器
        taskListContainer.innerHTML = '';

        if (!subTasks || subTasks.length === 0) {
            taskListContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>暂无子任务</h3>
                    <p>该任务还没有子任务</p>
                </div>
            `;
            return;
        }
        
        // 显示每个子任务
        subTasks.forEach((subTask, index) => {
            // 判断子任务类型
            const isWatchTask = subTask.type === 'watch';
            const statusClass = subTask.status === 'completed' ? 'task-status-complete' : 'task-status-incomplete';
            const statusText = subTask.status === 'completed' ? '已完成 <i class="fas fa-check"></i>' : '未完成';
            const subtaskId = subTask.subtaskId || subTask.id;
            const description = subTask.description || '';
            
            // 根据任务类型设置平台信息
            const platformInfo = isWatchTask 
                ? '<div style="font-size:14px; color:#666; margin-top:8px; display: flex; align-items: center; gap: 6px;"><i class="fas fa-external-link-alt"></i> 请在分秒帧平台观看视频</div>'
                : '<div style="font-size:14px; color:#666; margin-top:8px; display: flex; align-items: center; gap: 6px;"><i class="fas fa-file-alt"></i> 请在石墨文档协同空间完成笔记</div>';
            
            // 创建子任务卡片
            const taskCardHTML = `
                <div class="task-card-item" data-subtask-id="${subtaskId}" data-task-id="${taskInfo.taskId}">
                    <div class="task-card-header">
                        <div class="task-card-title">${subTask.title}</div>
                        <div class="task-card-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="task-card-description">
                        ${description}
                        ${platformInfo}
                        ${subTask.status === 'completed' && subTask.submission ? `
                        <div style="font-size:12px; color:#52c41a; margin-top:4px; padding:8px; background:rgba(82,196,26,0.1); border-radius:4px;">
                            <i class="fas fa-check-circle"></i> 
                            已完成于: ${formatDate(subTask.submission.completedAt)}
                        </div>
                        ` : ''}
                    </div>
                    <div class="task-card-actions">
                        <!-- 前往平台按钮 -->
                        <button class="btn btn-primary" onclick="goToPlatform(${subtaskId})">
                            <i class="${isWatchTask ? 'fas fa-video' : 'fas fa-file-alt'}"></i> 
                            前往${isWatchTask ? '分秒帧平台' : '石墨文档协同空间'}
                        </button>
                        
                        <!-- 标记完成按钮（未完成时才显示） -->
                        ${subTask.status !== 'completed' ? `
                         <button class="btn btn-success" onclick="completeSubTask(${taskInfo.taskId}, ${subtaskId})">
                                 <i class="fas fa-check-circle"></i> 标记完成
</button>
` : `
<button class="btn btn-outline" disabled>
    <i class="fas fa-check-circle"></i> 已完成
</button>
`}
                    </div>
                </div>
            `;
            
            taskListContainer.innerHTML += taskCardHTML;
        });

        // 检查任务是否关联了视频，如果有则添加视频播放按钮
        const currentTask = window.Tasks && window.Tasks.currentTaskDetail;
        if (currentTask && currentTask.taskInfo && currentTask.taskInfo.videoId) {
            const videoId = currentTask.taskInfo.videoId;
            const clubId = currentTask.taskInfo.clubId;
            const taskId = currentTask.taskInfo.taskId;
            
            const videoButtonHTML = `
                <div class="task-card-item video-play-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; margin-top: 20px;">
                    <div class="task-card-header">
                        <div class="task-card-title" style="color: #fff;">
                            <i class="fas fa-play-circle"></i> 关联教学视频
                        </div>
                    </div>
                    <div class="task-card-description" style="color: rgba(255,255,255,0.9);">
                        本任务关联了一个教学视频，点击按钮进入视频播放页面，可以观看视频并参与时间轴评论。
                    </div>
                    <div class="task-card-actions">
                        <button class="btn btn-primary" style="background: #fff; color: #667eea; border: none;" onclick="goToVideoPlayer(${videoId}, ${clubId}, ${taskId})">
                            <i class="fas fa-video"></i> 观看教学视频
                        </button>
                    </div>
                </div>
            `;
            taskListContainer.innerHTML += videoButtonHTML;
        }
        
        console.log('子任务显示完成，共', subTasks.length, '个子任务');
    }

    // 跳转到视频播放页面
    function goToVideoPlayer(videoId, clubId, taskId) {
        // 埋点：跳转到视频播放页面
        if (window.Analytics) {
            window.Analytics.trackButtonClick('go_to_video_player', { 
                module: 'video', 
                target_object: `video-${videoId}`,
                video_id: videoId,
                task_id: taskId,
                club_id: clubId
            });
        }
        
        console.log('跳转到视频播放页面:', { videoId, clubId, taskId });
        
        // 使用App导航到视频播放页面
        if (window.App && window.App.navigateToWithParams) {
            window.App.navigateToWithParams('video-player', { 
                videoId: videoId, 
                clubId: clubId,
                taskId: taskId
            });
        } else {
            // 备用方案：直接修改hash
            window.location.hash = `video-player?videoId=${videoId}&clubId=${clubId}&taskId=${taskId}`;
        }
    }

    // ========== 8. 跳转到平台 ==========
function goToPlatform(subtaskId) {
    // 埋点：前往外部平台
    if (window.Analytics) {
        window.Analytics.trackButtonClick('goto_platform', { module: 'task', target_object: `subtask-${subtaskId}` });
    }

    // 根据子任务ID找到对应的子任务信息
    const taskCards = document.querySelectorAll('.task-card-item');
    let targetTaskCard = null;
    
    // 查找包含当前subtaskId的任务卡片
    for (const card of taskCards) {
        const cardSubtaskId = card.getAttribute('data-subtask-id');
        if (cardSubtaskId && parseInt(cardSubtaskId) === subtaskId) {
            targetTaskCard = card;
            break;
        }
    }
    
    let externalLink = '';
    let platformName = '';
    
    // 检查是否为看视频任务（通过卡片内的图标判断）
    if (targetTaskCard) {
        const watchIcon = targetTaskCard.querySelector('.fa-video');
        if (watchIcon) {
            // 看视频任务 - 分秒帧平台
            externalLink = 'https://app.mediatrack.cn/projects/2009960971614818304/files';
            platformName = '分秒帧平台';
        } else {
            // 研视频任务 - 石墨文档
            externalLink = 'https://shimo.im/space/2wAldmGZonhwbwAP';
            platformName = '石墨文档协同空间';
        }
    } else {
        // 如果没有找到任务卡片，使用原来的逻辑作为fallback
        if (subtaskId === 1) {
            externalLink = 'https://app.mediatrack.cn/projects/2009960971614818304/files';
            platformName = '分秒帧平台';
        } else {
            externalLink = 'https://shimo.im/space/2wAldmGZonhwbwAP';
            platformName = '石墨文档协同空间';
        }
    }
    
    console.log('打开平台链接:', externalLink);
    window.open(externalLink, '_blank');
    
    // 提示用户
    const message = `请在${platformName}完成任务后，返回此页面点击"标记完成"按钮`;
    showMessage(message, 'info');
}

    // ========== 9. 完成子任务 ==========
async function completeSubTask(taskId, subtaskId, isResearchTask = false) {
    console.log('完成子任务:', { taskId, subtaskId, isResearchTask });

    // 埋点：点击完成子任务按钮
    if (window.Analytics) {
        window.Analytics.trackButtonClick('complete_subtask_click', { module: 'task', target_object: `task-${taskId}-subtask-${subtaskId}` });
    }

    // 根据子任务ID找到对应的子任务信息
    const taskCards = document.querySelectorAll('.task-card-item');
    let targetTaskCard = null;
    
    // 查找包含当前subtaskId的任务卡片
    for (const card of taskCards) {
        const cardSubtaskId = card.getAttribute('data-subtask-id');
        if (cardSubtaskId && parseInt(cardSubtaskId) === subtaskId) {
            targetTaskCard = card;
            break;
        }
    }
    
    // 根据任务卡片判断是否为研视频任务
    let actualIsResearchTask = isResearchTask;
    let platformName = '';
    
    if (targetTaskCard) {
        // 检查是否为看视频任务（通过卡片内的图标判断）
        const watchIcon = targetTaskCard.querySelector('.fa-video');
        if (watchIcon) {
            // 看视频任务 - 分秒帧平台
            actualIsResearchTask = false;
            platformName = '分秒帧平台';
        } else {
            // 研视频任务 - 石墨文档
            actualIsResearchTask = true;
            platformName = '石墨文档协同空间';
        }
    } else {
        // 如果没有找到任务卡片，使用传入的参数
        platformName = subtaskId === 1 ? '分秒帧平台' : '石墨文档协同空间';
    }
    
    // 准备确认信息
    let confirmMessage = '';
    
    if (actualIsResearchTask) {
        // 研视频任务
        confirmMessage = `请确认：\n\n✅ 已在 ${platformName} 完成教研笔记\n✅ 笔记内容已提交\n\n确定标记为已完成吗？`;
    } else {
        // 看视频任务
        confirmMessage = `请确认：\n\n✅ 已在 ${platformName} 完整观看视频\n✅ 视频研讨已完成\n\n确定标记为已完成吗？`;
    }
    
    if (!confirm(confirmMessage)) {
        showMessage('请先前往平台完成任务', 'info');
        return;
    }
    
    try {
        showMessage('正在提交任务...', 'info');
        
        // 准备提交数据
        const completionData = {};
        
        // 调用API提交子任务
        const result = await Tasks.completeSubTask(taskId, subtaskId, completionData);
        
        if (result.success) {
            showMessage('任务提交成功！', 'success');
            
            // 重新加载任务详情
            setTimeout(async () => {
                await loadTaskDetail(taskId);
                
                // ========== 新增：通知视频页面更新 ==========
                if (window.parent && window.parent.videoPageInitialized) {
                    // 如果视频页面已初始化，刷新任务列表
                    window.parent.loadVideoTasks && window.parent.loadVideoTasks();
                }
            }, 1000);
        } else {
            showMessage(result.message || '提交任务失败', 'error');
        }
    } catch (error) {
        console.error('完成子任务失败:', error);
        showMessage('提交任务失败: ' + error.message, 'error');
    }
}

    // ========== 10. 格式化日期 ==========
    function formatDate(dateString) {
        if (!dateString) return '刚刚';
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ========== 11. 显示消息 ==========
    function showMessage(message, type = 'info') {
        if (window.Utils && window.Utils.showNotification) {
            window.Utils.showNotification(message, type);
            return;
        }
        
        // 简单的通知实现
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#ff4d4f' : type === 'success' ? '#52c41a' : '#1890ff'};
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // ========== 12. 返回视频页 ==========
    function goBackToHome() {
        // 埋点：返回首页
        if (window.Analytics) {
            window.Analytics.trackButtonClick('go_back_home', { module: 'navigation', target_object: 'home-button' });
        }

        const clubId = currentClubId || getClubIdFromContext();
        const clubName = currentClubName;
        const targetHash = clubId ? `video?clubId=${clubId}${clubName ? `&clubName=${encodeURIComponent(clubName)}` : ''}` : 'home';

        if (window.App && window.App.navigateToWithParams && clubId) {
            window.App.navigateToWithParams('video', { clubId, clubName });
            return;
        }

        if (window.App && window.App.navigateTo && !clubId) {
            window.App.navigateTo('home');
            return;
        }

        window.location.hash = targetHash;
    }

    // ========== 13. 确保函数在全局可用 ==========
    window.goToPlatform = goToPlatform;
    window.completeSubTask = completeSubTask;
    window.goBackToHome = goBackToHome;
    window.initTaskPage = initTaskPage;
    window.goToVideoPlayer = goToVideoPlayer;

    // 立即尝试初始化（兼容 SPA 动态加载）
    initTaskPage();
</script>

</body>
</html>
