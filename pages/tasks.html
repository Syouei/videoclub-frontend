<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理 - 教师视频俱乐部</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div id="page-task" class="page active">
        <div class="header">
            <div class="header-left">
                <button class="btn btn-text" onclick="goBackToHome()" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span class="platform-name">教师视频俱乐部</span>
                <span style="color: #999; font-weight: normal;"> | 教学任务</span>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="avatar" id="task-user-avatar">王</div>
                    <span id="task-user-name">王老师</span>
                </div>
            </div>
        </div>
        
        <div class="task-page-container">
            <h3 style="margin: 20px 0; color: #333;">教学视频任务</h3>
            
            <!-- 任务列表容器 -->
            <div class="task-list-container" id="taskList">
                <!-- 这里会自动显示2个任务 -->
            </div>
        </div>
    </div>

<script>
    // ========== 0. 页面状态 ==========
    let clubTaskList = [];
    let taskPageInitialized = false;
    let currentClubId = null;
    let currentClubName = '';

    // ========== 1. 页面加载后获取任务详情 ==========
    async function initTaskPage() {
        if (taskPageInitialized) return;
        taskPageInitialized = true;

        console.log('任务页面初始化');
        
        // 更新用户显示
        updateUserDisplay();
        
        // 拉取任务列表并显示子任务
        await loadTasksAndDetail();
    }
    
    document.addEventListener('DOMContentLoaded', initTaskPage);

    // ========== 2. 更新用户显示 ==========
    function updateUserDisplay() {
        if (window.Auth && window.Auth.getUser()) {
            const user = window.Auth.getUser();
            const avatarElements = document.querySelectorAll('#task-user-avatar');
            const nameElements = document.querySelectorAll('#task-user-name');
            
            avatarElements.forEach(element => {
                if (element) element.textContent = user.name.charAt(0);
            });
            nameElements.forEach(element => {
                if (element) element.textContent = user.name;
            });
        }
    }

    // ========== 3. 从URL获取任务ID ==========
    function getTaskIdFromURL() {
        // 方法1：从hash参数获取
        const hash = window.location.hash;
        const params = new URLSearchParams(hash.split('?')[1]);
        let taskId = params.get('taskId');
        
        // 方法2：从App状态获取
        if (!taskId && window.App && window.App.state && window.App.state.currentTaskId) {
            taskId = window.App.state.currentTaskId;
        }
        
        // 方法3：从Tasks模块获取
        if (!taskId && window.Tasks && window.Tasks.currentTaskDetail) {
            taskId = window.Tasks.currentTaskDetail.taskInfo.taskId;
        }
        
        console.log('获取到的任务ID:', taskId);
        return taskId ? parseInt(taskId) : null;
    }

    // ========== 3.1 获取俱乐部ID（任务列表查询用） ==========
    function getClubIdFromContext() {
        const hash = window.location.hash;
        const params = new URLSearchParams(hash.split('?')[1]);
        let clubId = params.get('clubId');
        
        if (!clubId && window.App && window.App.state && window.App.state.currentClubId) {
            clubId = window.App.state.currentClubId;
        }
        
        if (!clubId && window.Clubs && window.Clubs.getCurrentClub) {
            const currentClub = window.Clubs.getCurrentClub();
            if (currentClub) {
                clubId = currentClub.id || currentClub.clubId;
                currentClubName = currentClub.name || '';
            }
        }

        if (!clubId && window.Utils) {
            const savedClub = Utils.getFromStorage('current_club');
            if (savedClub) {
                clubId = savedClub.id || savedClub.clubId;
                currentClubName = savedClub.name || '';
            }
        }
        
        if (clubId) {
            currentClubId = parseInt(clubId);
        }
        
        return currentClubId;
    }

    // ========== 4. 先拉取任务列表，再加载任务详情 ==========
    async function loadTasksAndDetail() {
        try {
            const clubId = getClubIdFromContext();
            if (!clubId) {
                showMessage('无法获取俱乐部信息', 'error');
                goBackToHome();
                return;
            }

            if (!window.API || !API.getTasks) {
                throw new Error('任务接口不可用');
            }

            const listResult = await API.getTasks(clubId);
            if (listResult && listResult.code === 0 && Array.isArray(listResult.data)) {
                clubTaskList = listResult.data;
                console.log('已获取任务列表', clubTaskList.length);
            } else {
                clubTaskList = [];
                console.warn('任务列表为空或格式不正确');
            }

            let taskId = getTaskIdFromURL();
            if (!taskId && clubTaskList.length > 0) {
                taskId = clubTaskList[0].taskId || clubTaskList[0].id;
            }

            if (!taskId) {
                showMessage('暂无可用任务', 'warning');
                return;
            }

            await loadTaskDetail(taskId);
        } catch (error) {
            console.error('加载任务列表或详情失败:', error);
            showMessage('加载任务失败: ' + error.message, 'error');
        }
    }

    // ========== 5. 加载任务详情 ==========
    async function loadTaskDetail(taskId) {
        try {
            showMessage('正在加载任务...', 'info');
            
            // 确保Tasks模块已加载
            if (!window.Tasks) {
                throw new Error('任务模块未加载');
            }
            
            // 获取任务详情
            const taskDetail = await Tasks.getTaskDetail(taskId);
            const taskInfo = taskDetail?.taskInfo || taskDetail;
            
            if (!taskInfo) {
                throw new Error('获取任务详情失败');
            }

            if (taskInfo.clubId) {
                currentClubId = taskInfo.clubId;
            }
            if (!currentClubName && window.Clubs && Array.isArray(window.Clubs.myClubs)) {
                const found = window.Clubs.myClubs.find(c => c.id === currentClubId || c.clubId === currentClubId);
                if (found) currentClubName = found.name || '';
            }
            
            // 仅使用接口文档的 subTasks 字段
            const mergedTask = {
                ...taskInfo,
                subTasks: Array.isArray(taskInfo.subTasks) ? taskInfo.subTasks : []
            };
            
            // 显示任务详情
            displayTaskDetail(mergedTask);
            
        } catch (error) {
            console.error('加载任务详情失败:', error);
            showMessage('加载任务失败: ' + error.message, 'error');
            
            // 如果失败，3秒后返回
            setTimeout(() => {
                goBackToHome();
            }, 3000);
        }
    }

    // ========== 6. 显示任务详情和子任务 ==========
    function displayTaskDetail(taskInfo) {
        console.log('显示任务详情:', taskInfo);
        
        // 更新页面标题
        const titleElement = document.querySelector('.task-page-container h3');
        if (titleElement && taskInfo.title) {
            titleElement.textContent = taskInfo.title;
        }
        
        // 显示子任务
        displaySubTasks(taskInfo);
    }

    // ========== 7. 显示子任务 ==========
function displaySubTasks(taskInfo) {
    const taskListContainer = document.getElementById('taskList');
    
    if (!taskListContainer) {
        console.error('找不到任务列表容器');
        return;
    }

    // 兼容不同字段命名
    const subTasks = Array.isArray(taskInfo.subTasks)
        ? taskInfo.subTasks
        : Array.isArray(taskInfo.subtasks)
            ? taskInfo.subtasks
            : [];

    // 按order字段排序，确保阅读教学设计排在第一位
    const sortedSubTasks = [...subTasks].sort((a, b) => {
        const orderA = a.order !== undefined ? a.order : (a.type === 'read_design' ? 0 : 999);
        const orderB = b.order !== undefined ? b.order : (b.type === 'read_design' ? 0 : 999);
        return orderA - orderB;
    });

    // 清空容器
    taskListContainer.innerHTML = '';

    if (!sortedSubTasks || sortedSubTasks.length === 0) {
        taskListContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-tasks"></i>
                <h3>暂无子任务</h3>
                <p>该任务还没有子任务</p>
            </div>
        `;
        return;
    }
    
    // 显示每个子任务
    sortedSubTasks.forEach((subTask, index) => {
        // 判断子任务类型
        const isReadDesignTask = subTask.type === 'read_design';
        const isWatchTask = subTask.type === 'watch';
        const isResearchTask = subTask.type === 'research';
        
        const statusClass = subTask.status === 'completed' ? 'task-status-complete' : 'task-status-incomplete';
        const statusText = subTask.status === 'completed' ? '已完成 <i class="fas fa-check"></i>' : '未完成';
        const subtaskId = subTask.subtaskId || subTask.id;
        
        // 修改这里：直接使用简化的描述，移除具体平台名称
        let description = '';
        if (isReadDesignTask) {
            description = '阅读并理解本课的教学设计方案';
        } else if (isWatchTask) {
            // 移除"前往分秒帧平台观看完整教学视频"，简化为"观看完整教学视频"
            description = '观看完整教学视频';
        } else if (isResearchTask) {
            // 移除"前往石墨文档完成教学反思与研讨笔记"，简化为"完成教学反思与研讨"
            description = '完成教学反思与研讨';
        }
        
        // 根据任务类型设置平台信息
        let platformInfo = '';
        let buttonAction = '';
        
        if (isReadDesignTask) {
            platformInfo = '<div style="font-size:14px; color:#666; margin-top:8px; display: flex; align-items: center; gap: 6px;"><i class="fas fa-file-pdf"></i> 点击查看教学设计文档</div>';
            buttonAction = `onclick="previewTeachingDesign(${taskInfo.taskId})"`;
        } else if (isWatchTask) {
            platformInfo = '<div style="font-size:14px; color:#666; margin-top:8px; display: flex; align-items: center; gap: 6px;"><i class="fas fa-video"></i> 观看教学视频</div>';
            buttonAction = `onclick="goToVideoPlayer(${taskInfo.taskId}, '${taskInfo.title}')"`;
        } else if (isResearchTask) {
            platformInfo = '<div style="font-size:14px; color:#666; margin-top:8px; display: flex; align-items: center; gap: 6px;"><i class="fas fa-file-alt"></i> 完成教学研讨</div>';
            buttonAction = `onclick="goToPlatform(${subtaskId})"`;
        }
        
        // 创建子任务卡片
        const taskCardHTML = `
            <div class="task-card-item" data-subtask-id="${subtaskId}" data-task-id="${taskInfo.taskId}">
                <div class="task-card-header">
                    <div class="task-card-title">${subTask.title}</div>
                    <div class="task-card-status ${statusClass}">${statusText}</div>
                </div>
                <div class="task-card-description">
                    ${description}
                    ${platformInfo}
                    ${subTask.status === 'completed' && subTask.submission ? `
                    <div style="font-size:12px; color:#52c41a; margin-top:4px; padding:8px; background:rgba(82,196,26,0.1); border-radius:4px;">
                        <i class="fas fa-check-circle"></i> 
                        已完成于: ${formatDate(subTask.submission.completedAt)}
                    </div>
                    ` : ''}
                </div>
                <div class="task-card-actions">
                    <!-- 任务操作按钮 -->
                    ${isReadDesignTask ? `
                    <button class="btn btn-primary" ${buttonAction}>
                        <i class="fas fa-eye"></i> 
                        查看教学设计
                    </button>
                    ` : isWatchTask ? `
                    <button class="btn btn-primary" ${buttonAction}>
                        <i class="fas fa-video"></i> 
                        观看视频
                    </button>
                    ` : `
                    <button class="btn btn-primary" ${buttonAction}>
                        <i class="fas fa-file-alt"></i> 
                        前往研讨区
                    </button>
                    `}
                    
                    <!-- 标记完成按钮（未完成时才显示） -->
                    ${subTask.status !== 'completed' ? `
                    <button class="btn btn-success" onclick="completeSubTask(${taskInfo.taskId}, ${subtaskId}, ${isResearchTask})">
                        <i class="fas fa-check-circle"></i> 标记完成
                    </button>
                    ` : `
                    <button class="btn btn-outline" disabled>
                        <i class="fas fa-check-circle"></i> 已完成
                    </button>
                    `}
                </div>
            </div>
        `;
        
        taskListContainer.innerHTML += taskCardHTML;
    });
    
    console.log('子任务显示完成，共', sortedSubTasks.length, '个子任务');
}

    // ========== 8. 跳转到视频播放页面 ==========
    /**
     * 从task页跳转到视频播放页
     * 原则：只传递videoId，所有视频信息由播放页从API获取
     */
    async function goToVideoPlayer(taskId) {
        try {
            // 1. 获取任务详情
            const taskDetail = await Tasks.getTaskDetail(taskId);
            const taskInfo = taskDetail?.taskInfo || taskDetail;

            // 2. 提取videoId（唯一必需参数）
            const videoId = taskInfo.videoId;

            if (!videoId) {
                console.error('[goToVideoPlayer] 任务未关联视频，taskId:', taskId);
                showMessage('该任务未关联视频，无法播放', 'error');
                return;
            }

            // 3. 跳转到视频播放页（只传递必要参数）
            const params = new URLSearchParams({
                videoId: videoId.toString(),
                taskId: taskId.toString()
            });

            const newHash = `video-player?${params}`;
            console.log('[goToVideoPlayer] 跳转:', newHash);
            window.location.hash = newHash;

        } catch (error) {
            console.error('[goToVideoPlayer] 跳转失败:', error);
            showMessage('加载视频失败: ' + error.message, 'error');
        }
    }

    // ========== 8.1 跳转到平台（用于研视频任务） ==========
    function goToPlatform(subtaskId) {
        // 根据子任务ID找到对应的子任务信息
        const taskCards = document.querySelectorAll('.task-card-item');
        let targetTaskCard = null;
        
        // 查找包含当前subtaskId的任务卡片
        for (const card of taskCards) {
            const cardSubtaskId = card.getAttribute('data-subtask-id');
            if (cardSubtaskId && parseInt(cardSubtaskId) === subtaskId) {
                targetTaskCard = card;
                break;
            }
        }
        
        let externalLink = '';
        let platformName = '';
        
        // 检查是否为看视频任务（通过卡片内的图标判断）
        if (targetTaskCard) {
            const watchIcon = targetTaskCard.querySelector('.fa-video');
            if (watchIcon) {
                // 看视频任务 - 跳转到我们的视频播放页面
                const taskId = targetTaskCard.getAttribute('data-task-id');
                const taskTitle = targetTaskCard.querySelector('.task-card-title').textContent;
                goToVideoPlayer(taskId, taskTitle);
                return;
            } else {
                // 研视频任务 - 跳转到话题列表页
                const taskId = targetTaskCard.getAttribute('data-task-id');
                platformName = '话题讨论区';
                showMessage(`正在进入 ${platformName}...`, 'info');
                
                // 跳转到话题列表页
                const hash = `topiclist?taskId=${taskId}&clubId=${currentClubId}`;
                window.location.hash = hash;
                return;
            }
        } else {
            // 如果没有找到任务卡片，使用原来的逻辑作为fallback
            if (subtaskId === 1) {
                // 看视频任务 - 跳转到我们的视频播放页面
                const taskCards = document.querySelectorAll('.task-card-item');
                if (taskCards.length > 0) {
                    const taskId = taskCards[0].getAttribute('data-task-id');
                    const taskTitle = taskCards[0].querySelector('.task-card-title').textContent;
                    goToVideoPlayer(taskId, taskTitle);
                }
                return;
            } else {
                // 研视频任务 - 跳转到话题列表页
                const taskIdFromURL = getTaskIdFromURL();
                platformName = '话题讨论区';
                showMessage(`正在进入 ${platformName}...`, 'info');
                
                const hash = `topic-list?taskId=${taskIdFromURL}&clubId=${currentClubId}`;
                window.location.hash = hash;
                return;
            }
        }
        
        console.log('打开平台链接:', externalLink);
        window.open(externalLink, '_blank');
        
        // 提示用户
        const message = `请在${platformName}完成任务后，返回此页面点击"标记完成"按钮`;
        showMessage(message, 'info');
    }

    // ========== 9. 完成子任务 ==========
async function completeSubTask(taskId, subtaskId, isResearchTask = false) {
    console.log('完成子任务:', { taskId, subtaskId, isResearchTask });
    
    // 根据子任务ID找到对应的子任务信息
    const taskCards = document.querySelectorAll('.task-card-item');
    let targetTaskCard = null;
    
    // 查找包含当前subtaskId的任务卡片
    for (const card of taskCards) {
        const cardSubtaskId = card.getAttribute('data-subtask-id');
        if (cardSubtaskId && parseInt(cardSubtaskId) === subtaskId) {
            targetTaskCard = card;
            break;
        }
    }
    
    // 判断子任务类型
    let taskType = 'unknown';
    let platformName = '';
    let confirmMessage = '';
    
    if (targetTaskCard) {
        // 检查任务类型
        const readDesignIcon = targetTaskCard.querySelector('.fa-eye');
        const watchIcon = targetTaskCard.querySelector('.fa-video');
        const researchIcon = targetTaskCard.querySelector('.fa-file-alt');
        
        if (readDesignIcon) {
            // 阅读教学设计任务
            taskType = 'read_design';
            platformName = '教学设计文档';
            confirmMessage = `请确认：\n\n✅ 已认真阅读教学设计文档\n✅ 理解教学设计的核心要点\n\n确定标记为已完成吗？`;
        } else if (watchIcon) {
            // 看视频任务
            taskType = 'watch';
            platformName = '视频研讨平台';
            confirmMessage = `请确认：\n\n✅ 已在 ${platformName} 完整观看视频\n✅ 视频研讨已完成\n\n确定标记为已完成吗？`;
        } else if (researchIcon) {
            // 研视频任务
            taskType = 'research';
            platformName = '研讨区';
            confirmMessage = `请确认：\n\n✅ 已在 ${platformName} 完成研讨\n✅ 讨论内容已提交\n\n确定标记为已完成吗？`;
        }
    }
    
    // 特殊处理阅读教学设计任务
    if (taskType === 'read_design') {
        return await completeReadDesignTask(taskId, subtaskId);
    }
    
    if (!confirm(confirmMessage)) {
        showMessage('请先完成任务', 'info');
        return;
    }
    
    try {
        showMessage('正在提交任务...', 'info');
        
        // 准备提交数据
        const completionData = {};
        
        // 调用API提交子任务
        const result = await Tasks.completeSubTask(taskId, subtaskId, completionData);
        
        if (result.success) {
            showMessage('任务提交成功！', 'success');
            
            // 重新加载任务详情
            setTimeout(async () => {
                await loadTaskDetail(taskId);
                
                // ========== 新增：通知视频页面更新 ==========
                if (window.parent && window.parent.videoPageInitialized) {
                    // 如果视频页面已初始化，刷新任务列表
                    window.parent.loadVideoTasks && window.parent.loadVideoTasks();
                }
            }, 1000);
        } else {
            showMessage(result.message || '提交任务失败', 'error');
        }
    } catch (error) {
        console.error('完成子任务失败:', error);
        showMessage('提交任务失败: ' + error.message, 'error');
    }
}

    // ========== 10. 格式化日期 ==========
    function formatDate(dateString) {
        if (!dateString) return '刚刚';
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ========== 11. 显示消息 ==========
    function showMessage(message, type = 'info') {
        if (window.Utils && window.Utils.showNotification) {
            window.Utils.showNotification(message, type);
            return;
        }
        
        // 简单的通知实现
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#ff4d4f' : type === 'success' ? '#52c41a' : '#1890ff'};
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // ========== 12. 返回视频页 ==========
    function goBackToHome() {
        const clubId = currentClubId || getClubIdFromContext();
        const clubName = currentClubName;
        const targetHash = clubId ? `video?clubId=${clubId}${clubName ? `&clubName=${encodeURIComponent(clubName)}` : ''}` : 'home';

        if (window.App && window.App.navigateToWithParams && clubId) {
            window.App.navigateToWithParams('video', { clubId, clubName });
            return;
        }

        if (window.App && window.App.navigateTo && !clubId) {
            window.App.navigateTo('home');
            return;
        }

        window.location.hash = targetHash;
    }

    // ========== 13.1 预览教学设计 ==========
async function previewTeachingDesign(taskId) {
    console.log('预览教学设计，任务ID:', taskId);
    
    try {
        // 1. 获取任务详情
        const taskDetail = await Tasks.getTaskDetail(taskId);
        console.log('任务详情:', taskDetail);
        
        if (!taskDetail || !taskDetail.taskInfo) {
            showMessage('获取任务详情失败', 'error');
            return;
        }
        
        // 2. 从任务信息中获取pdfId（后端返回的字段名为pdfId）
        const resourceId = taskDetail.taskInfo.pdfId;
        
        console.log('从任务详情获取到的resourceId:', resourceId);
        
        if (!resourceId) {
            showMessage('该任务暂无教学设计文档', 'info');
            return;
        }
        
        // 3. 获取资源详情
        const config = window.AppConfig;
        const token = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);
        
        showMessage('正在加载教学设计文档...', 'info');
        
        const response = await fetch(`${config.API_BASE_URL}/resources/${resourceId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`获取资源信息失败: HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('资源详情:', result);
        
        if (result.code !== 0) {
            throw new Error(result.msg || '获取资源信息失败');
        }
        
        const pdfUrl = result.data?.downloadUrl || result.data?.sourceUrl;
        console.log('PDF URL:', pdfUrl);
        
        if (!pdfUrl) {
            showMessage('未找到PDF下载地址', 'error');
            return;
        }
        
        // 4. 创建全屏预览模态框（带下载按钮和加载状态）
        const modalHTML = `
            <div id="design-preview-modal" class="fullscreen-modal">
                <div class="fullscreen-modal-content">
                    <div class="fullscreen-modal-header">
                        <h3>教学设计文档预览</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <a href="${pdfUrl}" 
                               target="_blank" 
                               download="教学设计.pdf"
                               class="btn-download-pdf"
                               style="background:rgba(255,255,255,0.1); color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; text-decoration:none; display:flex; align-items:center; gap:6px; font-size:14px; transition:background 0.3s;">
                                <i class="fas fa-download"></i> 下载PDF
                            </a>
                            <button class="btn-close-fullscreen" onclick="closeDesignPreview()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="fullscreen-modal-body">
                        <div id="pdf-loading" style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">
                            <div style="text-align:center;">
                                <i class="fas fa-spinner fa-spin" style="font-size:48px; margin-bottom:16px; color:#1890ff;"></i>
                                <p>正在加载PDF文档...</p>
                                <p style="font-size:12px; color:#999; margin-top:8px;">如果加载较慢，请点击右上角下载按钮</p>
                            </div>
                        </div>
                        <iframe id="design-preview-frame" 
                                style="width:100%; height:100%; border:none; display:none;" 
                                title="教学设计文档预览"
                                src="${pdfUrl}">
                        </iframe>
                    </div>
                </div>
            </div>
        `;
        
        // 5. 添加模态框到页面
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // 6. 显示模态框
        setTimeout(() => {
            document.getElementById('design-preview-modal').classList.add('active');
        }, 10);
        
        // 7. 阻止背景滚动
        document.body.style.overflow = 'hidden';
        
        // 8. 监听iframe加载事件
        const iframe = document.getElementById('design-preview-frame');
        const loading = document.getElementById('pdf-loading');
        
        if (iframe) {
            iframe.onload = function() {
                console.log('PDF iframe加载完成');
                if (loading) {
                    loading.style.display = 'none';
                }
                if (iframe) {
                    iframe.style.display = 'block';
                }
            };
            
            iframe.onerror = function() {
                console.error('PDF iframe加载失败');
                if (loading) {
                    loading.innerHTML = `
                        <div style="text-align:center;">
                            <i class="fas fa-exclamation-triangle" style="font-size:48px; margin-bottom:16px; color:#ff4d4f;"></i>
                            <p style="color:#ff4d4f;">PDF加载失败</p>
                            <p style="font-size:12px; color:#999; margin:8px 0;">请点击右上角下载按钮直接查看</p>
                            <a href="${pdfUrl}" 
                               target="_blank" 
                               class="btn btn-primary"
                               style="margin-top:16px;">
                                <i class="fas fa-download"></i> 下载PDF文档
                            </a>
                        </div>
                    `;
                }
            };
            
            // 设置超时：如果10秒还没加载完成，显示下载提示
            setTimeout(() => {
                if (loading && loading.style.display !== 'none') {
                    console.log('PDF加载超时，显示下载提示');
                    loading.innerHTML = `
                        <div style="text-align:center;">
                            <i class="fas fa-file-pdf" style="font-size:48px; margin-bottom:16px; color:#722ed1;"></i>
                            <p>PDF加载较慢</p>
                            <p style="font-size:12px; color:#999; margin:8px 0;">请点击右上角下载按钮直接查看</p>
                            <a href="${pdfUrl}" 
                               target="_blank" 
                               class="btn btn-primary"
                               style="margin-top:16px;">
                                <i class="fas fa-download"></i> 下载PDF文档
                            </a>
                        </div>
                    `;
                }
            }, 10000);
        }
        
    } catch (error) {
        console.error('预览教学设计失败:', error);
        showMessage('预览教学设计失败: ' + error.message, 'error');
    }
}

// ========== 13.2 关闭教学设计预览 ==========
function closeDesignPreview() {
    const modal = document.getElementById('design-preview-modal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
    
    // 恢复背景滚动
    document.body.style.overflow = 'auto';
}

// ========== 13.3 完成阅读教学设计子任务 ==========
async function completeReadDesignTask(taskId, subtaskId) {
    const confirmMessage = `请确认：\n\n✅ 已认真阅读教学设计文档\n✅ 理解教学设计的核心要点\n\n确定标记为已完成吗？`;
    
    if (!confirm(confirmMessage)) {
        showMessage('请先阅读教学设计文档', 'info');
        return;
    }
    
    try {
        showMessage('正在提交任务...', 'info');
        
        // 准备提交数据
        const completionData = {
            researchNotes: '已阅读教学设计文档'
        };
        
        // 调用API提交子任务
        const result = await Tasks.completeSubTask(taskId, subtaskId, completionData);
        
        if (result.success) {
            showMessage('教学设计阅读任务提交成功！', 'success');
            
            // 重新加载任务详情
            setTimeout(async () => {
                await loadTaskDetail(taskId);
            }, 1000);
        } else {
            showMessage(result.message || '提交任务失败', 'error');
        }
    } catch (error) {
        console.error('完成教学设计阅读任务失败:', error);
        showMessage('提交任务失败: ' + error.message, 'error');
    }
}

    // ========== 14. 确保函数在全局可用 ==========
    window.goToPlatform = goToPlatform;
    window.goToVideoPlayer = goToVideoPlayer;
    window.completeSubTask = completeSubTask;
    window.goBackToHome = goBackToHome;
    window.initTaskPage = initTaskPage;
    window.previewTeachingDesign = previewTeachingDesign; // 新增
    window.closeDesignPreview = closeDesignPreview; // 新增
    window.completeReadDesignTask = completeReadDesignTask; // 新增

    // 立即尝试初始化（兼容 SPA 动态加载）
    initTaskPage();
</script>

</body>
</html>