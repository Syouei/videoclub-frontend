<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务管理 - 教师视频俱乐部</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qiniu-js/3.4.1/qiniu.min.js"></script>
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.17.1.min.js"></script>
    <script src="js/lib/aliyun-upload-sdk-1.5.7.min.js"></script>

    <style>
        /* 新增：模态框与上传样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .form-control:focus {
            border-color: #1890ff;
            outline: none;
        }

        /* 上传框样式 */
        .file-upload-box {
            border: 2px dashed #d9d9d9;
            padding: 24px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .file-upload-box:hover {
            border-color: #1890ff;
            background: #f0f9ff;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .upload-text {
            color: #666;
            font-size: 13px;
            margin: 0;
        }

        /* 进度条 */
        .progress-wrapper {
            margin-top: 12px;
            display: none;
        }

        .progress-bg {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #1890ff;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }

        /* 浮动添加按钮 */
        .btn-add-float {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 56px;
            height: 56px;
            background: #1890ff;
            color: white;
            border-radius: 50%;
            display: none;
            /* 默认隐藏 */
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
            cursor: pointer;
            z-index: 9999;
            transition: transform 0.2s;
        }

        .btn-add-float:hover {
            transform: scale(1.1);
            background: #40a9ff;
        }

        /* 全屏预览模态框样式 */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .fullscreen-modal.active {
            display: flex;
            animation: fadeIn 0.3s;
        }

        .fullscreen-modal-content {
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .fullscreen-modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            color: white;
        }

        .fullscreen-modal-body {
            flex: 1;
            background: #f5f5f5;
            position: relative;
        }

        .btn-close-fullscreen {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
        }

        .btn-close-fullscreen:hover {
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>


    <div id="page-task" class="page active">
        <div class="header">
            <div class="header-left">
                <button class="btn btn-text" onclick="goBackToHome()" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span class="platform-name">教师视频俱乐部</span>
                <span style="color: #999; font-weight: normal;"> | 教学任务</span>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="avatar" id="task-user-avatar">U</div>
                    <span id="task-user-name">用户</span>
                </div>
            </div>
        </div>

        <div class="task-page-container">
            <h3 style="margin: 20px 0; color: #333;">教学视频任务</h3>

            <div class="task-list-container" id="taskList">
            </div>
        </div>

        <div id="btn-add-subtask" class="btn-add-float" onclick="openSubtaskModal()" title="添加子任务">
            <i class="fas fa-plus"></i>
        </div>

        <div id="subtask-modal" class="modal-overlay">
            <div class="modal">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3 style="margin:0;">添加子任务</h3>
                    <i class="fas fa-times" style="cursor:pointer; color:#999;" onclick="closeSubtaskModal()"></i>
                </div>

                <div class="form-group">
                    <label class="form-label">任务类型</label>
                    <select id="st-type" class="form-control" onchange="handleTypeChange()">
                        <option value="watch">看视频任务</option>
                        <option value="read_design">阅读教学设计</option>
                        <option value="research">研视频（话题讨论）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">子任务标题 <span style="color:red">*</span></label>
                    <input type="text" id="st-title" class="form-control" placeholder="请输入子任务标题">
                </div>

                <div class="form-group">
                    <label class="form-label">任务描述</label>
                    <textarea id="st-desc" class="form-control" rows="3" placeholder="请输入任务说明..."></textarea>
                </div>

                <div id="section-watch" class="type-section">
                    <label class="form-label">上传教学视频 <span style="color:red">*</span></label>
                    <div class="file-upload-box" onclick="document.getElementById('st-video-file').click()">
                        <i class="fas fa-video upload-icon" style="color: #1890ff;"></i>
                        <p id="st-video-name" class="upload-text">点击选择视频文件 (MP4/MOV)</p>
                        <input type="file" id="st-video-file" accept="video/*" style="display:none"
                            onchange="handleFileSelect('video')">
                    </div>
                    <div id="video-progress" class="progress-wrapper">
                        <div class="progress-bg">
                            <div id="video-progress-bar" class="progress-bar"></div>
                        </div>
                        <div id="video-progress-text" class="progress-text">上传进度: 0%</div>
                    </div>
                </div>

                <div id="section-read" class="type-section" style="display:none;">
                    <label class="form-label">上传PDF文档 <span style="color:red">*</span></label>
                    <div class="file-upload-box" onclick="document.getElementById('st-pdf-file').click()">
                        <i class="fas fa-file-pdf upload-icon" style="color: #722ed1;"></i>
                        <p id="st-pdf-name" class="upload-text">点击选择PDF文件</p>
                        <input type="file" id="st-pdf-file" accept=".pdf" style="display:none"
                            onchange="handleFileSelect('pdf')">
                    </div>
                    <div id="pdf-progress" class="progress-wrapper">
                        <div class="progress-bg">
                            <div id="pdf-progress-bar" class="progress-bar" style="background:#722ed1;"></div>
                        </div>
                        <div id="pdf-progress-text" class="progress-text">上传进度: 0%</div>
                    </div>
                </div>

                <div id="section-research" class="type-section" style="display:none;">
                    <div class="form-group">
                        <label class="form-label">话题引导语（脚手架）</label>
                        <textarea id="st-scaffold" class="form-control" rows="3"
                            placeholder="例如：请结合视频中的...谈谈你的看法"></textarea>
                        <p style="font-size:12px; color:#999; margin-top:4px;">* 系统将自动创建一个以此为内容的话题，供学员讨论。</p>
                    </div>
                </div>

                <div style="margin-top: 24px; text-align: right;">
                    <button class="btn btn-outline" onclick="closeSubtaskModal()">取消</button>
                    <button class="btn btn-primary" onclick="submitCreateSubtask()">创建子任务</button>
                </div>
            </div>
        </div>

    </div>



    <script>
        // ========== 0. 全局变量与状态 ==========
        let clubTaskList = [];
        let taskPageInitialized = false;
        let currentClubId = null;
        let currentClubName = '';
        let currentPreviewPdfId = null;
        let currentPreviewTaskId = null;
        let isManager = false;

        // 文件上传相关
        let selectedVideoFile = null;
        let selectedPdfFile = null;

        // ========== 1. 阿里云上传 SDK 封装 ==========
        window.AliyunVodUploader = {
            ensureLoaded: function () {
                return new Promise((resolve, reject) => {
                    if (window.AliyunUpload && window.AliyunUpload.Vod) return resolve();
                    if (window.AliyunUpload) resolve();
                    else setTimeout(() => window.AliyunUpload ? resolve() : reject(new Error('Aliyun Upload SDK 未加载')), 1000);
                });
            },
            uploadVideo: function (file, token, onProgress) {
                return new Promise((resolve, reject) => {
                    if (!window.AliyunUpload || !window.AliyunUpload.Vod) return reject(new Error('SDK 未加载'));
                    try {
                        var uploader = new window.AliyunUpload.Vod({
                            userId: "123", partSize: 1048576, parallel: 5, retryCount: 3, retryDuration: 2,
                            onUploadstarted: function (uploadInfo) {
                                uploader.setUploadAuthAndAddress(uploadInfo, token.uploadAuth, token.uploadAddress, uploadInfo.videoId || token.videoId);
                            },
                            onUploadSucceed: function (uploadInfo) { resolve({ videoId: uploadInfo.videoId || token.videoId }); },
                            onUploadFailed: function (uploadInfo, code, message) { reject(new Error(`上传失败: ${message}`)); },
                            onUploadProgress: function (uploadInfo, totalSize, progress) { if (onProgress) onProgress(Math.ceil(progress * 100)); },
                            onUploadTokenExpired: function () { reject(new Error('凭证过期')); }
                        });
                        uploader.addFile(file, null, null, null, '{"Vod":{}}');
                        uploader.startUpload();
                    } catch (error) { reject(error); }
                });
            }
        };

        // ========== 2. 页面初始化 (核心修复) ==========
        async function initTaskPage() {
            if (taskPageInitialized) return;
            taskPageInitialized = true;
            console.log('任务页面初始化启动...');

            updateUserDisplay();

            // 【修复】优先加载数据，不再因缺少 ClubID 而中断
            await loadPageData();
        }

        // 监听 DOM 加载
        document.addEventListener('DOMContentLoaded', initTaskPage);
        // 兼容 SPA 切换
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            initTaskPage();
        }

        function updateUserDisplay() {
            if (window.Auth && window.Auth.getUser()) {
                const user = window.Auth.getUser();
                document.querySelectorAll('#task-user-avatar').forEach(el => el.textContent = user.name.charAt(0));
                document.querySelectorAll('#task-user-name').forEach(el => el.textContent = user.name);
            }
        }

        // 获取 TaskID (增强版)
        function getTaskIdFromURL() {
            const params = new URLSearchParams(window.location.hash.split('?')[1]);
            let taskId = params.get('taskId');

            // 尝试从全局状态获取
            if (!taskId && window.App?.state?.currentTaskId) taskId = window.App.state.currentTaskId;
            if (!taskId && window.Tasks?.currentTaskDetail) taskId = window.Tasks.currentTaskDetail.taskInfo.taskId;

            return taskId ? parseInt(taskId) : null;
        }

        // ========== 3. 数据加载逻辑 (逻辑重构) ==========
        async function loadPageData() {
            try {
                // 1. 先尝试获取 TaskID
                const taskId = getTaskIdFromURL();

                if (taskId) {
                    // 有 TaskID，直接加载详情
                    console.log('检测到 TaskID:', taskId, '开始加载详情...');
                    await loadTaskDetail(taskId);

                    // 详情加载完后，补充加载 Club 信息用于权限判断
                    if (currentClubId) {
                        checkManagerPermission(currentClubId);
                        // 可选：顺便加载该俱乐部的其他任务列表（左侧导航用）
                        // loadClubTaskList(currentClubId); 
                    }
                } else {
                    // 没有 TaskID，尝试从 ClubID 加载列表
                    console.log('未检测到 TaskID，尝试加载列表...');
                    await loadClubTaskListAndSelectFirst();
                }
            } catch (error) {
                console.error('页面数据加载失败:', error);
                showMessage('加载失败: ' + error.message, 'error');
            }
        }

        // 加载详情并渲染
        async function loadTaskDetail(taskId) {
            try {
                // document.getElementById('taskList').innerHTML = '<div class="loading">加载中...</div>'; // 可选加载动画

                const taskDetail = await Tasks.getTaskDetail(taskId);
                const taskInfo = taskDetail?.taskInfo || taskDetail;

                if (!taskInfo) throw new Error('未获取到任务数据');

                // 反向设置 ClubID
                if (taskInfo.clubId) currentClubId = taskInfo.clubId;

                console.log('任务详情获取成功，准备渲染:', taskInfo);

                // 渲染 UI
                displayTaskDetail(taskInfo);

            } catch (error) {
                console.error('加载详情异常:', error);
                throw error;
            }
        }

        // (备用) 如果没有 TaskID，尝试加载列表取第一个
        async function loadClubTaskListAndSelectFirst() {
            // 尝试获取 ClubID
            let clubId = null;
            const params = new URLSearchParams(window.location.hash.split('?')[1]);
            clubId = params.get('clubId') || window.App?.state?.currentClubId || Utils.getFromStorage('current_club')?.id;

            if (!clubId) {
                document.getElementById('taskList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>无法加载任务</h3>
                    <p>缺少任务信息</p>
                    <button class="btn btn-primary" onclick="goBackToHome()">返回</button>
                </div>`;
                return;
            }

            currentClubId = parseInt(clubId);
            checkManagerPermission(currentClubId);

            const res = await API.getTasks(currentClubId);
            if (res && res.code === 0 && res.data && res.data.length > 0) {
                // 加载第一个任务
                await loadTaskDetail(res.data[0].taskId || res.data[0].id);
            } else {
                document.getElementById('taskList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>暂无任务</h3>
                    <p>该俱乐部暂无已发布任务</p>
                </div>`;
            }
        }

        async function checkManagerPermission(clubId) {
            if (!clubId) return;

            console.log(`[权限检查] 开始检查俱乐部 ID: ${clubId}`);

            try {
                // 1. 获取我的俱乐部列表
                const myClubsRes = await API.getMyClubs();

                if (myClubsRes.code === 0) {
                    // 打印列表以供调试
                    console.log('[权限检查] 我的俱乐部列表:', myClubsRes.data);

                    // 2. 查找匹配 (使用 == 进行弱类型比较，防止 '1' != 1)
                    const club = myClubsRes.data.find(c => c.clubId == clubId);

                    if (club) {
                        console.log(`[权限检查] 找到俱乐部: ${club.clubName}, 角色: ${club.memberRole}`);
                        // 检查角色
                        isManager = (club.memberRole === 'manager' || club.memberRole === 'creator');
                    } else {
                        console.warn(`[权限检查] 未在列表中找到 ID 为 ${clubId} 的俱乐部`);
                        isManager = false;
                    }
                }

                console.log(`[权限检查] 最终结果 isManager: ${isManager}`);

                // 3. 控制按钮显示
                const btnAdd = document.getElementById('btn-add-subtask');
                if (btnAdd) {
                    // 如果是管理员，显示 flex；否则隐藏
                    btnAdd.style.display = isManager ? 'flex' : 'none';
                    console.log(`[权限检查] 按钮样式已设置为: ${btnAdd.style.display}`);
                } else {
                    console.error('[权限检查] 错误: 未找到 ID 为 btn-add-subtask 的按钮元素');
                }

            } catch (e) {
                console.error('[权限检查] 发生异常:', e);
            }
        }

        // ========== 4. 渲染逻辑 (关键点) ==========
        function displayTaskDetail(taskInfo) {
            // 1. 更新大标题
            const titleElement = document.querySelector('.task-page-container h3');
            if (titleElement) titleElement.textContent = taskInfo.title || '未命名任务';

            // 2. 渲染子任务列表
            displaySubTasks(taskInfo);
        }

        function displaySubTasks(taskInfo) {
            const container = document.getElementById('taskList');
            if (!container) return console.error('找不到 #taskList 容器');

            // 数据兼容处理
            const subTasks = taskInfo.subTasks || taskInfo.subtasks || [];
            console.log('渲染子任务数据:', subTasks);

            if (subTasks.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>暂无子任务</h3>
                    <p>尚未添加任何学习内容</p>
                </div>`;
                return;
            }

            // 排序：阅读 -> 视频 -> 研讨 -> 其他
            const sorted = [...subTasks].sort((a, b) => {
                const getOrder = (t) => t.type === 'read_design' ? 0 : (t.type === 'watch' ? 1 : 2);
                return getOrder(a) - getOrder(b);
            });

            let html = '';
            sorted.forEach(sub => {
                const isRead = sub.type === 'read_design';
                const isWatch = sub.type === 'watch';
                const isResearch = sub.type === 'research';
                const isCompleted = sub.status === 'completed';
                const subId = sub.subtaskId || sub.id;

                // 按钮点击事件
                let actionBtn = '';
                if (isRead) {
                    actionBtn = `<button class="btn btn-primary" onclick="previewTeachingDesign(${taskInfo.taskId})"><i class="fas fa-eye"></i> 查看文档</button>`;
                } else if (isWatch) {
                    actionBtn = `<button class="btn btn-primary" onclick="goToVideoPlayer(${taskInfo.taskId})"><i class="fas fa-video"></i> 观看视频</button>`;
                } else {
                    actionBtn = `<button class="btn btn-primary" onclick="goToPlatform(${subId})"><i class="fas fa-comments"></i> 进入研讨</button>`;
                }

                // 完成按钮状态
                let completeBtn = isCompleted
                    ? `<button class="btn btn-outline" disabled><i class="fas fa-check"></i> 已完成</button>`
                    : `<button class="btn btn-success" onclick="completeSubTask(${taskInfo.taskId}, ${subId}, ${isResearch})">标记完成</button>`;

                html += `
                <div class="task-card-item">
                    <div class="task-card-header">
                        <div class="task-card-title">${sub.title}</div>
                        <div class="task-card-status ${isCompleted ? 'task-status-complete' : 'task-status-incomplete'}">
                            ${isCompleted ? '已完成' : '进行中'}
                        </div>
                    </div>
                    <div class="task-card-description">
                        ${sub.description || '暂无描述'}
                        ${isRead ? '<br><small style="color:#666"><i class="fas fa-file-pdf"></i> PDF文档</small>' : ''}
                        ${isWatch ? '<br><small style="color:#666"><i class="fas fa-play-circle"></i> 教学视频</small>' : ''}
                    </div>
                    <div class="task-card-actions">
                        ${actionBtn}
                        ${completeBtn}
                    </div>
                </div>
            `;
            });

            container.innerHTML = html;
        }

        // ========== 5. 交互与工具函数 ==========

        // 打开/关闭模态框
        window.openSubtaskModal = function () {
            document.getElementById('subtask-modal').style.display = 'flex';
            resetForm();
        };
        window.closeSubtaskModal = function () {
            document.getElementById('subtask-modal').style.display = 'none';
        };

        function resetForm() {
            document.getElementById('st-title').value = '';
            document.getElementById('st-desc').value = '';
            document.getElementById('st-scaffold').value = '';
            document.getElementById('st-type').value = 'watch';
            handleTypeChange();
            resetFileUploads();
        }

        window.handleTypeChange = function () {
            const type = document.getElementById('st-type').value;
            ['watch', 'read', 'research'].forEach(t => {
                const el = document.getElementById(`section-${t}`);
                if (el) el.style.display = (t === type || (type === 'read_design' && t === 'read')) ? 'block' : 'none';
            });

            const titleInput = document.getElementById('st-title');
            if (!titleInput.value) {
                const titles = { 'watch': '观看教学视频', 'read_design': '阅读教学设计', 'research': '教学反思与研讨' };
                if (titles[type]) titleInput.value = titles[type];
            }
        };

        function resetFileUploads() {
            selectedVideoFile = null; selectedPdfFile = null;
            document.getElementById('st-video-name').textContent = '点击选择视频 (MP4)';
            document.getElementById('st-pdf-name').textContent = '点击选择PDF';
            document.getElementById('st-video-file').value = '';
            document.getElementById('st-pdf-file').value = '';
            document.getElementById('video-progress').style.display = 'none';
            document.getElementById('pdf-progress').style.display = 'none';
        }

        window.handleFileSelect = function (type) {
            const file = document.getElementById(type === 'video' ? 'st-video-file' : 'st-pdf-file').files[0];
            if (!file) return;
            if (type === 'video') { selectedVideoFile = file; document.getElementById('st-video-name').textContent = file.name; }
            else { selectedPdfFile = file; document.getElementById('st-pdf-name').textContent = file.name; }
        };

        // 提交创建
        window.submitCreateSubtask = async function () {
            const taskId = getTaskIdFromURL();
            if (!taskId) return showMessage('任务ID丢失', 'error');

            const type = document.getElementById('st-type').value;
            const title = document.getElementById('st-title').value.trim();
            const desc = document.getElementById('st-desc').value.trim();

            if (!title) return showMessage('请输入标题', 'warning');

            try {
                showMessage('正在处理...', 'info');
                let payload = { type, title, description: desc, videoId: null, pdfId: null };

                if (type === 'watch') {
                    if (!selectedVideoFile) return showMessage('请选择视频', 'warning');
                    payload.videoId = await performVideoUpload(selectedVideoFile);
                } else if (type === 'read_design') {
                    if (!selectedPdfFile) return showMessage('请选择PDF', 'warning');
                    payload.pdfId = await performPdfUpload(selectedPdfFile);
                } else if (type === 'research') {
                    const scaffold = document.getElementById('st-scaffold').value.trim();
                    payload.videoId = await performCreateTopic(taskId, title, desc, scaffold);
                }

                await API.request(`/tasks/${taskId}/subtasks`, 'POST', payload);
                showMessage('创建成功', 'success');
                closeSubtaskModal();
                loadTaskDetail(taskId);
            } catch (e) {
                console.error(e);
                showMessage(e.message, 'error');
            }
        };

        // 辅助上传函数
        async function performVideoUpload(file) {
            document.getElementById('video-progress').style.display = 'block';
            const tokenRes = await API.getUploadToken();
            if (tokenRes.code !== 0) throw new Error(tokenRes.msg);

            await window.AliyunVodUploader.ensureLoaded();
            const res = await window.AliyunVodUploader.uploadVideo(file, tokenRes.data, (pct) => {
                document.getElementById('video-progress-bar').style.width = pct + '%';
                document.getElementById('video-progress-text').textContent = pct + '%';
            });

            // 保存信息
            const saveRes = await API.saveVideoInfo({
                clubId: currentClubId, title: file.name, videoId: res.videoId,
                etag: "etag_" + Date.now(), fileSize: file.size, mimeType: file.type
            });
            if (saveRes.code === 0) return saveRes.data.videoId;
            throw new Error(saveRes.msg);
        }

        async function performPdfUpload(file) {
            document.getElementById('pdf-progress').style.display = 'block';
            const tokenRes = await API.request('/resources/token', 'GET');
            const { uploadToken, bucket, region } = tokenRes.data;

            const key = `resource/${Date.now()}/${file.name}`;
            const observable = qiniu.upload(file, key, uploadToken, { fname: file.name, mimeType: file.type }, { useCdnDomain: true, region: qiniu.region.z1 });

            return new Promise((resolve, reject) => {
                observable.subscribe({
                    next(res) {
                        const pct = Math.floor(res.total.percent);
                        document.getElementById('pdf-progress-bar').style.width = pct + '%';
                    },
                    error(err) { reject(err); },
                    async complete(res) {
                        const saveRes = await API.request('/resources', 'POST', {
                            clubId: currentClubId, title: file.name, filename: file.name,
                            objectKey: key, etag: res.hash, bucket, mimeType: file.type, fileSize: file.size
                        });
                        if (saveRes.code === 0) resolve(saveRes.data.resourceId);
                        else reject(new Error(saveRes.msg));
                    }
                });
            });
        }

        async function performCreateTopic(taskId, title, desc, scaffold) {
            const res = await API.createTopic({ taskId, title, content: desc || title, scaffold });
            if (res.code === 0) return res.data.topicId;
            throw new Error(res.msg);
        }

        // 跳转与操作
        window.goToVideoPlayer = async function (taskId) {
            const detail = await Tasks.getTaskDetail(taskId);
            // 优先找 watch 类型的子任务的 videoId
            const watchTask = detail.taskInfo.subTasks.find(t => t.type === 'watch');
            const videoId = watchTask ? watchTask.videoId : detail.taskInfo.videoId;

            if (videoId) window.location.hash = `video-player?videoId=${videoId}&taskId=${taskId}`;
            else showMessage('未找到视频', 'error');
        };

        window.goToPlatform = function (subId) {
            const taskId = getTaskIdFromURL();
            // 研讨通常跳话题列表
            window.location.hash = `topiclist?taskId=${taskId}&clubId=${currentClubId}`;
        };

        window.previewTeachingDesign = async function (taskId) {
            const detail = await Tasks.getTaskDetail(taskId);
            const pdfId = detail.taskInfo.subTasks.find(t => t.type === 'read_design')?.pdfId;
            if (!pdfId) return showMessage('未找到文档', 'error');

            const token = Utils.getFromStorage(window.AppConfig.STORAGE_KEYS.USER_TOKEN);
            fetch(`${window.AppConfig.API_BASE_URL}/resources/${pdfId}`, { headers: { 'Authorization': `Bearer ${token}` } })
                .then(r => r.json()).then(res => {
                    if (res.code === 0) window.open(res.data.downloadUrl, '_blank');
                    else showMessage(res.msg, 'error');
                });
        };

        window.completeSubTask = async function (taskId, subId) {
            if (!confirm('确认标记完成？')) return;
            try {
                await API.completeSubTask(taskId, subId, {});
                showMessage('已完成', 'success');
                loadTaskDetail(taskId);
            } catch (e) { showMessage(e.message, 'error'); }
        };

        window.goBackToHome = function () {
            if (currentClubId) window.location.hash = `video?clubId=${currentClubId}`;
            else window.location.hash = 'home';
        };

        function showMessage(msg, type) {
            if (window.Utils?.showNotification) Utils.showNotification(msg, type);
            else alert(msg);
        }
    </script>
</body>

</html>