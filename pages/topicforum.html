<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯é¢˜è®¨è®º - æ•™å¸ˆè§†é¢‘ä¿±ä¹éƒ¨</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ä¿æŒä¸tasks.htmlå®Œå…¨ä¸€è‡´çš„åŸºç¡€æ ·å¼ */
        body {
            background: #f5f7fa;
            min-height: 100vh;
        }

        .page {
            background: #f5f7fa;
        }

        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .forum-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .discussion-topic {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .topic-label {
            background: #1890ff;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
            margin-bottom: 12px;
        }

        .topic-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .topic-desc {
            color: #666;
            line-height: 1.6;
        }

        .compose-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .compose-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .compose-title {
            font-size: 1.1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .compose-title .icon {
            font-size: 1.3rem;
        }

        .scaffold-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .scaffold-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            color: #555;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .scaffold-btn:hover {
            border-color: #1890ff;
            color: #1890ff;
            transform: translateY(-2px);
        }

        .scaffold-btn.active {
            background: #1890ff;
            color: white;
            border-color: transparent;
        }

        .textarea-wrapper {
            position: relative;
        }

        .compose-textarea {
            width: 100%;
            min-height: 200px;
            padding: 16px;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            font-size: 1rem;
            line-height: 1.8;
            resize: vertical;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .compose-textarea:focus {
            outline: none;
            border-color: #1890ff;
        }

        .compose-textarea::placeholder {
            color: #aaa;
        }

        .scaffold-hint {
            background: #f0f8ff;
            border-left: 4px solid #1890ff;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .scaffold-hint strong {
            color: #1890ff;
        }

        .compose-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }

        .char-count {
            color: #888;
            font-size: 0.9rem;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
        }

        .btn-primary:hover {
            background: #40a9ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(24, 144, 255, 0.4);
        }

        .comments-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .comments-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }

        .comments-title {
            font-size: 1.1rem;
            color: #333;
        }

        .comments-count {
            background: #f0f0f0;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .comment-card {
            padding: 20px;
            border-radius: 12px;
            background: #f8f9fa;
            margin-bottom: 16px;
            transition: transform 0.3s ease;
        }

        .comment-card:hover {
            transform: translateX(5px);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: #1890ff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }

        .comment-meta {
            flex: 1;
        }

        .comment-author {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .comment-time {
            font-size: 0.85rem;
            color: #999;
        }

        .scaffold-tag {
            background: #1890ff;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .comment-content {
            color: #444;
            line-height: 1.8;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }

        .scaffold-text {
            color: #1890ff;
            font-weight: 600;
        }

        .comment-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            padding: 6px 14px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 16px;
            font-size: 0.85rem;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            border-color: #1890ff;
            color: #1890ff;
            transform: translateY(-2px);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1890ff;
            color: white;
            padding: 16px 32px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(24, 144, 255, 0.3);
            font-size: 1rem;
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .empty-comments {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-comments i {
            font-size: 48px;
            margin-bottom: 12px;
            color: #ddd;
        }
    </style>
</head>
<body>
    <div id="page-topic-forum" class="page active">
        <div class="header">
            <div class="header-left">
                <button class="btn btn-text" onclick="goBackToTopicList()" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span class="platform-name">æ•™å¸ˆè§†é¢‘ä¿±ä¹éƒ¨</span>
                <span style="color: #999; font-weight: normal;"> | è¯é¢˜è®¨è®º</span>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="avatar" id="forum-user-avatar">ç‹</div>
                    <span id="forum-user-name">ç‹è€å¸ˆ</span>
                </div>
            </div>
        </div>

        <div class="forum-container">
            <!-- è¯é¢˜ä¿¡æ¯ -->
            <div class="discussion-topic">
                <span class="topic-label">ğŸ“Œ è®¨è®ºè¯é¢˜</span>
                <h2 class="topic-title" id="topicTitle">è¯é¢˜æ ‡é¢˜</h2>
                <p class="topic-desc" id="topicDescription">è¯é¢˜æè¿°</p>
            </div>

            <!-- å‘è¡¨è¯„è®ºåŒº -->
            <div class="compose-section">
                <div class="compose-header">
                    <h3 class="compose-title">
                        <span class="icon">âœï¸</span>
                        å‘è¡¨ä½ çš„è§‚ç‚¹
                    </h3>
                </div>

                <!-- æ”¯æ¶é€‰æ‹©å™¨ -->
                <div class="scaffold-selector">
                    <button class="scaffold-btn" data-scaffold="argument">ğŸ’¡ è®ºè¯è§‚ç‚¹</button>
                    <button class="scaffold-btn" data-scaffold="question">â“ æå‡ºè´¨ç–‘</button>
                    <button class="scaffold-btn" data-scaffold="connect">ğŸ”— å»ºç«‹è”ç³»</button>
                    <button class="scaffold-btn" data-scaffold="reflect">ğŸª æ·±åº¦åæ€</button>
                    <button class="scaffold-btn" data-scaffold="build">ğŸ§± å»¶ä¼¸å‘å±•</button>
                </div>

                <!-- æ”¯æ¶æç¤º -->
                <div class="scaffold-hint" id="scaffoldHint">
                    <strong>æç¤ºï¼š</strong>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©ä¸€ä¸ªæ€è€ƒæ”¯æ¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆå¼•å¯¼æ¡†æ¶å¸®åŠ©ä½ ç»„ç»‡æ€è·¯ã€‚
                </div>

                <!-- æ–‡æœ¬è¾“å…¥åŒº -->
                <div class="textarea-wrapper">
                    <textarea 
                        id="commentTextarea" 
                        class="compose-textarea" 
                        placeholder="é€‰æ‹©ä¸€ä¸ªæ€è€ƒæ”¯æ¶å¼€å§‹å†™ä½œ..."></textarea>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="compose-actions">
                    <div class="char-count">å·²è¾“å…¥ <span id="charCount">0</span> å­—</div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="clearBtn">æ¸…ç©º</button>
                        <button class="btn btn-primary" id="submitBtn">å‘å¸ƒè§‚ç‚¹</button>
                    </div>
                </div>
            </div>

            <!-- è¯„è®ºåˆ—è¡¨ -->
            <div class="comments-section">
                <div class="comments-header">
                    <h3 class="comments-title">ğŸ’¬ è®¨è®ºåŒº</h3>
                    <span class="comments-count" id="commentsCount">0 æ¡è§‚ç‚¹</span>
                </div>

                <div id="commentsList">
                    <div class="empty-comments" id="emptyComments">
                        <i class="fas fa-comments"></i>
                        <p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è§‚ç‚¹å§ï¼</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">å‘å¸ƒæˆåŠŸï¼</div>

    <script>
        // ========== æ€è€ƒæ”¯æ¶æ¨¡æ¿ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        const scaffolds = {
            argument: {
                name: 'ğŸ’¡ è®ºè¯è§‚ç‚¹',
                hint: '<strong>è®ºè¯è§‚ç‚¹æ”¯æ¶</strong>ï¼šå¸®åŠ©ä½ æ¸…æ™°åœ°è¡¨è¾¾è§‚ç‚¹ã€é˜è¿°ç†ç”±å¹¶æä¾›è¯æ®æ”¯æŒã€‚',
                template: `ã€æˆ‘è®¤ä¸ºã€‘
ï¼ˆåœ¨æ­¤å†™ä¸‹ä½ çš„æ ¸å¿ƒè§‚ç‚¹ï¼‰

ã€æˆ‘çš„ç†ç”±æ˜¯ã€‘
ï¼ˆè§£é‡Šä¸ºä»€ä¹ˆä½ è¿™æ ·è®¤ä¸ºï¼‰

ã€æ”¯æŒæˆ‘è§‚ç‚¹çš„è¯æ®æ˜¯ã€‘
ï¼ˆåˆ—ä¸¾äº‹å®ã€æ•°æ®æˆ–ä¾‹å­æ¥æ”¯æŒä½ çš„è§‚ç‚¹ï¼‰

ã€å¯èƒ½çš„åå¯¹æ„è§æ˜¯â€¦â€¦ä½†æˆ‘çš„å›åº”æ˜¯ã€‘
ï¼ˆæ€è€ƒå¯èƒ½çš„è´¨ç–‘å¹¶ç»™å‡ºå›åº”ï¼‰`
            },
            question: {
                name: 'â“ æå‡ºè´¨ç–‘',
                hint: '<strong>æå‡ºè´¨ç–‘æ”¯æ¶</strong>ï¼šå¸®åŠ©ä½ ç³»ç»Ÿåœ°è¡¨è¾¾ç–‘é—®å’Œè¿›è¡Œæ‰¹åˆ¤æ€§æ€è€ƒã€‚',
                template: `ã€æˆ‘å¯¹â€¦â€¦æŒæ€€ç–‘æ€åº¦ã€‘
ï¼ˆæŒ‡å‡ºä½ è´¨ç–‘çš„è§‚ç‚¹æˆ–ç°è±¡ï¼‰

ã€æˆ‘çš„ç–‘é—®æ˜¯ã€‘
ï¼ˆå…·ä½“è¯´æ˜ä½ çš„ç–‘é—®æ˜¯ä»€ä¹ˆï¼‰

ã€è®©æˆ‘äº§ç”Ÿç–‘é—®çš„åŸå› æ˜¯ã€‘
ï¼ˆè§£é‡Šä¸ºä»€ä¹ˆä½ ä¼šæœ‰è¿™ä¸ªç–‘é—®ï¼‰

ã€æˆ‘è®¤ä¸ºéœ€è¦è¿›ä¸€æ­¥æ€è€ƒçš„æ˜¯ã€‘
ï¼ˆæå‡ºéœ€è¦æ·±å…¥æ¢è®¨çš„æ–¹å‘ï¼‰`
            },
            connect: {
                name: 'ğŸ”— å»ºç«‹è”ç³»',
                hint: '<strong>å»ºç«‹è”ç³»æ”¯æ¶</strong>ï¼šå¸®åŠ©ä½ å°†æ–°çŸ¥è¯†ä¸å·²æœ‰ç»éªŒæˆ–å…¶ä»–é¢†åŸŸè”ç³»èµ·æ¥ã€‚',
                template: `ã€è¿™è®©æˆ‘æƒ³åˆ°äº†ã€‘
ï¼ˆè”ç³»åˆ°çš„ç›¸å…³ç»éªŒã€çŸ¥è¯†æˆ–æ¡ˆä¾‹ï¼‰

ã€å®ƒä»¬ä¹‹é—´çš„ç›¸ä¼¼ä¹‹å¤„æ˜¯ã€‘
ï¼ˆåˆ†æä¸¤è€…çš„å…±åŒç‚¹ï¼‰

ã€ä¸åŒä¹‹å¤„åœ¨äºã€‘
ï¼ˆæ¯”è¾ƒä¸¤è€…çš„å·®å¼‚ï¼‰

ã€è¿™ç§è”ç³»è®©æˆ‘æœ‰äº†æ–°çš„ç†è§£ã€‘
ï¼ˆæ€»ç»“é€šè¿‡è”ç³»è·å¾—çš„æ–°è®¤è¯†ï¼‰`
            },
            reflect: {
                name: 'ğŸª æ·±åº¦åæ€',
                hint: '<strong>æ·±åº¦åæ€æ”¯æ¶</strong>ï¼šå¸®åŠ©ä½ å¯¹å­¦ä¹ è¿‡ç¨‹å’Œè®¤çŸ¥å˜åŒ–è¿›è¡Œå…ƒè®¤çŸ¥æ€è€ƒã€‚',
                template: `ã€åœ¨è¿™ä¸ªè¯é¢˜ä¸­ï¼Œæˆ‘åŸæ¥çš„æƒ³æ³•æ˜¯ã€‘
ï¼ˆæè¿°ä½ ä¹‹å‰çš„è®¤çŸ¥æˆ–å‡è®¾ï¼‰

ã€ç°åœ¨æˆ‘çš„æƒ³æ³•å‘ç”Ÿäº†è¿™æ ·çš„å˜åŒ–ã€‘
ï¼ˆè¯´æ˜ä½ çš„è®¤çŸ¥æ˜¯å¦‚ä½•æ”¹å˜çš„ï¼‰

ã€ä¿ƒä½¿æˆ‘æ”¹å˜æƒ³æ³•çš„å…³é”®ç‚¹æ˜¯ã€‘
ï¼ˆåˆ†ææ˜¯ä»€ä¹ˆå¯¼è‡´äº†ä½ çš„è®¤çŸ¥è½¬å˜ï¼‰

ã€æˆ‘è¿˜æƒ³æ·±å…¥äº†è§£çš„æ˜¯ã€‘
ï¼ˆæå‡ºä½ å¸Œæœ›ç»§ç»­æ¢ç´¢çš„æ–¹å‘ï¼‰`
            },
            build: {
                name: 'ğŸ§± å»¶ä¼¸å‘å±•',
                hint: '<strong>å»¶ä¼¸å‘å±•æ”¯æ¶</strong>ï¼šå¸®åŠ©ä½ åœ¨ä»–äººè§‚ç‚¹åŸºç¡€ä¸Šè¿›è¡Œå»ºè®¾æ€§æ‹“å±•ã€‚',
                template: `ã€æˆ‘åŒæ„â€¦â€¦çš„è§‚ç‚¹ã€‘
ï¼ˆæŒ‡æ˜ä½ è®¤åŒçš„è§‚ç‚¹åŠå…¶ä½œè€…ï¼‰

ã€åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘æƒ³è¡¥å……ã€‘
ï¼ˆæ·»åŠ æ–°çš„è§’åº¦æˆ–ä¿¡æ¯ï¼‰

ã€è¿›ä¸€æ­¥æ€è€ƒï¼Œæˆ‘è®¤ä¸ºã€‘
ï¼ˆæ·±åŒ–æˆ–å»¶ä¼¸åŸæœ‰è§‚ç‚¹ï¼‰

ã€è¿™å¯¹å®é™…åº”ç”¨çš„å¯ç¤ºæ˜¯ã€‘
ï¼ˆæ€è€ƒç†è®ºå¦‚ä½•æŒ‡å¯¼å®è·µï¼‰`
            }
        };

        // ========== é¡µé¢çŠ¶æ€ ==========
        let currentTaskId = null;
        let currentTopicId = null;
        let currentClubId = null;
        let currentUserId = null;
        let currentUserName = '';
        let currentScaffold = null;
        let commentsList = [];

        // ========== DOM å…ƒç´  ==========
        const scaffoldBtns = document.querySelectorAll('.scaffold-btn');
        const scaffoldHint = document.getElementById('scaffoldHint');
        const commentTextarea = document.getElementById('commentTextarea');
        const charCount = document.getElementById('charCount');
        const clearBtn = document.getElementById('clearBtn');
        const submitBtn = document.getElementById('submitBtn');
        const commentsListEl = document.getElementById('commentsList');
        const commentsCount = document.getElementById('commentsCount');
        const toast = document.getElementById('toast');

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        async function initTopicForumPage() {
            console.log('è¯é¢˜è®ºå›é¡µé¢åˆå§‹åŒ–');
            
            // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
            updateUserDisplay();
            
            // è·å–å‚æ•°
            currentTaskId = getTaskIdFromURL();
            currentTopicId = getTopicIdFromURL();
            currentClubId = getClubIdFromURL();
            
            if (!currentTaskId || !currentTopicId) {
                showToast('æ— æ³•è·å–è¯é¢˜ä¿¡æ¯');
                setTimeout(() => goBackToTopicList(), 2000);
                return;
            }

            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            if (window.Auth && window.Auth.getUser()) {
                const user = window.Auth.getUser();
                currentUserId = user.id || user.userId;
                currentUserName = user.name;
            }

            // åŠ è½½è¯é¢˜è¯¦æƒ…
            await loadTopicDetail();
            
            // åŠ è½½è¯„è®ºåˆ—è¡¨
            await loadComments();
        }

        document.addEventListener('DOMContentLoaded', initTopicForumPage);

        // ========== æ›´æ–°ç”¨æˆ·æ˜¾ç¤º ==========
        function updateUserDisplay() {
            if (window.Auth && window.Auth.getUser()) {
                const user = window.Auth.getUser();
                document.getElementById('forum-user-avatar').textContent = user.name.charAt(0);
                document.getElementById('forum-user-name').textContent = user.name;
            }
        }

        // ========== è·å–URLå‚æ•° ==========
        function getTaskIdFromURL() {
            const hash = window.location.hash;
            const params = new URLSearchParams(hash.split('?')[1]);
            return params.get('taskId') ? parseInt(params.get('taskId')) : null;
        }

        function getTopicIdFromURL() {
            const hash = window.location.hash;
            const params = new URLSearchParams(hash.split('?')[1]);
            return params.get('topicId') ? parseInt(params.get('topicId')) : null;
        }

        function getClubIdFromURL() {
            const hash = window.location.hash;
            const params = new URLSearchParams(hash.split('?')[1]);
            return params.get('clubId') ? parseInt(params.get('clubId')) : null;
        }

        // ========== åŠ è½½è¯é¢˜è¯¦æƒ… ==========
        async function loadTopicDetail() {
            try {
                if (!window.Tasks || !Tasks.getTopicDetail) {
                    throw new Error('è¯é¢˜æ¨¡å—æœªåŠ è½½');
                }

                const topicDetail = await Tasks.getTopicDetail(currentTopicId);
                
                if (topicDetail) {
                    document.getElementById('topicTitle').textContent = topicDetail.title;
                    document.getElementById('topicDescription').textContent = topicDetail.description || 'æš‚æ— æè¿°';
                }
            } catch (error) {
                console.error('åŠ è½½è¯é¢˜è¯¦æƒ…å¤±è´¥:', error);
                showToast('åŠ è½½è¯é¢˜å¤±è´¥');
            }
        }

        // ========== åŠ è½½è¯„è®ºåˆ—è¡¨ ==========
        async function loadComments() {
            try {
                if (!window.Tasks || !Tasks.getTopicComments) {
                    throw new Error('è¯„è®ºæ¨¡å—æœªåŠ è½½');
                }

                commentsList = await Tasks.getTopicComments(currentTopicId);
                
                displayComments(commentsList);
                
            } catch (error) {
                console.error('åŠ è½½è¯„è®ºåˆ—è¡¨å¤±è´¥:', error);
                showToast('åŠ è½½è¯„è®ºå¤±è´¥');
            }
        }

        // ========== æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨ ==========
        function displayComments(comments) {
            const emptyComments = document.getElementById('emptyComments');
            
            if (!comments || comments.length === 0) {
                commentsListEl.innerHTML = `
                    <div class="empty-comments">
                        <i class="fas fa-comments"></i>
                        <p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è§‚ç‚¹å§ï¼</p>
                    </div>
                `;
                commentsCount.textContent = '0 æ¡è§‚ç‚¹';
                return;
            }

            commentsCount.textContent = `${comments.length} æ¡è§‚ç‚¹`;
            
            commentsListEl.innerHTML = comments.map(comment => {
                // å¤„ç†è¯„è®ºå†…å®¹ï¼Œå°†æ”¯æ¶æ ‡è®°è½¬æ¢ä¸ºé«˜äº®æ˜¾ç¤º
                let formattedContent = escapeHtml(comment.content || '')
                    .replace(/ã€([^ã€‘]+)ã€‘/g, '<span class="scaffold-text">$1</span>')
                    .replace(/\n/g, '<br>');

                return `
                    <div class="comment-card">
                        <div class="comment-header">
                            <div class="avatar">${escapeHtml(comment.userName || 'æœªçŸ¥').charAt(0)}</div>
                            <div class="comment-meta">
                                <div class="comment-author">${escapeHtml(comment.userName || 'æœªçŸ¥')}</div>
                                <div class="comment-time">${formatDate(comment.createdAt)}</div>
                            </div>
                            <span class="scaffold-tag">${escapeHtml(comment.scaffoldType || 'è§‚ç‚¹')}</span>
                        </div>
                        <div class="comment-content">
                            ${formattedContent}
                        </div>
                        <div class="comment-actions">
                            <button class="action-btn" onclick="likeComment(${comment.commentId})">
                                ğŸ‘ èµåŒ (${comment.likeCount || 0})
                            </button>
                            <button class="action-btn">ğŸ’¬ å›å¤</button>
                            <button class="action-btn">ğŸ“Œ æ”¶è—</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== æ”¯æ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        scaffoldBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                scaffoldBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const scaffoldType = this.dataset.scaffold;
                currentScaffold = scaffolds[scaffoldType];

                scaffoldHint.innerHTML = currentScaffold.hint;
                commentTextarea.value = currentScaffold.template;
                updateCharCount();
                commentTextarea.focus();
            });
        });

        // ========== æ›´æ–°å­—æ•°ç»Ÿè®¡ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        function updateCharCount() {
            const text = commentTextarea.value;
            const cleanText = text.replace(/ã€[^ã€‘]+ã€‘/g, '').replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, '');
            charCount.textContent = cleanText.trim().length;
        }

        commentTextarea.addEventListener('input', updateCharCount);

        // ========== æ¸…ç©ºæŒ‰é’®ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        clearBtn.addEventListener('click', function() {
            commentTextarea.value = '';
            scaffoldBtns.forEach(b => b.classList.remove('active'));
            scaffoldHint.innerHTML = '<strong>æç¤ºï¼š</strong>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©ä¸€ä¸ªæ€è€ƒæ”¯æ¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆå¼•å¯¼æ¡†æ¶å¸®åŠ©ä½ ç»„ç»‡æ€è·¯ã€‚';
            currentScaffold = null;
            updateCharCount();
        });

        // ========== å‘å¸ƒè¯„è®º ==========
        submitBtn.addEventListener('click', async function() {
            const content = commentTextarea.value.trim();

            if (!content) {
                showToast('è¯·å…ˆå†™ä¸‹ä½ çš„è§‚ç‚¹ï¼');
                return;
            }

            if (!currentScaffold) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ€è€ƒæ”¯æ¶ï¼');
                return;
            }

            const hasContent = content.replace(/ã€[^ã€‘]+ã€‘/g, '').replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, '').trim().length > 0;
            if (!hasContent) {
                showToast('è¯·åœ¨æ”¯æ¶æ¡†æ¶ä¸­å¡«å†™ä½ çš„æƒ³æ³•ï¼');
                return;
            }

            try {
                const commentData = {
                    topicId: currentTopicId,
                    content: content,
                    scaffoldType: currentScaffold.name
                };

                const result = await Tasks.createTopicComment(commentData);

                if (result.success) {
                    showToast('å‘å¸ƒæˆåŠŸï¼æ„Ÿè°¢ä½ çš„æ·±åº¦æ€è€ƒ âœ¨');
                    
                    // æ¸…ç©ºè¡¨å•
                    commentTextarea.value = '';
                    scaffoldBtns.forEach(b => b.classList.remove('active'));
                    scaffoldHint.innerHTML = '<strong>æç¤ºï¼š</strong>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©ä¸€ä¸ªæ€è€ƒæ”¯æ¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆå¼•å¯¼æ¡†æ¶å¸®åŠ©ä½ ç»„ç»‡æ€è·¯ã€‚';
                    currentScaffold = null;
                    updateCharCount();

                    // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
                    setTimeout(() => loadComments(), 500);
                } else {
                    showToast(result.message || 'å‘å¸ƒå¤±è´¥');
                }
            } catch (error) {
                console.error('å‘å¸ƒè¯„è®ºå¤±è´¥:', error);
                showToast('å‘å¸ƒå¤±è´¥: ' + error.message);
            }
        });

        // ========== ç‚¹èµè¯„è®º ==========
        async function likeComment(commentId) {
            try {
                // è¿™é‡Œå¯ä»¥è°ƒç”¨APIç‚¹èµ
                // const result = await Tasks.likeComment(commentId);
                
                // æš‚æ—¶åªæ˜¯å‰ç«¯æ›´æ–°
                showToast('ç‚¹èµæˆåŠŸï¼');
            } catch (error) {
                console.error('ç‚¹èµå¤±è´¥:', error);
            }
        }

        // ========== æ˜¾ç¤º Toastï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ========== è¿”å›è¯é¢˜åˆ—è¡¨ ==========
        function goBackToTopicList() {
            const hash = `topic-list?taskId=${currentTaskId}&clubId=${currentClubId}`;
            window.location.hash = hash;
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'åˆšåˆš';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 2592000000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ========== å…¨å±€å‡½æ•° ==========
        window.likeComment = likeComment;
        window.goBackToTopicList = goBackToTopicList;
        window.initTopicForumPage = initTopicForumPage;

        // ç«‹å³åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTopicForumPage);
        } else {
            initTopicForumPage();
        }
    </script>
</body>
</html>