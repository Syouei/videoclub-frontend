<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教师视频俱乐部 - 视频播放</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1890ff;
            --primary-light: #40a9ff;
            --primary-dark: #096dd9;
            --danger-color: #ff4d4f;
            --warning-color: #faad14;
            --success-color: #52c41a;
            --text-main: #333;
            --text-sub: #666;
            --bg-light: #f5f7fa;
            --border-color: #eee;
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
            --time-color-0: #1890ff;
            --time-color-1: #52c41a;
            --time-color-2: #faad14;
            --time-color-3: #ff4d4f;
            --time-color-4: #722ed1;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'PingFang SC', 'Microsoft YaHei', 'Helvetica Neue', sans-serif; }
        html, body { height: 100%; overflow: hidden; }
        body { background-color: var(--bg-light); display: flex; flex-direction: column; height: 100vh; color: var(--text-main); }
        
        .header {
            background: white;
            padding: 0 24px;
            height: 68px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .btn-back { background: none; border: none; font-size: 18px; color: var(--text-main); cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.3s; }
        .btn-back:hover { background-color: rgba(0, 0, 0, 0.05); }
        .logo { color: var(--primary-color); font-size: 22px; font-weight: 700; background: linear-gradient(135deg, var(--primary-color), #722ed1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 4px 12px; border-radius: 20px; transition: background 0.3s; }
        .user-info:hover { background-color: rgba(0, 0, 0, 0.02); }
        .user-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary-color), #722ed1); border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; color: white; font-weight: bold; font-size: 16px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .main-container { flex: 1; display: flex; padding: 20px; gap: 20px; overflow: hidden; }
        .video-container { flex: 3; display: flex; flex-direction: column; min-width: 0; }
        .video-player-wrapper { position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow); }
        #mainVideo { width: 100%; height: 100%; display: block; }
        
        .comments-container { flex: 2; display: flex; flex-direction: column; background-color: white; border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; height: calc(100vh - 68px - 40px); }
        .comments-header { padding: 20px 20px 15px 20px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .comments-header-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .section-title { font-size: 18px; color: var(--text-main); font-weight: 600; }
        .sort-select { padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; cursor: pointer; background-color: white; }
        .video-title { font-size: 16px; font-weight: 600; color: var(--text-main); margin-bottom: 8px; }
        .stats-container { display: flex; align-items: center; gap: 15px; margin-top: 10px; font-size: 13px; color: var(--text-sub); }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        
        .comments-list { flex: 1; overflow-y: auto; padding: 0 20px; max-height: calc(100vh - 68px - 40px - 80px - 220px); }
        .comments-list::-webkit-scrollbar { width: 6px; }
        .comments-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .comments-list::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        
        .comment-item { padding: 12px 0; border-bottom: 1px solid var(--border-color); transition: all 0.3s ease; position: relative; }
        .comment-item:last-child { border-bottom: none; }
        .comment-item:hover { background-color: #f9f9f9; }
        .comment-item.highlighted { background-color: rgba(24, 144, 255, 0.08); border-left: 4px solid var(--primary-color); padding-left: 16px; margin-left: -20px; animation: highlightPulse 2s ease; }
        
        /* 子评论样式 - 缩进并缩小 */
        .comment-item.reply-comment { margin-left: 36px; padding: 8px 0; border-bottom: none; border-left: 2px solid var(--border-color); padding-left: 12px; background-color: #fafafa; border-radius: 6px; margin-top: 4px; margin-bottom: 4px; }
        .comment-item.reply-comment .comment-header { margin-bottom: 4px; }
        .comment-item.reply-comment .comment-avatar { width: 24px; height: 24px; font-size: 10px; }
        .comment-item.reply-comment .comment-author { font-size: 12px; }
        .comment-item.reply-comment .comment-content { font-size: 12px; margin-top: 4px; padding-left: 0; }
        .comment-item.reply-comment .reply-btn, .comment-item.reply-comment .delete-btn { font-size: 11px; padding: 2px 8px; height: auto; min-height: 24px; }
        .comment-item.reply-comment .reply-indicator { font-size: 10px; }
        
        @keyframes highlightPulse {
            0% { background-color: rgba(24, 144, 255, 0.08); }
            50% { background-color: rgba(24, 144, 255, 0.15); }
            100% { background-color: rgba(24, 144, 255, 0.08); }
        }
        
        .comment-header { display: flex; align-items: center; margin-bottom: 8px; }
        .comment-avatar { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), #722ed1); margin-right: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; flex-shrink: 0; overflow: hidden; }
        .comment-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .comment-author { font-weight: 600; color: var(--text-main); font-size: 13px; }
        .time-marker { display: inline-block; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-left: 10px; vertical-align: middle; font-weight: 500; cursor: pointer; transition: all 0.2s ease; color: white; }
        .time-marker:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .time-marker.level-0 { background-color: var(--time-color-0); }
        .time-marker.level-1 { background-color: var(--time-color-1); }
        .time-marker.level-2 { background-color: var(--time-color-2); }
        .time-marker.level-3 { background-color: var(--time-color-3); }
        .time-marker.level-4 { background-color: var(--time-color-4); }
        .comment-time { color: var(--text-sub); font-size: 11px; margin-left: 8px; opacity: 0.8; }
        .comment-content { color: var(--text-main); line-height: 1.5; font-size: 13px; margin-top: 8px; padding-left: 36px; }
        .reply-indicator { font-size: 11px; color: var(--primary-color); margin-left: 8px; background: rgba(24, 144, 255, 0.1); padding: 1px 6px; border-radius: 3px; }
        .reply-btn, .delete-btn { margin-top: 8px; padding: 4px 12px; border: 1px solid var(--border-color); border-radius: 4px; background: white; cursor: pointer; font-size: 12px; color: var(--text-sub); transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; height: 28px; }
        .reply-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: rgba(24, 144, 255, 0.05); }
        .delete-btn { margin-left: 8px; border-color: var(--danger-color); color: var(--danger-color); }
        .delete-btn:hover { background: rgba(255, 77, 79, 0.05); }
        .current-time-indicator { position: absolute; top: -8px; left: 20px; background: var(--primary-color); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .comment-item.highlighted .current-time-indicator { opacity: 1; }
        
        .reply-form { margin-top: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; display: none; }
        .reply-form.active { display: block; }
        .reply-form-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 12px; color: var(--text-sub); }
        .reply-input { width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; resize: none; min-height: 60px; font-family: inherit; font-size: 13px; margin-bottom: 8px; }
        .reply-form-actions { display: flex; justify-content: flex-end; gap: 8px; }
        .reply-submit-btn, .reply-cancel-btn { padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; border: none; }
        .reply-submit-btn { background: var(--primary-color); color: white; }
        .reply-submit-btn:hover { background: var(--primary-dark); }
        .reply-cancel-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-sub); }
        .reply-cancel-btn:hover { border-color: var(--text-main); color: var(--text-main); }
        
        .comment-form { padding: 20px; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .comment-form-header { display: flex; align-items: center; margin-bottom: 12px; }
        .comment-input-container { position: relative; }
        .comment-input { width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; resize: none; min-height: 80px; margin-bottom: 12px; font-family: inherit; font-size: 13px; }
        .timestamp-toggle { display: flex; align-items: center; margin-bottom: 12px; }
        .timestamp-toggle input { margin-right: 8px; accent-color: var(--primary-color); }
        .timestamp-toggle label { font-size: 13px; color: var(--text-main); cursor: pointer; }
        .timestamp-display { margin-left: 10px; font-size: 12px; color: var(--primary-color); font-weight: 500; display: none; }
        .comment-submit { padding: 10px 20px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 13px; width: 100%; }
        .comment-submit:disabled { background: #ccc; cursor: not-allowed; }
        
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 50; gap: 15px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error-message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--danger-color); color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(255, 77, 79, 0.3); z-index: 1000; display: none; font-size: 14px; }
        .error-message.active { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        
        .video-progress-overlay { position: absolute; bottom: 60px; left: 12px; right: 12px; height: 10px; pointer-events: none; z-index: 100; }
        .marker-item { position: absolute; top: 0; width: 10px; height: 10px; border-radius: 50%; transform: translateX(-50%); cursor: pointer; pointer-events: auto; border: 2px solid #fff; box-shadow: 0 0 4px rgba(0,0,0,0.3); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .marker-item:hover { transform: translateX(-50%) scale(1.6); z-index: 20; }
        .marker-tooltip { position: absolute; bottom: 18px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.85); color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; pointer-events: none; z-index: 30; }
        .marker-item:hover .marker-tooltip { opacity: 1; visibility: visible; }
        .marker-item.level-0 { background-color: var(--time-color-0); }
        .marker-item.level-1 { background-color: var(--time-color-1); }
        .marker-item.level-2 { background-color: var(--time-color-2); }
        .marker-item.level-3 { background-color: var(--time-color-3); }
        .marker-item.level-4 { background-color: var(--time-color-4); }
        
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .video-container { padding-right: 0; padding-bottom: 20px; }
            .comments-container { min-height: 400px; }
            .video-player-wrapper { min-height: 300px; }
        }
    </style>
</head>
<body>
    <div class="error-message" id="errorMessage"></div>
    <div class="header">
        <div class="header-left">
            <button class="btn-back" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="logo">教师视频俱乐部</div>
        </div>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">?</div>
        </div>
    </div>
    <div class="main-container">
        <div class="video-container">
            <div class="video-player-wrapper">
                <div class="video-player" id="videoPlayer">
                    <div class="loading-overlay" id="videoLoading">
                        <div class="loading-spinner"></div>
                        <span>正在加载视频...</span>
                    </div>
                    <video id="mainVideo" controls poster="" preload="metadata">您的浏览器不支持 HTML5 视频。</video>
                    <div class="video-progress-overlay" id="videoProgressOverlay"></div>
                </div>
            </div>
            <div style="margin-top: 15px; color: var(--text-sub); font-size: 13px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-lightbulb" style="color: var(--warning-color);"></i>
                <span>提示：视频进度条上的彩色圆点表示在该时刻有老师留下了教学评论。</span>
            </div>
        </div>
        <div class="comments-container">
            <div class="comments-header">
                <div class="video-title" id="videoTitle">视频标题</div>
                <div class="comments-header-row">
                    <h2 class="section-title">评论 (<span id="commentCount">0</span>)</h2>
                    <select id="commentSort" class="sort-select">
                        <option value="time">按视频时间排序</option>
                        <option value="newest">按发布时间(最新)</option>
                        <option value="oldest">按发布时间(最早)</option>
                    </select>
                </div>
            </div>
            <div class="loading-overlay" id="commentsLoading" style="position: relative; background: rgba(255,255,255,0.9); color: var(--text-main);">
                <div class="loading-spinner" style="border-color: rgba(24, 144, 255, 0.3); border-top-color: var(--primary-color);"></div>
                <span>正在加载评论...</span>
            </div>
            <div class="comments-list" id="commentsList"></div>
            <div class="comment-form">
                <div class="comment-form-header">
                    <div class="comment-avatar" id="currentUserAvatar">?</div>
                    <div class="comment-author" id="currentUserName">您</div>
                </div>
                <div class="timestamp-toggle">
                    <input type="checkbox" id="addTimestamp">
                    <label for="addTimestamp">添加时间点标记</label>
                    <span class="timestamp-display" id="timestampDisplay">00:00</span>
                </div>
                <div class="comment-input-container">
                    <textarea class="comment-input" id="commentInput" placeholder="请输入您的评论..."></textarea>
                </div>
                <button class="comment-submit" id="commentSubmit">发表评论</button>
            </div>
        </div>
    </div>

    <script>
        class VideoCommentSystem {
            constructor() {
                this.video = document.getElementById('mainVideo');
                this.commentsList = document.getElementById('commentsList');
                this.overlay = document.getElementById('videoProgressOverlay');
                this.comments = [];
                this.currentUser = { name: '您', avatar: '?', userId: null };
                this.currentHighlightedComment = null;
                this.isScrollingToComment = false;
                this.timePointCounts = {};
                this.replyInProgress = null;
                this.videoDuration = 0;
                this.currentVideoTime = 0;
                this.autoScrollEnabled = true;
                this.isMouseInComments = false;
                this.sortBy = 'time';
                this.videoInfo = { videoUrl: null, taskId: null, title: null, videoId: null };
                this.pagination = { page: 1, pageSize: 20, hasMore: true, isLoading: false };
                this.hotTimestamps = [];
                this.init();
            }

            updateCommentFormUserInfo() {
                const currentUserAvatar = document.getElementById('currentUserAvatar');
                const currentUserName = document.getElementById('currentUserName');
                if (currentUserAvatar && currentUserName) {
                    currentUserAvatar.textContent = this.currentUser.avatar;
                    currentUserName.textContent = this.currentUser.name;
                }
            }

            init() {
                this.loadUserInfo();
                this.loadVideoFromURL();
                this.setupVideoEvents();
                this.setupEventListeners();
                this.initOverlay();
                this.setupCommentsHoverListener();
                if (this.videoInfo.videoId) {
                    this.loadVideoInfo();
                    this.loadCommentsFromAPI();
                    this.loadHotTimestamps();
                }
            }
            
            setupCommentsHoverListener() {
                const commentsContainer = document.querySelector('.comments-container');
                if (commentsContainer) {
                    commentsContainer.addEventListener('mouseenter', () => {
                        this.isMouseInComments = true;
                        console.log('[AutoScroll] 鼠标进入评论区，暂停自动滚动');
                    });
                    commentsContainer.addEventListener('mouseleave', () => {
                        this.isMouseInComments = false;
                        console.log('[AutoScroll] 鼠标离开评论区，恢复自动滚动');
                    });
                }
            }

            loadVideoFromURL() {
                const hash = window.location.hash;
                const queryString = hash.split('?')[1] || '';
                const urlParams = new URLSearchParams(queryString);
                this.videoInfo = {
                    videoUrl: urlParams.get('videoUrl') ? decodeURIComponent(urlParams.get('videoUrl')) : null,
                    taskId: urlParams.get('taskId') || null,
                    title: urlParams.get('title') ? decodeURIComponent(urlParams.get('title')) : null,
                    videoId: urlParams.get('videoId') || null
                };
                if (this.videoInfo.videoUrl) {
                    this.video.src = this.videoInfo.videoUrl;
                    this.video.load();
                }
                if (this.videoInfo.title) {
                    document.getElementById('videoTitle').textContent = this.videoInfo.title;
                    document.title = `${this.videoInfo.title} - 教师视频俱乐部`;
                }
                console.log('视频信息:', this.videoInfo);
            }

            loadUserInfo() {
                const userAvatar = document.getElementById('userAvatar');
                const savedUserName = localStorage.getItem('userName');
                const savedUserId = localStorage.getItem('userId');
                if (savedUserName) {
                    this.currentUser.name = savedUserName;
                    this.currentUser.avatar = savedUserName.charAt(0);
                } else {
                    this.currentUser.name = '您';
                    this.currentUser.avatar = '?';
                }
                if (savedUserId) {
                    this.currentUser.userId = savedUserId;
                }
                userAvatar.textContent = this.currentUser.avatar;
                this.updateCommentFormUserInfo();
            }

            async loadVideoInfo() {
                if (!window.API || !window.API.getVideoInfo) return;
                try {
                    this.showLoading('videoLoading', true);
                    const result = await window.API.getVideoInfo(this.videoInfo.videoId);
                    if (result.code === 0 && result.data) {
                        const videoData = result.data;
                        if (!this.videoInfo.videoUrl && videoData.videoUrl) {
                            this.video.src = videoData.videoUrl;
                            this.video.load();
                        }
                        if (videoData.title && !this.videoInfo.title) {
                            document.getElementById('videoTitle').textContent = videoData.title;
                            document.title = `${videoData.title} - 教师视频俱乐部`;
                        }
                        if (videoData.coverUrl) {
                            this.video.poster = videoData.coverUrl;
                        }
                    }
                } catch (error) {
                    console.error('加载视频信息失败:', error);
                    this.showError('加载视频信息失败，请稍后重试');
                } finally {
                    this.showLoading('videoLoading', false);
                }
            }

            setupVideoEvents() {
                this.video.addEventListener('loadedmetadata', () => {
                    this.videoDuration = this.video.duration;
                    console.log('[Markers] 视频时长:', this.videoDuration);
                    this.renderOverlayMarkers();
                });
                this.video.addEventListener('timeupdate', () => {
                    this.currentVideoTime = this.video.currentTime;
                    this.highlightCommentsAtCurrentTime();
                });
            }

            highlightCommentsAtCurrentTime() {
                const currentTime = this.currentVideoTime;
                document.querySelectorAll('.comment-item').forEach(el => {
                    el.classList.remove('highlighted');
                });
                const currentComments = this.comments.filter(c => {
                    const commentTime = c.timestamp || 0;
                    return c.parentId === null && Math.abs(commentTime - currentTime) < 1;
                });
                if (currentComments.length > 0) {
                    const firstComment = currentComments[0];
                    const commentEl = document.querySelector(`[data-comment-id="${firstComment.id}"]`);
                    if (commentEl) {
                        commentEl.classList.add('highlighted');
                        this.currentHighlightedComment = firstComment;
                        if (!this.isMouseInComments && this.autoScrollEnabled) {
                            this.scrollToComment(commentEl);
                        }
                    }
                }
            }

            setupEventListeners() {
                document.getElementById('commentSubmit').addEventListener('click', () => this.submitComment());
                document.getElementById('addTimestamp').addEventListener('change', (e) => {
                    const display = document.getElementById('timestampDisplay');
                    if (e.target.checked) {
                        display.textContent = this.formatTime(this.currentVideoTime);
                        display.style.display = 'inline';
                    } else {
                        display.style.display = 'none';
                    }
                });
                document.getElementById('commentSort').addEventListener('change', (e) => {
                    this.sortBy = e.target.value;
                    console.log('[Sort] 排序方式:', this.sortBy);
                    this.renderComments();
                });
            }

            initOverlay() {
                console.log('[Overlay] 进度条覆盖层已初始化');
            }

            async loadCommentsFromAPI() {
                if (!window.API || !window.API.getVideoComments) {
                    console.warn('API.getVideoComments 不可用');
                    return;
                }
                if (this.pagination.isLoading || !this.pagination.hasMore) return;
                try {
                    this.pagination.isLoading = true;
                    this.showLoading('commentsLoading', true);
                    const result = await window.API.getVideoComments(this.videoInfo.videoId, {
                        page: this.pagination.page,
                        pageSize: this.pagination.pageSize
                    });
                    if (result.code === 0 && result.data && result.data.list) {
                        const newComments = result.data.list.map(item => this.convertBackendComment(item));
                        if (this.pagination.page === 1) {
                            this.comments = newComments;
                        } else {
                            this.comments = [...this.comments, ...newComments];
                        }
                        this.pagination.hasMore = newComments.length === this.pagination.pageSize;
                        this.pagination.page++;
                        this.updateTimePointCounts();
                        this.renderComments();
                        this.renderOverlayMarkers();
                    } else {
                        this.showError(result.msg || '加载评论失败');
                    }
                } catch (error) {
                    console.error('加载评论失败:', error);
                    this.showError('加载评论失败，请稍后重试');
                } finally {
                    this.pagination.isLoading = false;
                    this.showLoading('commentsLoading', false);
                }
            }

            updateTimePointCounts() {
                this.timePointCounts = {};
                const countTime = (comments) => {
                    comments.forEach(c => {
                        if (c.timestamp !== undefined) {
                            const timeKey = Math.floor(c.timestamp);
                            this.timePointCounts[timeKey] = (this.timePointCounts[timeKey] || 0) + 1;
                        }
                        if (c.replies && c.replies.length > 0) {
                            countTime(c.replies);
                        }
                    });
                };
                countTime(this.comments);
                console.log('[Markers] 时间点统计:', this.timePointCounts);
            }

            getTimeMarkerLevel(timestamp) {
                const count = this.timePointCounts[Math.floor(timestamp)] || 0;
                return Math.min(count - 1, 4);
            }

            renderOverlayMarkers() {
                console.log('[Markers] 开始渲染, videoDuration:', this.videoDuration, 'timePointCounts:', this.timePointCounts);
                if (!this.videoDuration || this.videoDuration === 0) {
                    console.warn('[Markers] 视频时长为0，无法渲染标记');
                    return;
                }
                this.overlay.innerHTML = '';
                const uniqueTimes = Object.keys(this.timePointCounts);
                console.log('[Markers] 唯一时间点:', uniqueTimes);
                if (uniqueTimes.length === 0) {
                    console.warn('[Markers] 没有时间点数据');
                    return;
                }
                uniqueTimes.forEach(time => {
                    const timestamp = parseFloat(time);
                    const count = this.timePointCounts[time];
                    const pos = (timestamp / this.videoDuration) * 100;
                    console.log(`[Markers] 添加标记: time=${timestamp}, pos=${pos}%, count=${count}`);
                    const marker = document.createElement('div');
                    marker.className = `marker-item level-${this.getTimeMarkerLevel(timestamp)}`;
                    marker.style.left = `${pos}%`;
                    marker.innerHTML = `<div class="marker-tooltip">${count} 条评论 @ ${this.formatTime(timestamp)}</div>`;
                    marker.onclick = (e) => {
                        e.stopPropagation();
                        this.jumpToTime(timestamp);
                    };
                    this.overlay.appendChild(marker);
                });
                console.log('[Markers] 渲染完成，共', uniqueTimes.length, '个标记');
            }

            // 构建评论树结构
            buildCommentTree() {
                // 分离顶级评论和子评论
                const topLevelComments = this.comments.filter(c => c.parentId === null);
                const childComments = this.comments.filter(c => c.parentId !== null);
                
                // 递归函数：为每个评论找到其子评论
                const attachChildren = (parent) => {
                    // 找到所有直接子评论
                    const children = childComments.filter(c => c.parentId === parent.id);
                    if (children.length > 0) {
                        parent.replies = children;
                        // 递归为每个子评论找其子评论
                        children.forEach(child => attachChildren(child));
                    }
                    return parent;
                };
                
                // 为每个顶级评论构建树
                return topLevelComments.map(comment => attachChildren(comment));
            }

            // 获取排序后的顶级评论（子评论跟随父评论）
            getSortedTopLevelComments() {
                const topLevelComments = this.comments.filter(c => c.parentId === null);
                
                // 只对顶级评论排序
                let sorted = [...topLevelComments];
                switch (this.sortBy) {
                    case 'newest':
                        sorted.sort((a, b) => b.id - a.id);
                        break;
                    case 'oldest':
                        sorted.sort((a, b) => a.id - b.id);
                        break;
                    case 'time':
                    default:
                        sorted.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                        break;
                }
                
                return sorted;
            }

            renderComments() {
                this.commentsList.innerHTML = '';
                
                // 构建完整的评论树
                const commentTree = this.buildCommentTree();
                
                // 获取排序后的顶级评论
                const sortedTopLevel = this.getSortedTopLevelComments();
                
                // 按照排序后的顺序渲染
                sortedTopLevel.forEach(topComment => {
                    // 在树中找到对应的评论（包含子评论）
                    const treeComment = commentTree.find(c => c.id === topComment.id);
                    if (treeComment) {
                        this.renderCommentAndReplies(treeComment, 0);
                    }
                });
                
                // 更新评论数量（包括子评论）
                const totalCount = this.comments.length;
                document.getElementById('commentCount').textContent = totalCount;
            }

            // 递归渲染评论及其所有子评论
            renderCommentAndReplies(comment, depth) {
                // 渲染当前评论
                this.commentsList.appendChild(this.renderCommentItem(comment, depth));
                
                // 递归渲染所有子评论（子评论及其子评论使用相同样式，都是缩进的）
                if (comment.replies && comment.replies.length > 0) {
                    comment.replies.forEach(reply => {
                        this.renderCommentAndReplies(reply, depth + 1);
                    });
                }
            }

            renderCommentItem(c, depth = 0) {
                const div = document.createElement('div');
                // depth > 0 表示是子评论（包括子评论的子评论）
                const isReply = c.parentId !== null;
                div.className = 'comment-item' + (isReply ? ' reply-comment' : '');
                div.dataset.commentId = c.id;
                
                const level = this.getTimeMarkerLevel(c.timestamp);
                const replyIndicator = c.parentId !== null 
                    ? `<span class="reply-indicator">回复 ${this.findCommentAuthor(c.parentId)}</span>` 
                    : '';
                
                const canDelete = this.currentUser.userId && 
                    (this.currentUser.userId == c.userId || this.currentUser.role === 'admin');
                
                const avatarHtml = c.avatar && c.avatar.startsWith('http') 
                    ? `<img src="${c.avatar}" alt="${c.author}">` 
                    : c.avatar;
                
                div.innerHTML = `
                    <div class="current-time-indicator">正在播放</div>
                    <div class="comment-header">
                        <div class="comment-avatar">${avatarHtml}</div>
                        <div class="comment-author">${c.author}</div>
                        ${replyIndicator}
                        ${c.timestamp !== undefined && c.parentId === null ? `<div class="time-marker level-${level}">${this.formatTime(c.timestamp)}</div>` : ''}
                        <div class="comment-time">${c.time}</div>
                    </div>
                    <div class="comment-content">${c.content}</div>
                    <button class="reply-btn" data-id="${c.id}">回复</button>
                    ${canDelete ? `<button class="delete-btn" data-id="${c.id}">删除</button>` : ''}
                `;
                
                div.querySelector('.reply-btn').onclick = (e) => {
                    e.stopPropagation();
                    this.showReplyForm(c.id);
                };
                
                if (canDelete) {
                    div.querySelector('.delete-btn').onclick = (e) => {
                        e.stopPropagation();
                        this.deleteComment(c.id);
                    };
                }
                
                // 只有顶级评论可以点击跳转时间
                if (c.parentId === null && c.timestamp !== undefined) {
                    div.onclick = () => {
                        this.jumpToTime(c.timestamp);
                        this.highlightComment(div, c);
                    };
                }
                return div;
            }

            findCommentAuthor(commentId) {
                const comment = this.comments.find(c => c.id === commentId);
                return comment ? comment.author : '某人';
            }

            findComment(commentId) {
                return this.comments.find(c => c.id === commentId);
            }

            showReplyForm(id) {
                if (this.replyInProgress) {
                    const oldForm = document.querySelector('.reply-form.active');
                    if (oldForm) oldForm.remove();
                }
                this.replyInProgress = id;
                const commentEl = document.querySelector(`[data-comment-id="${id}"]`);
                const parentComment = this.findComment(id);
                const form = document.createElement('div');
                form.className = 'reply-form active';
                form.innerHTML = `
                    <div class="reply-form-header">
                        <span>回复 ${parentComment ? parentComment.author : ''}</span>
                        <span class="cancel-reply" style="cursor: pointer; color: #999;">✕</span>
                    </div>
                    <textarea class="reply-input" placeholder="请输入回复内容..."></textarea>
                    <div class="reply-form-actions">
                        <button class="reply-cancel-btn">取消</button>
                        <button class="reply-submit-btn">发送回复</button>
                    </div>
                `;
                commentEl.appendChild(form);
                form.querySelector('.reply-input').focus();
                form.querySelector('.reply-cancel-btn').onclick = () => form.remove();
                form.querySelector('.cancel-reply').onclick = () => form.remove();
                form.querySelector('.reply-submit-btn').onclick = () => {
                    this.submitReply(id, form.querySelector('.reply-input').value.trim());
                };
            }

            async submitComment() {
                const input = document.getElementById('commentInput');
                const text = input.value.trim();
                if (!text) {
                    this.showError('请输入评论内容');
                    return;
                }
                const submitBtn = document.getElementById('commentSubmit');
                submitBtn.disabled = true;
                submitBtn.textContent = '发送中...';
                try {
                    const timestamp = document.getElementById('addTimestamp').checked 
                        ? Math.floor(this.currentVideoTime) 
                        : null;
                    const result = await window.API.submitVideoComment({
                        videoId: this.videoInfo.videoId,
                        content: text,
                        timestamp: timestamp
                    });
                    if (result.code === 0 && result.data) {
                        const newComment = this.convertBackendComment(result.data);
                        this.comments.push(newComment);
                        this.sortBy = 'time';
                        document.getElementById('commentSort').value = 'time';
                        this.updateTimePointCounts();
                        this.renderComments();
                        this.renderOverlayMarkers();
                        input.value = '';
                        document.getElementById('addTimestamp').checked = false;
                        document.getElementById('timestampDisplay').style.display = 'none';
                    } else {
                        this.showError(result.msg || '评论发送失败');
                    }
                } catch (error) {
                    console.error('提交评论失败:', error);
                    this.showError('评论发送失败，请稍后重试');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '发表评论';
                }
            }

            async submitReply(parentId, text) {
                if (!text) {
                    this.showError('请输入回复内容');
                    return;
                }
                const parentComment = this.findComment(parentId);
                if (!parentComment) {
                    this.showError('找不到要回复的评论');
                    return;
                }
                try {
                    const result = await window.API.submitVideoComment({
                        videoId: this.videoInfo.videoId,
                        content: text,
                        timestamp: null,
                        parentId: parentId
                    });
                    if (result.code === 0 && result.data) {
                        const newReply = this.convertBackendComment(result.data);
                        this.comments.push(newReply);
                        this.renderComments();
                        const form = document.querySelector('.reply-form.active');
                        if (form) form.remove();
                        this.replyInProgress = null;
                    } else {
                        this.showError(result.msg || '回复发送失败');
                    }
                } catch (error) {
                    console.error('提交回复失败:', error);
                    this.showError('回复发送失败，请稍后重试');
                }
            }

            async deleteComment(commentId) {
                if (!confirm('确定要删除这条评论吗？')) return;
                if (!window.API || !window.API.deleteComment) {
                    this.deleteLocalComment(commentId);
                    return;
                }
                try {
                    const result = await window.API.deleteComment(commentId);
                    if (result.code === 0) {
                        this.deleteLocalComment(commentId);
                        this.showError('评论已删除');
                    } else {
                        this.showError(result.msg || '删除失败');
                    }
                } catch (error) {
                    console.error('删除评论失败:', error);
                    this.showError('删除失败，请稍后重试');
                }
            }

            deleteLocalComment(commentId) {
                const deleteFromTree = (comments, id) => {
                    const index = comments.findIndex(c => c.id == id);
                    if (index !== -1) {
                        comments.splice(index, 1);
                        return true;
                    }
                    for (const comment of comments) {
                        if (comment.replies && comment.replies.length > 0) {
                            if (deleteFromTree(comment.replies, id)) return true;
                        }
                    }
                    return false;
                };
                deleteFromTree(this.comments, commentId);
                this.updateTimePointCounts();
                this.renderComments();
                this.renderOverlayMarkers();
            }

            convertBackendComment(backendComment) {
                const actualParentId = backendComment.parentId !== undefined ? backendComment.parentId : null;
                return {
                    id: backendComment.commentId,
                    author: backendComment.sender?.username || '未知用户',
                    avatar: backendComment.sender?.avatarUrl || (backendComment.sender?.username?.charAt(0) || '?'),
                    userId: backendComment.sender?.userId,
                    role: backendComment.sender?.role,
                    content: backendComment.content,
                    timestamp: backendComment.videoTime,
                    time: this.formatBackendTime(backendComment.createdAt),
                    parentId: actualParentId,
                    replies: []
                };
            }

            formatBackendTime(isoTime) {
                if (!isoTime) return '';
                const date = new Date(isoTime);
                return date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            }

            formatTime(s) {
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            }

            jumpToTime(t) {
                this.video.currentTime = t;
                this.video.play();
            }

            highlightComment(element, comment) {
                document.querySelectorAll('.comment-item').forEach(el => {
                    el.classList.remove('highlighted');
                });
                element.classList.add('highlighted');
                this.currentHighlightedComment = comment;
                this.scrollToComment(element);
            }

            scrollToComment(element) {
                if (!element || this.isScrollingToComment) return;
                this.isScrollingToComment = true;
                const commentsList = document.getElementById('commentsList');
                if (commentsList) {
                    const listRect = commentsList.getBoundingClientRect();
                    const elementRect = element.getBoundingClientRect();
                    const relativeTop = elementRect.top - listRect.top + commentsList.scrollTop;
                    commentsList.scrollTo({
                        top: relativeTop - listRect.height / 2 + elementRect.height / 2,
                        behavior: 'smooth'
                    });
                }
                setTimeout(() => {
                    this.isScrollingToComment = false;
                }, 1000);
            }

            showLoading(id, show) {
                const el = document.getElementById(id);
                if (el) {
                    el.style.display = show ? 'flex' : 'none';
                }
            }

            showError(msg) {
                const el = document.getElementById('errorMessage');
                if (el) {
                    el.textContent = msg;
                    el.classList.add('active');
                    setTimeout(() => el.classList.remove('active'), 3000);
                }
            }

            async loadHotTimestamps() {
                if (!window.API || !window.API.getHotTimestamps) return;
                try {
                    const result = await window.API.getHotTimestamps(this.videoInfo.videoId);
                    if (result.code === 0 && result.data) {
                        this.hotTimestamps = result.data;
                        this.renderOverlayMarkers();
                    }
                } catch (error) {
                    console.error('加载热门时间点失败:', error);
                }
            }
        }

        function initVideoPlayer() {
            console.log('[VideoPlayer] 开始初始化，当前hash:', window.location.hash);
            const hash = window.location.hash;
            if (!hash.includes('videoUrl=')) {
                console.warn('[VideoPlayer] 缺少视频URL参数');
                return;
            }
            if (!window.videoCommentSystem) {
                window.videoCommentSystem = new VideoCommentSystem();
            } else {
                window.videoCommentSystem.loadVideoFromURL();
                if (window.videoCommentSystem.videoInfo.videoUrl) {
                    window.videoCommentSystem.video.src = window.videoCommentSystem.videoInfo.videoUrl;
                    window.videoCommentSystem.video.load();
                }
                if (window.videoCommentSystem.videoInfo.videoId) {
                    window.videoCommentSystem.comments = [];
                    window.videoCommentSystem.pagination.page = 1;
                    window.videoCommentSystem.loadCommentsFromAPI();
                }
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initVideoPlayer);
        } else {
            initVideoPlayer();
        }

        window.addEventListener('hashchange', () => {
            console.log('[VideoPlayer] hash变化:', window.location.hash);
            if (window.location.hash.includes('video-player')) {
                initVideoPlayer();
            }
        });
    </script>
</body>
</html>