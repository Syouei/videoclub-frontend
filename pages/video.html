<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频管理 - 教师视频俱乐部</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div id="page-video" class="page active">
        <!-- 顶部导航栏 -->
        <div class="header">
            <div class="header-left">
                <button class="btn btn-text" onclick="goBackToHome()" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
                <span class="platform-name" id="club-name-display">视频管理</span>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="openCreateTaskModal()" style="margin-right:15px;">
                    <i class="fas fa-plus"></i> 创建任务
                </button>
                <div class="user-info">
                    <div class="avatar" id="video-user-avatar">王</div>
                    <span id="video-user-name">王老师</span>
                </div>
            </div>
        </div>

        <!-- 视频页面主要内容 -->
        <div class="video-page-container">
            <!-- 欢迎区域 -->
            <div class="welcome-section">
                <h1 id="welcome-title">视频教学任务</h1>
                <p id="welcome-subtitle">为您的俱乐部创建和管理教学视频任务</p>
            </div>

            <!-- 任务列表区域 -->
            <div class="video-list-container" id="videoTaskList">
                <!-- 任务卡片将在这里动态生成 -->
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>暂无任务</h3>
                    <p>点击右上角"创建任务"按钮开始</p>
                </div>
            </div>

            <!-- 使用提示 -->
            <div class="usage-tips">
                <h4><i class="fas fa-lightbulb"></i> 使用提示</h4>
                <ul>
                    <li>点击"创建任务"按钮创建新的教学任务</li>
                    <li>创建任务时，需填写任务名称</li>
                    <li>点击任务卡片可以进入任务详情页</li>
                </ul>
            </div>
        </div>

        <!-- 创建任务模态框 -->
        <div id="create-task-modal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <h3 style="margin-bottom: 24px;"><i class="fas fa-plus-circle"></i> 创建新任务</h3>
                <div class="form-item">
                    <label class="required">任务名称</label>
                    <input type="text" id="new-task-name" placeholder="请输入任务名称（例如：勾股定理）">
                    <div class="error-message" id="task-name-error" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> 任务名称不能为空
                    </div>
                </div>
                <div class="form-item">
                    <label>任务描述（可选）</label>
                    <textarea id="new-task-description" placeholder="请简要描述这个任务..." rows="3"></textarea>
                </div>
                <div class="form-item">

                </div>
                <div style="text-align:right; margin-top: 24px;">
                    <button class="btn btn-outline" onclick="closeCreateTaskModal()">取消</button>
                    <button class="btn btn-primary" onclick="createNewTask()">创建任务</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentClub = null;
        let videoTasks = [];
        let currentTaskId = null;
        let videoPageInitialized = false;

        // 页面初始化
        function initVideoPage() {
            if (videoPageInitialized) return;
            videoPageInitialized = true;
            
            console.log('视频页面初始化');
            
            // 更新用户信息
            updateUserDisplay();
            
            // 获取当前俱乐部信息
            loadCurrentClub();
            
            // 加载已有任务
            loadVideoTasks();
            
            // 绑定输入框实时预览
            const nameInput = document.getElementById('new-task-name');
            const descInput = document.getElementById('new-task-description');
            
            if (nameInput) {
                nameInput.addEventListener('input', updatePreview);
            }
            if (descInput) {
                descInput.addEventListener('input', updatePreview);
            }
        }
        
        document.addEventListener('DOMContentLoaded', initVideoPage);

        // 更新用户显示
        function updateUserDisplay() {
            if (window.Auth && window.Auth.getUser()) {
                const user = window.Auth.getUser();
                const avatarElements = document.querySelectorAll('#video-user-avatar');
                const nameElements = document.querySelectorAll('#video-user-name');
                
                avatarElements.forEach(element => {
                    if (element) element.textContent = user.name.charAt(0);
                });
                nameElements.forEach(element => {
                    if (element) element.textContent = user.name;
                });
            }
        }

        // 加载当前俱乐部信息
        function loadCurrentClub() {
    console.log('正在加载当前俱乐部信息...');
    
    // 方法1：从 URL 参数获取
    const hash = window.location.hash;
    console.log('当前hash:', hash);
    
    let clubId = null;
    let clubName = '视频管理';
    
    if (hash.includes('?')) {
        const params = new URLSearchParams(hash.split('?')[1]);
        clubId = params.get('clubId');
        clubName = params.get('clubName') || '视频管理';
        
        console.log('从URL获取俱乐部ID:', clubId, '名称:', clubName);
    }
    
    // 方法2：从 Clubs 模块获取
    if (!clubId && window.Clubs && window.Clubs.getCurrentClub) {
        const clubFromModule = window.Clubs.getCurrentClub();
        if (clubFromModule) {
            currentClub = clubFromModule;
            clubId = currentClub.id || currentClub.clubId;
            clubName = currentClub.name;
        }
    }
    
    // 方法3：从本地存储获取
    if (!clubId && window.Utils) {
        const savedClub = Utils.getFromStorage('current_club');
        if (savedClub) {
            currentClub = savedClub;
            clubId = currentClub.id || currentClub.clubId;
            clubName = currentClub.name;
            console.log('从本地存储获取俱乐部:', currentClub);
        }
    }
    
    // 如果还没有俱乐部ID，尝试从 App 状态获取
    if (!clubId && window.App && window.App.state && window.App.state.currentClubId) {
        clubId = window.App.state.currentClubId;
        console.log('从App状态获取俱乐部ID:', clubId);
    }
    
    // 创建或更新当前俱乐部对象
    if (clubId) {
        // 如果 currentClub 不存在，创建它
        if (!currentClub) {
            currentClub = {
                id: parseInt(clubId),
                clubId: parseInt(clubId),
                name: decodeURIComponent(clubName)
            };
        } else {
            // 确保 currentClub 有正确的属性
            currentClub.id = parseInt(clubId);
            currentClub.clubId = parseInt(clubId);
            currentClub.name = decodeURIComponent(clubName);
        }
        
        console.log('最终确定的当前俱乐部:', currentClub);
        
        // 保存到 Clubs 模块
        if (window.Clubs && window.Clubs.setCurrentClub) {
            window.Clubs.setCurrentClub(currentClub);
        }
        
        // 保存到本地存储
        if (window.Utils) {
            Utils.saveToStorage('current_club', currentClub);
        }
    }
    
    // 更新页面显示
    const clubNameElement = document.getElementById('club-name-display');
    const welcomeTitle = document.getElementById('welcome-title');
    const welcomeSubtitle = document.getElementById('welcome-subtitle');
    
    if (clubNameElement && currentClub) {
        clubNameElement.textContent = currentClub.name;
    }
    if (welcomeTitle && currentClub) {
        welcomeTitle.textContent = `${currentClub.name} - 视频任务`;
    }
    if (welcomeSubtitle && currentClub) {
        welcomeSubtitle.textContent = `为${currentClub.name}俱乐部创建和管理教学视频任务`;
    }
    
    if (!currentClub || !currentClub.id) {
        console.warn('警告：无法确定当前俱乐部ID');
        Utils.showNotification('无法获取俱乐部信息，请返回重新选择俱乐部', 'warning');
    }
        }

        // 加载视频任务
        async function loadVideoTasks() {
            console.log('加载视频任务');
            const container = document.getElementById('videoTaskList');
            
            if (!container) return;
            
            try {
                // 尝试从API获取任务列表
                const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
                if (!clubId) {
                    console.warn('无法获取俱乐部ID');
                    return;
                }
                
                // 调用API获取任务列表
                const response = await API.getTasks(clubId);
                
                if (response && response.code === 0 && Array.isArray(response.data)) {
                    videoTasks = response.data;
                    renderVideoTasks();
                } else {
                    console.warn('没有获取到任务数据');
                    videoTasks = [];
                    renderVideoTasks();
                }
            } catch (error) {
                console.error('加载任务失败:', error);
                videoTasks = [];
                renderVideoTasks();
            }
        }

        // 渲染视频任务列表
        function renderVideoTasks() {
            const container = document.getElementById('videoTaskList');
            if (!container) return;
            
            if (!videoTasks || videoTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-tasks"></i>
                        <h3>暂无任务</h3>
                        <p>点击右上角"创建任务"按钮开始</p>
                    </div>
                `;
                return;
            }
            
            let tasksHTML = '';
            videoTasks.forEach(task => {
                const taskId = task.taskId || task.id;
                const createdTime = task.createdAt ? formatDate(task.createdAt) : '刚刚';
                const taskTypeLabel = task.type === 'watch' 
                    ? '看视频任务' 
                    : task.type === 'research' 
                        ? '研视频任务' 
                        : '视频+研讨任务';
                
                tasksHTML += `
                    <div class="video-task-card" onclick="enterTaskPage(${taskId})">
                        <div class="video-task-header">
                            <div class="video-task-title">
                                <i class="fas fa-video" style="color: #1890ff; margin-right: 8px;"></i>
                                ${task.title}
                            </div>
                            <div class="video-task-status">
                                <span class="tag" style="background: #e6f7ff; color: #096dd9;">
                                    <i class="fas fa-calendar-alt"></i> ${createdTime}
                                </span>
                            </div>
                        </div>
                        ${task.description ? `
                        <div class="video-task-description">
                            ${task.description}
                        </div>
                        ` : ''}
                        <div class="video-task-footer">
                            <div class="video-task-meta" style="color: var(--text-sub); font-size: 13px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-layer-group" style="color: #1890ff;"></i>
                                ${taskTypeLabel}
                            </div>
                            <div class="video-task-action">
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); enterTaskPage(${taskId})">
                                    <i class="fas fa-arrow-right"></i> 进入任务
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = tasksHTML;
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // 更新预览
        function updatePreview() {
            const nameInput = document.getElementById('new-task-name');
            const descInput = document.getElementById('new-task-description');
            const previewTitle = document.getElementById('preview-task-title');
            const previewDesc = document.getElementById('preview-task-description');
            
            if (nameInput && previewTitle) {
                previewTitle.textContent = nameInput.value || '任务名称将显示在这里';
            }
            
            if (descInput && previewDesc) {
                previewDesc.textContent = descInput.value || '任务描述将显示在这里';
            }
        }

        // 打开创建任务模态框
        function openCreateTaskModal() {
            const modal = document.getElementById('create-task-modal');
            if (modal) {
                modal.style.display = 'flex';
                
                // 清空输入
                const nameInput = document.getElementById('new-task-name');
                const descInput = document.getElementById('new-task-description');
                const errorElement = document.getElementById('task-name-error');
                
                if (nameInput) nameInput.value = '';
                if (descInput) descInput.value = '';
                if (errorElement) errorElement.style.display = 'none';
                
                // 更新预览
                updatePreview();
                
                // 聚焦到名称输入框
                setTimeout(() => {
                    if (nameInput) nameInput.focus();
                }, 100);
            }
        }

        // 关闭创建任务模态框
        function closeCreateTaskModal() {
            const modal = document.getElementById('create-task-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

         // 创建新任务
    async function createNewTask() {
    const nameInput = document.getElementById('new-task-name');
    const descInput = document.getElementById('new-task-description');
    
    if (!nameInput) return;
    
    const taskName = nameInput.value.trim();
    const taskDescription = descInput ? descInput.value.trim() : '';
    
    // 验证输入
    if (!taskName) {
        Utils.showNotification('请输入任务名称', 'error');
        return;
    }
    
    // 获取俱乐部ID
    let clubId = null;
    if (currentClub) {
        clubId = currentClub.id || currentClub.clubId;
    }
    
    // 如果还没有俱乐部ID，尝试从 URL 获取
    if (!clubId) {
        const hash = window.location.hash;
        if (hash.includes('?')) {
            const params = new URLSearchParams(hash.split('?')[1]);
            clubId = params.get('clubId');
        }
    }
    
    if (!clubId) {
        Utils.showNotification('无法获取俱乐部信息', 'error');
        return;
    }
    
    // 确保 clubId 是数字
    clubId = parseInt(clubId);
    
    console.log('创建任务参数:', { clubId, taskName, taskDescription });
    
    try {
        Utils.showNotification('正在创建任务...', 'info');
        
        // ⚠️ 紧急修复：直接调用 API，确保参数正确
        const result = await API.createTask({
            clubId: clubId,
            title: taskName,
            description: taskDescription,
            type: 'all'  // 明确指定 type
        });
        
        console.log('创建任务API响应:', result);
        
        if (result && result.code === 0) {
            Utils.showNotification(`任务"${taskName}"创建成功！`, 'success');
            closeCreateTaskModal();
            
            // 刷新任务列表
            await loadVideoTasks();
        } else {
            Utils.showNotification(result?.msg || '创建任务失败', 'error');
        }
    } catch (error) {
        console.error('创建任务失败:', error);
        Utils.showNotification('创建任务失败: ' + error.message, 'error');
    }
    }

    // 进入任务页面
    async function enterTaskPage(taskId) {
        console.log('进入任务页面，任务ID:', taskId);
        
        try {
            // 获取任务详情
            const taskDetail = await Tasks.getTaskDetail(taskId);
            
            if (!taskDetail) {
                Utils.showNotification('获取任务信息失败', 'error');
                return;
            }
            
            // 设置当前任务
            await Tasks.setCurrentTask(taskId);
            
            // 跳转到任务页面
            if (window.App && window.App.navigateTo) {
                window.App.navigateTo('tasks');
            } else {
                window.location.hash = 'tasks';
            }
        } catch (error) {
            console.error('进入任务页面失败:', error);
            Utils.showNotification('加载任务失败: ' + error.message, 'error');
        }
    }

        // 返回首页
        function goBackToHome() {
            if (window.App && window.App.navigateTo) {
                window.App.navigateTo('home');
            } else {
                window.location.hash = 'home';
            }
        }

        // 绑定全局函数
        window.openCreateTaskModal = openCreateTaskModal;
        window.closeCreateTaskModal = closeCreateTaskModal;
        window.createNewTask = createNewTask;
        window.enterTaskPage = enterTaskPage;
        window.goBackToHome = goBackToHome;
        window.initVideoPage = initVideoPage;
        
        // 点击模态框外部关闭
        const modal = document.getElementById('create-task-modal');
        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeCreateTaskModal();
                }
            });
        }
        
        // 立即尝试初始化（支持从home动态加载）
        initVideoPage();
    </script>

    <style>
        /* 视频页面特定样式 */
        .video-page-container {
            padding: 32px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .welcome-section {
            margin-bottom: 40px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.05), rgba(114, 46, 209, 0.05));
            border-radius: 16px;
            border-left: 4px solid var(--primary-color);
        }

        .welcome-section h1 {
            font-size: 28px;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .welcome-section p {
            font-size: 16px;
            color: var(--text-sub);
        }

        .video-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .video-task-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .video-task-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--hover-shadow);
            border-color: var(--primary-light);
        }

        .video-task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), #722ed1);
        }

        .video-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .video-task-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            flex: 1;
            display: flex;
            align-items: center;
        }

        .video-task-description {
            font-size: 14px;
            color: var(--text-sub);
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
        }

        .video-task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .video-task-subtasks {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .subtask-item {
            font-size: 13px;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        .usage-tips {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .usage-tips h4 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .usage-tips ul {
            list-style: none;
            padding-left: 0;
        }

        .usage-tips li {
            font-size: 14px;
            color: var(--text-sub);
            margin-bottom: 10px;
            padding-left: 24px;
            position: relative;
        }

        .usage-tips li:before {
            content: '•';
            color: var(--primary-color);
            font-size: 18px;
            position: absolute;
            left: 8px;
        }

        .task-preview {
            margin-top: 20px;
        }

        .task-preview h4 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-card {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 12px;
            padding: 16px;
            border: 1px dashed var(--border-color);
        }

        .preview-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .preview-description {
            font-size: 14px;
            color: var(--text-sub);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .preview-tips {
            font-size: 13px;
            color: #666;
        }

        .preview-tips p {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .preview-tips ul {
            list-style: none;
            padding-left: 20px;
            margin-top: 8px;
        }

        .preview-tips li {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .video-page-container {
                padding: 20px;
            }
            
            .video-list-container {
                grid-template-columns: 1fr;
            }
            
            .video-task-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .video-task-footer {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .video-task-action {
                align-self: flex-end;
            }
        }
    </style>
</body>
</html>
