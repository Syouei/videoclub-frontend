<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频管理 - 教师视频俱乐部</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 文件上传区域样式 */
.file-upload-area {
    border: 2px dashed #d9d9d9;
    border-radius: 12px;
    padding: 32px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #fafafa;
    margin-bottom: 12px;
}

.file-upload-area:hover {
    border-color: #1890ff;
    background: #f0f9ff;
}

.upload-placeholder {
    color: #666;
}

.upload-placeholder h4 {
    margin: 12px 0 8px;
    font-size: 16px;
    color: #333;
}

.upload-progress {
    text-align: left;
}

.file-info {
    font-size: 13px;
    color: #666;
    margin-top: 8px;
    display: flex;
    gap: 16px;
    align-items: center;
}

.btn-remove {
    padding: 4px 12px;
    background: #f5f5f5;
    color: #666;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.3s;
}

.btn-remove:hover {
    background: #ff4d4f;
    color: white;
    border-color: #ff4d4f;
}

        /* 进度条样式 */
        .progress-container {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #722ed1);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }
        
        /* 锁定状态 */
        .video-task-card.locked {
            background: #fafafa;
            border-color: #e0e0e0;
        }
        
        .video-task-card.locked .video-task-title {
            color: #999;
        }
        
        .video-task-card.locked::before {
            background: #ccc;
        }
        
        .task-lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .lock-icon {
            color: #999;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* 解锁状态标签 */
        .unlock-status-tag {
            background: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            gap: 4px;
        }
        
        .lock-status-tag {
            background: #fff2e8;
            color: #d46b08;
            border: 1px solid #ffd8bf;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            gap: 4px;
        }
        
        /* 解锁按钮样式 */
        .btn-unlock {
            padding: 4px 12px;
            background: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }
        
        .btn-unlock:hover {
            background: #52c41a;
            color: white;
            border-color: #52c41a;
        }
        
        .btn-lock {
            padding: 4px 12px;
            background: #fff2e8;
            color: #d46b08;
            border: 1px solid #ffd8bf;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }
        
        .btn-lock:hover {
            background: #ff7a45;
            color: white;
            border-color: #ff7a45;
        }
        /* ================ 修复PDF预览问题 ================ */
/* 确保预览容器占满整个模态框 */
#preview-modal .modal {
    max-width: 95vw !important;
    max-height: 95vh !important;
    width: 95vw;
    height: 95vh;
    display: flex;
    flex-direction: column;
    padding: 0 !important;
    margin: 0 !important;
}

/* 确保模态框内容占满空间 */
#preview-modal .modal-body {
    flex: 1;
    overflow: hidden;
    padding: 0 !important;
    width: 100%;
    height: 100%;
}

/* 修复PDF预览容器 - 关键！ */
#preview-content {
    width: 100% !important;
    height: 100% !important;
    display: block;
}

/* 确保embed标签占满整个预览区域 */
#preview-content embed {
    width: 100% !important;
    height: 100% !important;
    min-height: 600px; /* 确保最小高度 */
    display: block;
}

/* 视频预览同样处理 */
#preview-content video {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
}

/* 预览容器自身样式 */
.video-preview-container {
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
}

        /* 视频页面特定样式 */
        .video-page-container {
            padding: 32px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .welcome-section {
            margin-bottom: 40px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.05), rgba(114, 46, 209, 0.05));
            border-radius: 16px;
            border-left: 4px solid var(--primary-color);
        }

        .welcome-section h1 {
            font-size: 28px;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .welcome-section p {
            font-size: 16px;
            color: var(--text-sub);
        }

        .video-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .video-task-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .video-task-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--hover-shadow);
            border-color: var(--primary-light);
        }

        .video-task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), #722ed1);
        }

        .video-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .video-task-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
            flex: 1;
            display: flex;
            align-items: center;
        }

        .video-task-description {
            font-size: 14px;
            color: var(--text-sub);
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
        }

        .video-task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .video-task-subtasks {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .subtask-item {
            font-size: 13px;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        .usage-tips {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .usage-tips h4 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .usage-tips ul {
            list-style: none;
            padding-left: 0;
        }

        .usage-tips li {
            font-size: 14px;
            color: var(--text-sub);
            margin-bottom: 10px;
            padding-left: 24px;
            position: relative;
        }

        .usage-tips li:before {
            content: '•';
            color: var(--primary-color);
            font-size: 18px;
            position: absolute;
            left: 8px;
        }

        .task-preview {
            margin-top: 20px;
        }

        .task-preview h4 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-card {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 12px;
            padding: 16px;
            border: 1px dashed var(--border-color);
        }

        .preview-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .preview-description {
            font-size: 14px;
            color: var(--text-sub);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .preview-tips {
            font-size: 13px;
            color: #666;
        }

        .preview-tips p {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .preview-tips ul {
            list-style: none;
            padding-left: 20px;
            margin-top: 8px;
        }

        .preview-tips li {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .video-page-container {
                padding: 20px;
            }
            
            .video-list-container {
                grid-template-columns: 1fr;
            }
            
            .video-task-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .video-task-footer {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .video-task-action {
                align-self: flex-end;
            }
        }

        /* 锁定状态的任务卡片 */
        .video-task-card.locked {
            background: #fafafa;
            border-color: #e0e0e0;
        }

        .video-task-card.locked .video-task-title {
            color: #999;
        }

        .video-task-card.locked::before {
            background: #ccc;
        }

        .task-lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lock-icon {
            color: #999;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* 进度条样式 */
        .progress-container {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 12px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #722ed1);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }
        /* 图标按钮样式 */
.btn-icon {
    padding: 6px;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
    border: 1px solid transparent;
    cursor: pointer;
    background: #f5f5f5;
    color: #666;
}

.btn-icon:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.btn-icon-lock {
    background: #f6ffed;
    color: #389e0d;
    border-color: #b7eb8f;
}

.btn-icon-lock:hover {
    background: #52c41a;
    color: white;
    border-color: #52c41a;
}

.btn-icon-unlock {
    background: #fff2e8;
    color: #d46b08;
    border-color: #ffd8bf;
}

.btn-icon-unlock:hover {
    background: #ff7a45;
    color: white;
    border-color: #ff7a45;
}

.btn-icon.btn-warning {
    background: #fffbe6;
    color: #d48806;
    border-color: #ffe58f;
}

.btn-icon.btn-warning:hover {
    background: #ffc53d;
    color: white;
    border-color: #ffc53d;
}

.btn-icon.btn-danger {
    background: #fff2f0;
    color: #ff4d4f;
    border-color: #ffccc7;
}

.btn-icon.btn-danger:hover {
    background: #ff7875;
    color: white;
    border-color: #ff7875;
}

        /* 可选提示样式 */
        .optional-hint {
            font-size: 12px;
            color: #888;
            margin-left: 4px;
            font-weight: normal;
        }

        .upload-hint-box {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #389e0d;
        }

        .upload-hint-box i {
            font-size: 16px;
        }

        /* ================ PDF 上传区域样式 ================ */
        .pdf-upload-area {
            border: 2px dashed #d9d9d9;
            border-radius: 12px;
            padding: 28px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            margin-bottom: 12px;
        }
        .pdf-upload-area:hover {
            border-color: #722ed1;
            background: #f9f0ff;
        }
        .pdf-upload-area .upload-placeholder { color: #666; }
        .pdf-upload-area .upload-placeholder .pdf-icon { color: #722ed1; }

        /* ================ 编辑弹窗 - 已有文件展示卡片 ================ */
        .existing-file-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f6f0ff;
            border: 1px solid #d3b6ff;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
        }
        .existing-file-card .efc-icon {
            font-size: 22px;
            color: #722ed1;
            flex-shrink: 0;
        }
        .existing-file-card .efc-icon.video-icon { color: #1890ff; }
        .existing-file-card .efc-meta { flex: 1; min-width: 0; }
        .existing-file-card .efc-meta .efc-name {
            font-size: 14px; font-weight: 600; color: #333;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .existing-file-card .efc-meta .efc-label {
            font-size: 12px; color: #722ed1;
        }
        .existing-file-card .efc-meta .efc-label.video-label { color: #1890ff; }
        .existing-file-card .btn-remove-efc {
            padding: 4px 10px;
            background: #fff0f0; color: #ff4d4f;
            border: 1px solid #ffccc7; border-radius: 4px;
            font-size: 12px; cursor: pointer; white-space: nowrap;
            transition: all 0.2s;
        }
        .existing-file-card .btn-remove-efc:hover {
            background: #ff4d4f; color: white; border-color: #ff4d4f;
        }
        .existing-file-card.video-card { background: #f0f7ff; border-color: #b3d9ff; }

        /* 编辑弹窗分隔标题 */
        .edit-section-title {
            font-size: 13px; color: #888; margin: 16px 0 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .edit-section-title i { font-size: 14px; }
        
        /* ================ 修复：模态框中的文本输入框样式 ================ */
        .modal .form-item input[type="text"],
        .modal .form-item textarea,
        .modal .form-item select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        
        .modal .form-item input[type="text"]:focus,
        .modal .form-item textarea:focus,
        .modal .form-item select:focus {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
            outline: none;
        }
        
        .modal .form-item textarea {
            resize: vertical;
            min-height: 80px;
            line-height: 1.5;
        }
        
        /* 确保所有输入框对齐 */
        .modal .form-item {
            margin-bottom: 20px;
        }
        
        .modal .form-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .modal .form-item label.required::after {
            content: '*';
            color: #ff4d4f;
            margin-left: 4px;
        }
        
        /* ========== 新增：用户下拉菜单样式（与home.html相同） ========== */
        .user-info {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        
        .user-info:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }
        
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            margin-top: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            animation: fadeIn 0.2s ease;
            display: none;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-item {
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background-color: rgba(24, 144, 255, 0.08);
            color: var(--primary-color);
        }
        
        /* 注销账户选项的特殊样式 */
        .dropdown-item[onclick*="deleteAccount"]:hover {
            background-color: rgba(255, 77, 79, 0.1);
            color: #ff4d4f;
        }
        
        .dropdown-item i {
            width: 16px;
            text-align: center;
        }
        
        .profile-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff4d4f, #ff7a45);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .user-avatar-wrapper {
            position: relative;
        }
        
        .user-dropdown-header {
            padding: 16px;
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.1), rgba(114, 46, 209, 0.1));
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-dropdown-header .avatar {
            width: 40px;
            height: 40px;
            font-size: 18px;
        }
        
        .user-dropdown-header .user-info-text {
            flex: 1;
        }
        
        .user-dropdown-header .user-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }
        
        .user-dropdown-header .user-email {
            font-size: 12px;
            color: var(--text-sub);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 160px;
        }

        /* ========== 新增：通知徽章样式 ========== */
        .notification-badge {
            position: relative;
            cursor: pointer;
        }
        
        .notification-icon {
            font-size: 18px;
            color: #666;
            transition: color 0.3s ease;
            padding: 8px;
            border-radius: 8px;
        }
        
        .notification-icon:hover {
            color: #1890ff;
            background: rgba(24, 144, 255, 0.1);
        }
        
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4f;
            color: white;
            font-size: 10px;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            font-weight: bold;
            display: none; /* 默认隐藏，有通知时显示 */
        }
        
        .notification-count.high {
            background: #ff4d4f;
        }
        
        .notification-count.medium {
            background: #faad14;
        }
        
        .notification-count.low {
            background: #52c41a;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .user-info span {
                display: none;
            }
            
            .user-dropdown {
                right: -10px;
            }
        }
    </style>
</head>
<body>
    <div id="page-video" class="page active">
        <!-- 顶部导航栏 -->
        <div class="header">
            <div class="header-left">
                <button class="btn btn-text" onclick="goBackToHome()" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
                <span class="platform-name" id="club-name-display">视频管理</span>
            </div>
            <div class="header-right">
                <!-- ========== 新增：通知图标 ========== -->
                <div class="notification-badge" onclick="openNotifications()" style="margin-right: 15px; position: relative;">
                    <i class="fas fa-bell notification-icon"></i>
                    <div id="notification-badge" class="notification-count" style="display: none;">0</div>
                </div>
                
                <button class="btn btn-primary" onclick="openCreateTaskModal()" style="margin-right:15px;">
                    <i class="fas fa-plus"></i> 创建视频
                </button>
                
                <!-- ========== 修改：用户信息区域（与home.html相同） ========== -->
                <div class="user-info" id="user-info-dropdown" onclick="toggleUserDropdown(event)">
                    <div class="user-avatar-wrapper">
                        <div class="avatar" id="user-avatar">王</div>
                    </div>
                    <span id="user-name-display">王老师</span>
                    <i class="fas fa-chevron-down" style="font-size: 12px; color: #999;"></i>
                    
                    <!-- 下拉菜单 -->
                    <div class="user-dropdown" id="user-dropdown" style="display: none;">
                        <!-- 用户信息头部 -->
                        <div class="user-dropdown-header">
                            <div class="avatar" id="dropdown-user-avatar">王</div>
                            <div class="user-info-text">
                                <div class="user-name" id="dropdown-user-name">王老师</div>
                            </div>
                        </div>
                        
                        <!-- 通知中心 -->
                        <div class="dropdown-item" onclick="openNotifications()">
                            <i class="fas fa-bell"></i> 通知中心
                            <span id="dropdown-notification-count" class="profile-badge" style="display: none;">0</span>
                        </div>
                        
                        <!-- 完善个人信息 -->
                        <div class="dropdown-item" onclick="navigateToProfile()">
                            <i class="fas fa-user-edit"></i> 完善个人信息
                            <span class="profile-badge" id="profile-badge" style="display: none;">!</span>
                        </div>
                        
                        <!-- 注销账户 -->
                        <div class="dropdown-item" onclick="deleteAccount()" style="color: #ff4d4f;">
                            <i class="fas fa-user-times"></i> 注销账户
                        </div>
                        
                        <!-- 退出登录 -->
                        <div class="dropdown-item" onclick="window.App.logout()" style="color: #ff4d4f;">
                            <i class="fas fa-sign-out-alt"></i> 退出登录
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 视频页面主要内容 -->
        <div class="video-page-container">
            <!-- 欢迎区域 -->
            <div class="welcome-section">
                <h1 id="welcome-title">视频主题</h1>
                <p id="welcome-subtitle">为您的俱乐部创建和管理教学视频主题</p>
            </div>

            <!-- 任务列表区域 -->
            <div class="video-list-container" id="videoTaskList">
                <!-- 任务卡片将在这里动态生成 -->
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>暂无任务</h3>
                    <p>点击右上角"创建视频"按钮开始</p>
                </div>
            </div>

            <!-- 使用提示 -->
            <div class="usage-tips">
                <h4><i class="fas fa-lightbulb"></i> 使用提示</h4>
                <ul>
                    <li>点击"创建视频"按钮创建新的教学视频</li>
                    <li>创建视频时，需填写视频名称</li>
                    <li>点击视频卡片可以进入视频详情页</li>
                </ul>
            </div>
        </div>

        <!-- 创建任务模态框 -->
        <div id="create-task-modal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <h3 style="margin-bottom: 24px;"><i class="fas fa-plus-circle"></i> 创建新的视频主题</h3>
                
                <div class="form-item">
                    <label class="required">主题名称</label>
                    <input type="text" id="new-task-name" placeholder="请输入主题名称（例如：勾股定理）">
                    <div class="error-message" id="task-name-error" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> 主题名称不能为空
                    </div>
                </div>
                <div class="form-item">
                    <label>主题描述<span class="optional-hint">（可选）</span></label>
                    <textarea id="new-task-description" placeholder="请简要描述这个主题..." rows="4"></textarea>
                </div>

<!-- 教学视频上传（可选） -->
<div class="form-item">
    <label>点击上传教学视频<span class="optional-hint">（可选）</span></label>
    <div class="file-upload-area" id="video-upload-area">
        <input type="file" id="video-file" accept="video/*" style="display: none;">
        <div class="upload-placeholder" onclick="document.getElementById('video-file').click()">
            <i class="fas fa-video" style="font-size: 32px; color: #1890ff; margin-bottom: 12px;"></i>
            <p style="color: #999; font-size: 14px;">支持MP4、MOV等格式，最大20GB</p>
            <p style="color: #666; font-size: 12px; margin-top: 8px;">
            </p>
        </div>
        <div class="upload-progress" id="video-progress" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar" id="video-progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="video-progress-text">0%</div>
            <div class="file-info" id="video-file-info">
                <span id="video-duration-info" style="display: none;">
                    <i class="fas fa-clock"></i> 时长: <span id="video-duration">0</span>秒
                </span>
            </div>
        </div>
    </div>
    <div class="error-message" id="video-error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i> <span id="video-error-text">请上传视频文件</span>
    </div>
</div>

<!-- 资源预览 -->
<div class="form-item" id="upload-preview" style="display: none;">
    <div class="preview-container">
<!-- 视频预览项 -->
<div class="preview-item" id="video-preview">
    <div class="preview-icon">
        <i class="fas fa-video"></i>
    </div>
    <div class="preview-info">
        <div class="preview-title" id="video-preview-title"></div>
        <div class="preview-size" id="video-preview-size"></div>
        <div class="preview-duration" id="video-preview-duration"></div>
        <div class="preview-actions">
            <button class="btn-remove" onclick="removeFile('video')">
                <i class="fas fa-times"></i> 移除
            </button>
        </div>
    </div>
</div>
    </div>
</div>

<!-- ===== 说课视频上传（可选） ===== -->
<div class="form-item">
    <label>点击上传说课视频<span class="optional-hint">（可选）</span></label>
    <div class="file-upload-area" id="explain-video-upload-area" style="border-color: #faad14;">
        <input type="file" id="explain-video-file" accept="video/*" style="display: none;">
        <div class="upload-placeholder" onclick="document.getElementById('explain-video-file').click()">
            <i class="fas fa-microphone-alt" style="font-size: 32px; color: #faad14; margin-bottom: 12px;"></i>
            <h4 style="margin: 8px 0 4px; font-size: 15px; color: #333;">点击上传说课视频（可选）</h4>
            <p style="color: #999; font-size: 13px;">支持MP4、MOV等格式，最大2GB</p>
            <p style="color: #faad14; font-size: 12px; margin-top: 8px;">
                <i class="fas fa-info-circle"></i> 可选：教师讲解教学设计的说课视频
            </p>
        </div>
        <div class="upload-progress" id="explain-video-progress" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar" id="explain-video-progress-bar" style="width: 0%; background: linear-gradient(90deg, #faad14, #ffc53d);"></div>
            </div>
            <div class="progress-text" id="explain-video-progress-text">0%</div>
            <div class="file-info" id="explain-video-file-info">
                <span id="explain-video-duration-info" style="display: none;">
                    <i class="fas fa-clock"></i> 时长: <span id="explain-video-duration">0</span>秒
                </span>
            </div>
        </div>
    </div>
    <div class="error-message" id="explain-video-error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i> <span id="explain-video-error-text"></span>
    </div>
</div>

<!-- 说课视频预览项 -->
<div class="form-item" id="explain-video-upload-preview" style="display: none;">
    <div class="preview-container">
        <div class="preview-item" id="explain-video-preview" style="display:none; border-left-color: #faad14;">
            <div class="preview-icon" style="color:#faad14;">
                <i class="fas fa-microphone-alt"></i>
            </div>
            <div class="preview-info">
                <div class="preview-title" id="explain-video-preview-title"></div>
                <div class="preview-size" id="explain-video-preview-size"></div>
                <div class="preview-duration" id="explain-video-preview-duration"></div>
                <div class="preview-actions">
                    <button class="btn-remove" onclick="removeFile('explain-video')">
                        <i class="fas fa-times"></i> 移除
                    </button>
                    <button class="btn-preview" onclick="previewFile('explain-video')" style="margin-left: 8px;">
                        <i class="fas fa-eye"></i> 预览
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== 教学设计案例PDF上传 ===== -->
<div class="form-item">
    <label>上传教学设计案例（PDF）<span class="optional-hint">（可选）</span></label>
    <div class="pdf-upload-area" id="pdf-upload-area">
        <input type="file" id="pdf-file" accept=".pdf" style="display: none;">
        <div class="upload-placeholder" onclick="document.getElementById('pdf-file').click()">
            <i class="fas fa-file-pdf pdf-icon" style="font-size: 32px; margin-bottom: 12px;"></i>
            <h4 style="margin: 8px 0 4px; font-size: 15px; color: #333;">点击上传 PDF 文件</h4>
            <p style="color: #999; font-size: 13px;">仅支持 PDF 格式</p>
        </div>
        <div class="upload-progress" id="pdf-progress" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar" id="pdf-progress-bar" style="width: 0%; background: linear-gradient(90deg, #722ed1, #a855f7);"></div>
            </div>
            <div class="progress-text" id="pdf-progress-text">0%</div>
            <div class="file-info" id="pdf-file-info"></div>
        </div>
    </div>
    <div class="error-message" id="pdf-error" style="display: none;">
        <i class="fas fa-exclamation-circle"></i> <span id="pdf-error-text">请上传PDF文件</span>
    </div>
</div>
<!-- PDF 预览项 -->
<div class="form-item" id="pdf-upload-preview" style="display: none;">
    <div class="preview-container">
        <div class="preview-item" id="pdf-preview" style="display:none;">
            <div class="preview-icon" style="color:#722ed1;">
                <i class="fas fa-file-pdf"></i>
            </div>
            <div class="preview-info">
                <div class="preview-title" id="pdf-preview-title"></div>
                <div class="preview-size" id="pdf-preview-size"></div>
                <div class="preview-actions">
                    <button class="btn-remove" onclick="removeFile('pdf')">
                        <i class="fas fa-times"></i> 移除
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="preview-modal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 95%; max-height: 95%;">
        <div class="modal-header">
            <h3 id="preview-title">文件预览</h3>
            <button class="btn-close" onclick="closePreview()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="preview-content" style="flex:1;overflow:hidden;">
            <!-- 预览内容将动态插入到这里 -->
        </div>
    </div>
</div>
                <div style="text-align:right; margin-top: 24px;">
                    <button class="btn btn-outline" onclick="closeCreateTaskModal()">取消</button>
                    <button class="btn btn-primary" onclick="createNewVideo()">创建视频</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentClub = null;
        let videoTasks = [];
        let currentTaskId = null;
        let videoPageInitialized = false;
        let isClubCreator = false; // 新增：是否是俱乐部创建者
        let uploadedVideoId = null; // 新增：保存上传后的视频ID
        let uploadedPdfId = null;   // 新增：保存上传后的PDF ID
        let uploadedExplainVideoId = null; // 新增：保存上传后的说课视频ID
        
        // ========== 用户下拉菜单功能（与home.html相同） ==========
        let userDropdownOpen = false;
        let userProfileCompletion = 0;
        
        // 切换用户下拉菜单
        function toggleUserDropdown(event) {
            event.preventDefault();
            event.stopPropagation();
            
            console.log('切换用户下拉菜单');
            const dropdown = document.getElementById('user-dropdown');
            if (!dropdown) return;
            
            if (userDropdownOpen) {
                dropdown.style.display = 'none';
                userDropdownOpen = false;
            } else {
                dropdown.style.display = 'block';
                userDropdownOpen = true;
                
                // 更新下拉菜单中的用户信息
                updateDropdownUserInfo();
                
                // 检查个人资料完成度
                checkProfileCompletion();
            }
        }
        
        // 关闭用户下拉菜单（点击外部）
        function closeUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
                userDropdownOpen = false;
            }
        }
        
        // 点击页面其他地方关闭下拉菜单
        document.addEventListener('click', function(event) {
            const userInfo = document.getElementById('user-info-dropdown');
            const dropdown = document.getElementById('user-dropdown');
            
            if (userInfo && !userInfo.contains(event.target) && 
                dropdown && dropdown.style.display === 'block') {
                closeUserDropdown();
            }
        });
        
        // 更新下拉菜单中的用户信息
        function updateDropdownUserInfo() {
            console.log('更新下拉菜单用户信息');
            if (!window.Auth || !window.Auth.getUser()) return;
            
            const user = window.Auth.getUser();
            console.log('当前用户:', user);
            
            // 更新下拉菜单中的头像
            const dropdownAvatar = document.getElementById('dropdown-user-avatar');
            if (dropdownAvatar) {
                const firstName = user.name ? user.name.charAt(0) : '?';
                dropdownAvatar.textContent = firstName;
            }
            
            // 更新下拉菜单中的用户名
            const dropdownName = document.getElementById('dropdown-user-name');
            if (dropdownName) {
                dropdownName.textContent = user.name || user.username || '用户';
            }
            
            // 更新下拉菜单中的邮箱
            const dropdownEmail = document.getElementById('dropdown-user-email');
            if (dropdownEmail && user.email) {
                dropdownEmail.textContent = user.email;
            }
        }
        
        // 检查个人资料完成度
        function checkProfileCompletion() {
            console.log('检查个人资料完成度');
            if (!window.Profile) {
                console.warn('Profile模块未加载');
                return;
            }
            
            try {
                // 获取个人资料
                const profileData = window.Profile.getUserProfile();
                console.log('个人资料数据:', profileData);
                
                if (!profileData || Object.keys(profileData).length === 0) {
                    // 没有个人资料，显示提醒
                    showProfileReminder();
                    userProfileCompletion = 0;
                } else {
                    // 计算完成度
                    userProfileCompletion = calculateProfileCompletion(profileData);
                    console.log('个人资料完成度:', userProfileCompletion + '%');
                    
                    // 根据完成度显示不同状态
                    updateCompletionBadge(userProfileCompletion);
                    
                    // 如果完成度低，显示提醒
                    if (userProfileCompletion < 80) {
                        showProfileReminder();
                    } else {
                        hideProfileReminder();
                    }
                }
                
            } catch (error) {
                console.error('检查个人资料完成度失败:', error);
            }
        }
        
        // 计算个人资料完成度
        function calculateProfileCompletion(profileData) {
            if (!profileData) return 0;
            
            const requiredFields = (window.AppConfig &&
                Array.isArray(AppConfig.USER_INFO_FIELDS?.required) &&
                AppConfig.USER_INFO_FIELDS.required.length > 0)
                ? AppConfig.USER_INFO_FIELDS.required
                : ['realname', 'gender', 'age', 'school', 'phone', 'email'];
            let completedCount = 0;
            
            requiredFields.forEach(field => {
                if (profileData[field] && profileData[field].toString().trim() !== '') {
                    completedCount++;
                }
            });
            
            return Math.round((completedCount / requiredFields.length) * 100);
        }
        
        // 显示个人资料提醒
        function showProfileReminder() {
            const badge = document.getElementById('profile-badge');
            if (badge) {
                badge.style.display = 'inline-block';
                badge.textContent = userProfileCompletion === 0 ? '!' : '!';
            }
        }
        
        // 隐藏个人资料提醒
        function hideProfileReminder() {
            const badge = document.getElementById('profile-badge');
            if (badge) {
                badge.style.display = 'none';
            }
        }
        
        // 更新完成度徽章显示
        function updateCompletionBadge(completion) {
            const badge = document.getElementById('profile-badge');
            if (!badge) return;
            
            if (completion >= 80) {
                badge.style.display = 'none';
                return;
            }
            
            badge.style.display = 'inline-block';
            badge.textContent = completion === 0 ? '!' : `${completion}%`;
        }
        
        // 导航到个人资料页面
        function navigateToProfile() {
            console.log('导航到个人资料页面');
            closeUserDropdown();
            
            if (window.App && window.App.navigateTo) {
                window.App.navigateTo('profile');
            } else {
                window.location.hash = 'profile';
            }
        }
        
        // 注销账户（永久删除用户）
        async function deleteAccount() {
            console.log('用户请求注销账户');
            closeUserDropdown();
            
            // 获取当前用户信息
            const currentUser = window.Auth && window.Auth.getUser ? window.Auth.getUser() : null;
            const username = currentUser ? (currentUser.username || currentUser.name || '当前账户') : '当前账户';
            
            // 第一次确认
            const firstConfirm = confirm(
                `⚠️ 警告：注销账户操作\n\n` +
                `您确定要永久注销账户 "${username}" 吗？\n\n` +
                `注销后将会：\n` +
                `• 永久删除您的账户和所有个人信息\n` +
                `• 退出所有已加入的俱乐部\n` +
                `• 删除所有任务记录和评论\n` +
                `• 此操作不可恢复！\n\n` +
                `是否继续？`
            );
            
            if (!firstConfirm) {
                console.log('用户取消了第一次确认');
                return;
            }
            
            // 第二次确认
            const secondConfirm = confirm(
                `⚠️ 最后确认\n\n` +
                `请再次确认：您真的要永久删除账户 "${username}" 吗？\n\n` +
                `这是最后一次确认，点击"确定"后账户将被立即删除且无法恢复！`
            );
            
            if (!secondConfirm) {
                console.log('用户取消了第二次确认');
                return;
            }
            
            try {
                // 这里可以调用API删除账户
                console.log('执行注销账户操作');
                
                // 显示成功消息
                alert('账户注销成功！');
                
            } catch (error) {
                console.error('注销账户失败:', error);
                alert('注销账户失败: ' + error.message);
            }
        }
        
        // ========== 通知相关功能 ==========
        
        // 打开通知页面
        function openNotifications() {
            console.log('打开通知中心');
            closeUserDropdown();
            
            if (window.App && window.App.navigateToNotifications) {
                window.App.navigateToNotifications();
            } else {
                window.location.hash = 'notifications';
            }
        }
        
        // 更新通知徽章
        function updateNotificationBadge() {
            console.log('更新通知徽章');
            
            const notificationBadge = document.getElementById('notification-badge');
            const dropdownBadge = document.getElementById('dropdown-notification-count');
            
            if (window.App && window.App.state) {
                const count = window.App.state.unreadNotificationCount || 0;
                
                if (notificationBadge) {
                    if (count > 0) {
                        notificationBadge.textContent = count > 99 ? '99+' : count.toString();
                        notificationBadge.style.display = 'flex';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }
                
                if (dropdownBadge) {
                    if (count > 0) {
                        dropdownBadge.textContent = count > 99 ? '99+' : count.toString();
                        dropdownBadge.style.display = 'inline-block';
                    } else {
                        dropdownBadge.style.display = 'none';
                    }
                }
            }
        }
        
        // 页面初始化时更新用户显示
        function updateUserDisplay() {
            if (window.Auth && window.Auth.getUser()) {
                const user = window.Auth.getUser();
                const avatarElements = document.querySelectorAll('#user-avatar, #dropdown-user-avatar');
                const nameElements = document.querySelectorAll('#user-name-display, #dropdown-user-name');
                
                avatarElements.forEach(element => {
                    if (element) element.textContent = user.name.charAt(0);
                });
                nameElements.forEach(element => {
                    if (element) element.textContent = user.name;
                });
            }
        }
        
        // 页面初始化
        function initVideoPage() {
    if (!videoPageInitialized) {
        videoPageInitialized = true;
        console.log('视频页面初始化');
        updateUserDisplay();
        loadCurrentClub();
        initFileUpload();
        window.isVideoPage = true;
    }
    // 每次进页面都重新拉数据
    loadVideoTasks();
    setTimeout(() => {
        updatePermissionBasedUI();
    }, 100);
}

        // ================ 文件上传处理 ================

// 计算文件的ETag
// 使用文件名+大小+修改时间的组合作为文件标识符，避免依赖Web Crypto API
async function calculateETag(file) {
  try {
    // 检查 Web Crypto API 是否可用（仅在HTTPS或localhost下可用）
    if (window.crypto && window.crypto.subtle) {
      // 方法1：使用 SHA-256 哈希（更安全，但需要HTTPS）
      const maxBytes = Math.min(file.size, 1024 * 1024);
      const blob = file.slice(0, maxBytes);
      const arrayBuffer = await blob.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      const etag = `${hashHex}-${file.size}`;
      console.log('使用 SHA-256 计算 ETag:', etag);
      return etag;
    } else {
      // 方法2：降级方案 - 使用文件名+大小+修改时间（兼容HTTP）
      console.warn('Web Crypto API 不可用，使用降级方案计算 ETag');
      const fileInfo = [
        file.name,
        file.size,
        file.lastModified || Date.now(),
        file.type || ''
      ].join('|');
      
      // 使用简单的字符串哈希
      let hash = 0;
      for (let i = 0; i < fileInfo.length; i++) {
        const char = fileInfo.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // 转为32位整数
      }
      
      // 转为16进制字符串
      const hashHex = Math.abs(hash).toString(16).padStart(16, '0');
      const etag = `${hashHex}-${file.size}`;
      console.log('使用降级方案计算 ETag:', etag);
      return etag;
    }
  } catch (error) {
    // 统一错误捕获：所有异步/同步错误都会被捕获，避免Promise pending
    console.error('计算ETag失败:', error);
    throw new Error(`计算ETag失败：${error.message}`);
  }
}


// 初始化文件上传
function initFileUpload() {
    const videoFileInput = document.getElementById('video-file');
    
    if (videoFileInput) {
        videoFileInput.addEventListener('change', function(e) {
            handleFileSelect(e, 'video');
        });
    }

    const pdfFileInput = document.getElementById('pdf-file');
    if (pdfFileInput) {
        pdfFileInput.addEventListener('change', function(e) {
            handleFileSelect(e, 'pdf');
        });
    }

    // 新增：说课视频文件选择事件
    const explainVideoFileInput = document.getElementById('explain-video-file');
    if (explainVideoFileInput) {
        explainVideoFileInput.addEventListener('change', function(e) {
            handleFileSelect(e, 'explain-video');
        });
    }
}

// 处理文件选择
async function handleFileSelect(event, fileType) {
    const file = event.target.files[0];
    if (!file) return;
    
    // 清除错误提示
    const uploadArea = document.getElementById(`${fileType}-upload-area`);
    const errorDiv = document.getElementById(`${fileType}-error`);
    if (uploadArea) {
        uploadArea.style.borderColor = '';
        uploadArea.style.background = '';
    }
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
    
    // 验证文件类型和大小
    if (!validateFile(file, fileType)) {
        return;
    }
    
    // 显示文件信息和上传进度区域
    showFileInfo(file, fileType);
    
    // 如果是视频，进行真实上传流程
    if (fileType === 'video') {
        try {
            const duration = await getVideoDuration(file);
            // 可选：更新UI显示时长（如果元素存在）
            const durationEl = document.getElementById('video-duration');
            const durationInfoEl = document.getElementById('video-duration-info');
            if (durationEl) durationEl.textContent = duration;
            if (durationInfoEl) durationInfoEl.style.display = 'inline';
            
            // 开始真实上传流程
            await uploadVideo(file, duration);
        } catch (error) {
            console.error('视频处理失败:', error);
            showFileError('video', '视频处理失败: ' + error.message);
        }
    }

    // 如果是说课视频，进行上传流程
    if (fileType === 'explain-video') {
        try {
            const duration = await getVideoDuration(file);
            const durationEl = document.getElementById('explain-video-duration');
            const durationInfoEl = document.getElementById('explain-video-duration-info');
            if (durationEl) durationEl.textContent = duration;
            if (durationInfoEl) durationInfoEl.style.display = 'inline';
            
            // 开始真实上传流程（可选，所以不阻塞其他操作）
            uploadExplainVideo(file, duration).catch(error => {
                console.warn('说课视频上传失败（不影响创建）:', error);
            });
        } catch (error) {
            console.error('说课视频处理失败:', error);
            // 可选功能，不显示错误
        }
    }

    // 如果是PDF，进行上传流程
    if (fileType === 'pdf') {
        try {
            await uploadPdf(file);
        } catch (error) {
            console.error('PDF处理失败:', error);
            showFileError('pdf', 'PDF上传失败: ' + error.message);
        }
    }
}

// 真实视频上传流程
async function uploadVideo(file, duration) {
    const fileType = 'video';
    
    // 如果已经有上传成功的视频ID，不再重复上传
    if (uploadedVideoId) {
        console.log('视频已上传，使用已有的videoId:', uploadedVideoId);
        Utils.showNotification('视频已上传，无需重复上传', 'info');
        return;
    }
    
    try {
        // 步骤1: 计算ETag
        Utils.showNotification('正在计算文件特征...', 'info');
        const etag = await calculateETag(file);
        console.log('文件ETag:', etag);
        
        // 步骤2: 秒传检测
        Utils.showNotification('正在进行秒传检测...', 'info');
        const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
        
        // 使用直接 fetch 调用，绕过 API.request 的错误处理，以便正确处理 code=1
        let fastUploadResult = null;
        let isNetworkError = false;
        try {
            const config = window.AppConfig;
            const token = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);
            
            const response = await fetch(config.API_BASE_URL + '/videos/fast-upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    clubId: clubId,
                    title: file.name,
                    etag: etag,
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status}`);
            }
            
            fastUploadResult = await response.json();
            console.log('秒传检测结果:', fastUploadResult);
        } catch (error) {
            // 只有网络错误才会到这里，业务错误 code=1 不会抛异常
            console.warn('秒传检测请求失败，继续正常上传:', error);
            isNetworkError = true;
            Utils.showNotification('秒传检测不可用，继续正常上传...', 'warning');
        }
        
        // 处理秒传检测结果
        if (fastUploadResult && fastUploadResult.code === 0) {
            // 秒传成功，直接使用返回的videoId
            if (fastUploadResult.data && fastUploadResult.data.videoId) {
                uploadedVideoId = fastUploadResult.data.videoId;
                console.log('秒传成功，videoId:', uploadedVideoId);
                showUploadComplete(fileType);
                Utils.showNotification('秒传成功！视频已存在', 'success');
                return;
            }
        }
        
        // code=1 或其他非0 code 表示需要上传，这是正常流程，不显示错误
        if (!isNetworkError) {
            console.log('秒传检测未通过（code=' + (fastUploadResult?.code || 'N/A') + '），继续正常上传流程');
        }
        Utils.showNotification('秒传检测未通过，准备上传...', 'info');
        
        // 步骤3: 获取上传凭证
        const tokenResult = await API.getUploadToken();
        if (!tokenResult || tokenResult.code !== 0) {
            throw new Error(tokenResult?.msg || '获取上传凭证失败');
        }
        
        const uploadData = tokenResult.data;
        console.log('上传凭证:', uploadData);
        
        // 生成唯一的 objectKey
        const objectKey = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.mp4`;
        console.log('生成的 objectKey:', objectKey);
        
        // 步骤4: 使用七牛云表单上传
        await uploadToQiniu(file, uploadData, objectKey, fileType, (progress) => {
            // 更新进度条
            const progressBar = document.getElementById(`${fileType}-progress-bar`);
            const progressText = document.getElementById(`${fileType}-progress-text`);
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.textContent = `${Math.round(progress)}%`;
        });
        
        // 步骤5: 保存视频信息
        Utils.showNotification('正在保存视频信息...', 'info');
        const saveResult = await API.saveVideoInfo({
            clubId: clubId,
            title: file.name,
            objectKey: objectKey,
            etag: etag,
            duration: duration,
            bucket: uploadData.bucket,
            region: uploadData.region,
            fileSize: file.size,
            mimeType: file.type
        });
        
        if (saveResult && saveResult.code === 0) {
            uploadedVideoId = saveResult.data?.videoId;
            console.log('视频保存成功，videoId:', uploadedVideoId);
            showUploadComplete(fileType);
            Utils.showNotification('视频上传成功！', 'success');
        } else {
            throw new Error(saveResult?.msg || '保存视频信息失败');
        }
        
    } catch (error) {
        console.error('视频上传失败:', error);
        showFileError(fileType, '上传失败: ' + error.message);
        throw error;
    }
}

// 说课视频上传流程（可选）
async function uploadExplainVideo(file, duration) {
    const fileType = 'explain-video';
    
    // 如果已经有上传成功的说课视频ID，不再重复上传
    if (uploadedExplainVideoId) {
        console.log('说课视频已上传，使用已有的videoId:', uploadedExplainVideoId);
        return;
    }
    
    try {
        // 步骤1: 计算ETag
        const etag = await calculateETag(file);
        console.log('说课视频文件ETag:', etag);
        
        // 步骤2: 秒传检测
        const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
        
        let fastUploadResult = null;
        let isNetworkError = false;
        try {
            const config = window.AppConfig;
            const token = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);
            
            const response = await fetch(config.API_BASE_URL + '/videos/fast-upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    clubId: clubId,
                    title: file.name,
                    etag: etag,
                    videoType: 'explain' // 可选：区分说课视频类型
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP错误: ${response.status}`);
            }
            
            fastUploadResult = await response.json();
            console.log('说课视频秒传检测结果:', fastUploadResult);
        } catch (error) {
            console.warn('说课视频秒传检测请求失败，继续正常上传:', error);
            isNetworkError = true;
        }
        
        // 处理秒传检测结果
        if (fastUploadResult && fastUploadResult.code === 0) {
            if (fastUploadResult.data && fastUploadResult.data.videoId) {
                uploadedExplainVideoId = fastUploadResult.data.videoId;
                console.log('说课视频秒传成功，videoId:', uploadedExplainVideoId);
                showUploadComplete(fileType);
                return;
            }
        }
        
        // 步骤3: 获取上传凭证
        const tokenResult = await API.getUploadToken();
        if (!tokenResult || tokenResult.code !== 0) {
            throw new Error(tokenResult?.msg || '获取上传凭证失败');
        }
        
        const uploadData = tokenResult.data;
        
        // 生成唯一的 objectKey
        const objectKey = `explain_video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}.mp4`;
        console.log('说课视频 objectKey:', objectKey);
        
        // 步骤4: 使用七牛云表单上传
        await uploadToQiniu(file, uploadData, objectKey, fileType, (progress) => {
            const progressBar = document.getElementById(`${fileType}-progress-bar`);
            const progressText = document.getElementById(`${fileType}-progress-text`);
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.textContent = `${Math.round(progress)}%`;
        });
        
        // 步骤5: 保存视频信息
        const saveResult = await API.saveVideoInfo({
            clubId: clubId,
            title: file.name,
            objectKey: objectKey,
            etag: etag,
            duration: duration,
            bucket: uploadData.bucket,
            region: uploadData.region,
            fileSize: file.size,
            mimeType: file.type,
            videoType: 'explain' // 区分说课视频
        });
        
        if (saveResult && saveResult.code === 0) {
            uploadedExplainVideoId = saveResult.data?.videoId;
            console.log('说课视频保存成功，videoId:', uploadedExplainVideoId);
            showUploadComplete(fileType);
        } else {
            throw new Error(saveResult?.msg || '保存说课视频信息失败');
        }
        
    } catch (error) {
        console.error('说课视频上传失败:', error);
        // 可选功能，不显示错误提示
    }
}

// 上传到七牛云（表单上传方式）
async function uploadToQiniu(file, uploadData, objectKey, fileType, onProgress) {
    return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('token', uploadData.uploadToken);
        formData.append('key', objectKey);
        formData.append('file', file);

        // 七牛云上传域名（根据region选择）
        const region = uploadData.region || 'z1';
        const regionUploadUrls = {
            'z0': 'https://up.qiniup.com',
            'z1': 'https://up-z1.qiniup.com',
            'z2': 'https://up-z2.qiniup.com',
            'na0': 'https://up-na0.qiniup.com',
            'as0': 'https://up-as0.qiniup.com',
            'cn-east-2': 'https://up-cn-east-2.qiniup.com',
        };
        const uploadUrl = uploadData.uploadUrl || regionUploadUrls[region] || `https://up-z1.qiniup.com`;

        console.log('七牛云上传配置:', { region, uploadUrl });

        const xhr = new XMLHttpRequest();

        // 进度监听
        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const progress = (e.loaded / e.total) * 100;
                onProgress(progress);
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                console.log('七牛云上传成功:', response);
                onProgress(100);
                resolve(response);
            } else {
                reject(new Error(`上传失败: ${xhr.status} ${xhr.statusText}`));
            }
        };

        xhr.onerror = () => {
            reject(new Error('上传请求失败'));
        };

        xhr.onabort = () => {
            reject(new Error('上传已取消'));
        };

        xhr.open('POST', uploadUrl);
        xhr.send(formData);
    });
}

// ================ PDF 上传流程（仿照视频上传，路径用 /pdfs/） ================
// TODO: 后端接口确认后，将以下路径与参数与实际对齐。
//   目前约定：
//     秒传检测  POST  /pdfs/fast-upload   body: { clubId, title, etag }
//     获取凭证  GET   /pdfs/token
//     保存信息  POST  /pdfs              body: { clubId, title, objectKey, etag, bucket, region, fileSize, mimeType }
//   响应结构与视频模块一致，成功返回 { code:0, data:{ pdfId } }

async function uploadPdf(file) {
    if (uploadedPdfId) {
        console.log('PDF已上传，使用已有的pdfId:', uploadedPdfId);
        Utils.showNotification('PDF已上传，无需重复上传', 'info');
        return;
    }

    try {
        // 步骤1: 计算ETag
        Utils.showNotification('正在计算文件特征...', 'info');
        const etag = await calculateETag(file);
        console.log('PDF文件ETag:', etag);

        const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;

        // 步骤2: 秒传检测
        Utils.showNotification('正在进行秒传检测...', 'info');
        let fastUploadResult = null;
        let isNetworkError = false;
        try {
            const config = window.AppConfig;
            const token = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);
            const response = await fetch(config.API_BASE_URL + '/resources/fast-upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    clubId: clubId,
                    title: file.name,
                    filename: file.name,
                    etag: etag
                })
            });
            if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
            fastUploadResult = await response.json();
            console.log('PDF秒传检测结果:', fastUploadResult);
        } catch (error) {
            console.warn('PDF秒传检测请求失败，继续正常上传:', error);
            isNetworkError = true;
            Utils.showNotification('秒传检测不可用，继续正常上传...', 'warning');
        }

        // 处理秒传结果
        if (fastUploadResult && fastUploadResult.code === 0) {
            if (fastUploadResult.data && fastUploadResult.data.resourceId) {
                uploadedPdfId = fastUploadResult.data.resourceId;
                console.log('PDF秒传成功，resourceId:', uploadedPdfId);
                showUploadComplete('pdf');
                Utils.showNotification('秒传成功！PDF已存在', 'success');
                return;
            }
        }
        if (!isNetworkError) {
            console.log('PDF秒传未通过（code=' + (fastUploadResult?.code || 'N/A') + '），继续上传');
        }
        Utils.showNotification('准备上传PDF...', 'info');

        // 步骤3: 获取上传凭证
        const config = window.AppConfig;
        const authToken = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);
        const tokenResponse = await fetch(config.API_BASE_URL + '/resources/token', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            }
        });
        if (!tokenResponse.ok) {
            throw new Error('获取上传凭证失败');
        }
        const tokenResult = await tokenResponse.json();
        if (!tokenResult || tokenResult.code !== 0) {
            throw new Error(tokenResult?.msg || '获取上传凭证失败');
        }
        const uploadData = tokenResult.data;
        console.log('上传凭证:', uploadData);

        // 生成唯一 objectKey (使用resource前缀)
        const objectKey = `resource/${etag}/${file.name}`;
        console.log('生成的资源 objectKey:', objectKey);

        // 步骤4: 上传到七牛云
        await uploadToQiniu(file, uploadData, objectKey, 'pdf', (progress) => {
            const progressBar = document.getElementById('pdf-progress-bar');
            const progressText = document.getElementById('pdf-progress-text');
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.textContent = `${Math.round(progress)}%`;
        });

        // 步骤5: 保存资源信息到后端
        Utils.showNotification('正在保存资源信息...', 'info');
        const saveResponse = await fetch(config.API_BASE_URL + '/resources', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
                clubId: clubId,
                title: file.name,
                filename: file.name,
                objectKey: objectKey,
                etag: etag,
                bucket: uploadData.bucket,
                region: uploadData.region,
                fileSize: file.size,
                mimeType: file.type  // application/pdf
            })
        });
        const saveResult = await saveResponse.json();
        console.log('保存资源信息响应:', saveResult);

        if (saveResult && saveResult.code === 0) {
            uploadedPdfId = saveResult.data?.resourceId;
            console.log('资源保存成功，resourceId:', uploadedPdfId);
            showUploadComplete('pdf');
            Utils.showNotification('PDF上传成功！', 'success');
        } else {
            throw new Error(saveResult?.msg || '保存资源信息失败');
        }

    } catch (error) {
        console.error('PDF上传失败:', error);
        showFileError('pdf', '上传失败: ' + error.message);
        throw error;
    }
}

// ================ 编辑弹窗内的动态上传（用于编辑任务时上传新视频/PDF） ================
// 编辑弹窗中的视频上传（与创建流程一致，结果写入 editUploadedVideoId）
let editUploadedVideoId = null;
let editUploadedPdfId = null;

async function handleEditFileSelect(event, fileType) {
    const file = event.target.files[0];
    if (!file) return;
    if (!validateFile(file, fileType)) return;

    // 显示对应的进度区域
    const progressContainer = document.getElementById(`edit-${fileType}-progress-container`);
    const placeholderEl = document.getElementById(`edit-${fileType}-placeholder`);
    if (placeholderEl) placeholderEl.style.display = 'none';
    if (progressContainer) progressContainer.style.display = 'block';

    try {
        if (fileType === 'video') {
            const duration = await getVideoDuration(file);
            await uploadEditFile(file, 'video', duration);
        } else {
            await uploadEditFile(file, 'pdf');
        }
    } catch (error) {
        console.error(`编辑弹窗 ${fileType} 上传失败:`, error);
        Utils.showNotification(`${fileType === 'video' ? '视频' : 'PDF'} 上传失败: ` + error.message, 'error');
        // 恢复占位符
        if (placeholderEl) placeholderEl.style.display = 'block';
        if (progressContainer) progressContainer.style.display = 'none';
    }
}

async function uploadEditFile(file, fileType, duration) {
    const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
    const etag = await calculateETag(file);

    // 秒传检测
    const apiPath = fileType === 'video' ? '/videos/fast-upload' : '/resources/fast-upload';
    const config = window.AppConfig;
    const token = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);
    let fastResult = null;
    try {
        const requestBody = fileType === 'video' 
            ? { clubId, title: file.name, etag }
            : { clubId, title: file.name, filename: file.name, etag };
        const resp = await fetch(config.API_BASE_URL + apiPath, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(requestBody)
        });
        if (resp.ok) fastResult = await resp.json();
    } catch (e) { console.warn('编辑弹窗秒传检测失败:', e); }

    const idKey = fileType === 'video' ? 'videoId' : 'resourceId';
    if (fastResult && fastResult.code === 0 && fastResult.data?.[idKey]) {
        if (fileType === 'video') editUploadedVideoId = fastResult.data.videoId;
        else editUploadedPdfId = fastResult.data.resourceId;
        showEditUploadComplete(fileType, file.name);
        Utils.showNotification('秒传成功！', 'success');
        return;
    }

    // 获取凭证并上传
    let uploadData;
    if (fileType === 'video') {
        const tokenResult = await API.getUploadToken();
        if (!tokenResult || tokenResult.code !== 0) throw new Error(tokenResult?.msg || '获取上传凭证失败');
        uploadData = tokenResult.data;
    } else {
        // PDF使用资源上传凭证
        const tokenResp = await fetch(config.API_BASE_URL + '/resources/token', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
        });
        if (!tokenResp.ok) throw new Error('获取上传凭证失败');
        const tokenResult = await tokenResp.json();
        if (!tokenResult || tokenResult.code !== 0) throw new Error(tokenResult?.msg || '获取上传凭证失败');
        uploadData = tokenResult.data;
    }
    
    const ext = fileType === 'video' ? '.mp4' : '.pdf';
    const objectKey = fileType === 'video' 
        ? `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}${ext}`
        : `resource/${etag}/${file.name}`;

    await uploadToQiniu(file, uploadData, objectKey, fileType, (progress) => {
        const bar = document.getElementById(`edit-${fileType}-progress-bar`);
        const txt = document.getElementById(`edit-${fileType}-progress-text`);
        if (bar) bar.style.width = `${progress}%`;
        if (txt) txt.textContent = `${Math.round(progress)}%`;
    });

    // 保存信息
    const savePath = fileType === 'video' ? '/videos' : '/resources';
    const body = {
        clubId, 
        title: file.name, 
        objectKey, 
        etag,
        bucket: uploadData.bucket, 
        region: uploadData.region,
        fileSize: file.size, 
        mimeType: file.type
    };
    if (fileType === 'video' && duration != null) {
        body.duration = duration;
    } else if (fileType === 'pdf') {
        body.filename = file.name;  // 资源接口需要filename参数
    }

    const saveResp = await fetch(config.API_BASE_URL + savePath, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(body)
    });
    const saveResult = await saveResp.json();

    if (saveResult && saveResult.code === 0) {
        if (fileType === 'video') editUploadedVideoId = saveResult.data?.videoId;
        else editUploadedPdfId = saveResult.data?.resourceId;
        showEditUploadComplete(fileType, file.name);
        Utils.showNotification(`${fileType === 'video' ? '视频' : 'PDF'}上传成功！`, 'success');
    } else {
        throw new Error(saveResult?.msg || `保存${fileType === 'video' ? '视频' : 'PDF'}信息失败`);
    }
}

function showEditUploadComplete(fileType, fileName) {
    const container = document.getElementById(`edit-${fileType}-progress-container`);
    if (container) {
        container.innerHTML = `
            <div style="text-align:center; color:#52c41a; padding:10px; background:#f6ffed; border-radius:8px; border:1px solid #b7eb8f;">
                <i class="fas fa-check-circle" style="font-size:20px;"></i>
                <div style="font-size:13px; margin-top:4px;">${fileType === 'video' ? '视频' : 'PDF'} "${fileName}" 上传成功</div>
            </div>
        `;
    }
}
function validateFile(file, fileType) {
    if (fileType === 'video') {
        const maxSize = 2 * 1024 * 1024 * 1024; // 2GB
        const allowedTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/x-matroska'];
        if (file.size > maxSize) {
            showFileError(fileType, '文件太大，视频最大支持 2GB');
            return false;
        }
        if (!allowedTypes.includes(file.type)) {
            showFileError(fileType, '请上传视频格式文件');
            return false;
        }
    }

    if (fileType === 'explain-video') {
        const maxSize = 2 * 1024 * 1024 * 1024; // 2GB
        const allowedTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/x-matroska'];
        if (file.size > maxSize) {
            showFileError(fileType, '文件太大，说课视频最大支持 2GB');
            return false;
        }
        if (!allowedTypes.includes(file.type)) {
            showFileError(fileType, '请上传视频格式文件');
            return false;
        }
    }

    if (fileType === 'pdf') {
        const maxSize = 50 * 1024 * 1024; // 50MB
        if (file.size > maxSize) {
            showFileError(fileType, 'PDF文件太大，最大支持 50MB');
            return false;
        }
        if (file.type !== 'application/pdf') {
            showFileError(fileType, '请上传 PDF 格式文件');
            return false;
        }
    }

    hideFileError(fileType);
    return true;
}

// 显示文件信息
function showFileInfo(file, fileType) {
    const area = document.getElementById(`${fileType}-upload-area`);
    const placeholder = area ? area.querySelector('.upload-placeholder') : null;
    const progress = document.getElementById(`${fileType}-progress`);
    const preview = document.getElementById(`${fileType}-preview`);
    
    // 隐藏占位符，显示进度
    if (placeholder) placeholder.style.display = 'none';
    if (progress) progress.style.display = 'block';
    
    // 更新文件信息
    const fileInfo = document.getElementById(`${fileType}-file-info`);
    if (fileInfo) {
        fileInfo.innerHTML = `
            <span><i class="fas fa-file"></i> ${file.name}</span>
            <span><i class="fas fa-hdd"></i> ${formatFileSize(file.size)}</span>
        `;
    }
    
    // 更新预览
    if (preview) {
        preview.style.display = 'flex';
        const title = document.getElementById(`${fileType}-preview-title`);
        const size = document.getElementById(`${fileType}-preview-size`);
        
        if (title) title.textContent = file.name;
        if (size) size.textContent = formatFileSize(file.size);
    }
    
    // 显示预览容器
    if (fileType === 'explain-video') {
        const previewContainer = document.getElementById('explain-video-upload-preview');
        if (previewContainer) {
            previewContainer.style.display = 'block';
        }
    } else if (fileType === 'pdf') {
        const previewContainer = document.getElementById('pdf-upload-preview');
        if (previewContainer) {
            previewContainer.style.display = 'block';
        }
    } else {
        const previewContainer = document.getElementById('upload-preview');
        if (previewContainer) {
            previewContainer.style.display = 'block';
        }
    }
}

// 显示上传完成
function showUploadComplete(fileType) {
    const progress = document.getElementById(`${fileType}-progress`);
    if (progress) {
        progress.innerHTML = `
            <div style="text-align: center; color: #52c41a; padding: 12px;">
                <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                <h4 style="margin-bottom: 4px; font-size: 14px;">上传成功！</h4>
            </div>
        `;
    }
    
    // 更新预览状态
    const preview = document.getElementById(`${fileType}-preview`);
    if (preview) {
        if (fileType === 'explain-video') {
            preview.style.background = '#fffbe6';
            preview.style.borderColor = '#ffe58f';
            preview.style.borderLeft = '3px solid #faad14';
        } else {
            preview.style.background = '#f6ffed';
            preview.style.borderColor = '#b7eb8f';
            preview.style.borderLeft = '3px solid #52c41a';
        }
    }
}

// 显示文件错误
function showFileError(fileType, message) {
    const errorElement = document.getElementById(`${fileType}-error`);
    const errorText = document.getElementById(`${fileType}-error-text`);
    
    if (errorElement) errorElement.style.display = 'flex';
    if (errorText) errorText.textContent = message;
    
    // 重置文件输入
    const fileInput = document.getElementById(`${fileType}-file`);
    if (fileInput) fileInput.value = '';
}

// 隐藏文件错误
function hideFileError(fileType) {
    const errorElement = document.getElementById(`${fileType}-error`);
    if (errorElement) errorElement.style.display = 'none';
}

// 获取视频时长（基于《视频模块前端开发指南》中的方法）
function getVideoDuration(file) {
    return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        video.preload = 'metadata';
        
        video.onloadedmetadata = function() {
            URL.revokeObjectURL(video.src);
            resolve(Math.round(video.duration)); // 四舍五入取整
        };
        
        video.onerror = function() {
            reject(new Error("无法解析视频文件"));
        };
        
        video.src = URL.createObjectURL(file);
    });
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
        
        // 检查权限并更新UI
        async function checkAndUpdatePermissions() {
            if (!currentClub || !currentClub.id) {
                console.warn('无法获取俱乐部信息，无法检查权限');
                isClubCreator = false;
                updatePermissionBasedUI(); // 添加：更新权限相关的UI
                return false;
            }
            
            try {
                // 检查用户是否是俱乐部创建者（manager）
                const hasPermission = await Clubs.isClubCreator(currentClub.id);
                isClubCreator = hasPermission; // 保存到全局变量
                console.log('权限检查结果 - 是否是创建者:', isClubCreator);
                
                // 获取"创建任务"按钮
                const createTaskBtn = document.querySelector('button[onclick="openCreateTaskModal()"]');
                if (createTaskBtn) {
                    if (!hasPermission) {
                        // 不是创建者，隐藏或禁用按钮
                        createTaskBtn.style.display = 'none';
                    } else {
                        createTaskBtn.style.display = 'inline-flex';
                        createTaskBtn.disabled = false;
                    }
                }
                
                // 添加：更新权限相关的UI
                updatePermissionBasedUI();
                
                return hasPermission;
            } catch (error) {
                console.error('检查权限失败:', error);
                isClubCreator = false;
                updatePermissionBasedUI(); // 添加：更新权限相关的UI
                return false;
            }
        }

        // 根据权限更新UI显示
        function updatePermissionBasedUI() {
            console.log('更新权限相关UI，是否是创建者:', isClubCreator);
            
            // 获取需要控制的元素
            const welcomeSubtitle = document.getElementById('welcome-subtitle');
            const usageTips = document.querySelector('.usage-tips');
            
            // 更新欢迎副标题
            if (welcomeSubtitle && currentClub) {
                if (isClubCreator) {
                    // 创建者看到的标题
                    welcomeSubtitle.textContent = `为${currentClub.name}俱乐部创建和管理教学视频`;
                    welcomeSubtitle.style.display = 'block';
                } else {
                    // 普通成员看到的标题
                    welcomeSubtitle.textContent = `参与${currentClub.name}俱乐部的教学视频研讨活动`;
                    welcomeSubtitle.style.display = 'block';
                }
            }
            
            // 更新使用提示
            if (usageTips) {
                if (isClubCreator) {
                    // 创建者看到的提示
                    usageTips.innerHTML = `
                        <h4><i class="fas fa-lightbulb"></i> 使用提示</h4>
                        <ul>
                            <li>点击"创建视频"按钮创建新的教学视频，需要上传教学视频和教学设计PDF文档</li>
                            <li>编辑视频时，可以直接上传新的教学视频或教学设计PDF文档，会自动覆盖原有的视频或文档</li>
                            <li>创建视频后，可手动锁定/解锁供成员参与</li>
                        </ul>
                    `;
                    usageTips.style.display = 'block';
                } else {
                    // 普通成员看到的提示
                    usageTips.innerHTML = `
                        <h4><i class="fas fa-lightbulb"></i> 使用提示</h4>
                        <ul>
                            <li>点击已解锁的活动卡片查看和完成活动</li>
                            <li>已解锁的活动都可以直接参与</li>
                        </ul>
                    `;
                    usageTips.style.display = 'block';
                }
            }
        }

        async function openCreateTaskModal() {
            // 先检查权限
            if (!currentClub || !currentClub.id) {
                Utils.showNotification('无法获取俱乐部信息', 'error');
                return;
            }
            
            try {
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('只有俱乐部创建者可以创建视频', 'error');
                    return;
                }
                
                const modal = document.getElementById('create-task-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    
                    // 清空输入
                    const nameInput = document.getElementById('new-task-name');
                    const descInput = document.getElementById('new-task-description');
                    const errorElement = document.getElementById('task-name-error');
                    
                    if (nameInput) nameInput.value = '';
                    if (descInput) descInput.value = '';
                    if (errorElement) errorElement.style.display = 'none';
                    
                    // 重置视频上传状态 - 只在没有已上传视频时重置
                    if (!uploadedVideoId) {
                        uploadedVideoId = null;
                    }
                    const videoFileInput = document.getElementById('video-file');
                    if (videoFileInput) videoFileInput.value = '';
                    
                    // 重置PDF上传状态
                    uploadedPdfId = null;
                    const pdfFileInput = document.getElementById('pdf-file');
                    if (pdfFileInput) pdfFileInput.value = '';
                    
                    // 重置说课视频上传状态
                    uploadedExplainVideoId = null;
                    const explainVideoFileInput = document.getElementById('explain-video-file');
                    if (explainVideoFileInput) explainVideoFileInput.value = '';
                    
                    // 重置视频上传区域UI
                    const videoPlaceholder = document.querySelector('#video-upload-area .upload-placeholder');
                    const videoProgress = document.getElementById('video-progress');
                    const videoPreview = document.getElementById('video-preview');
                    const uploadPreview = document.getElementById('upload-preview');
                    
                    if (videoPlaceholder) videoPlaceholder.style.display = 'block';
                    if (videoProgress) {
                        videoProgress.style.display = 'none';
                        videoProgress.innerHTML = `
                            <div class="progress-container">
                                <div class="progress-bar" id="video-progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="video-progress-text">0%</div>
                            <div class="file-info" id="video-file-info">
                                <span id="video-duration-info" style="display: none;">
                                    <i class="fas fa-clock"></i> 时长: <span id="video-duration">0</span>秒
                                </span>
                            </div>
                        `;
                    }
                    if (videoPreview) videoPreview.style.display = 'none';
                    if (uploadPreview) uploadPreview.style.display = 'none';
                    
                    // 重置说课视频上传区域UI
                    const explainVideoPlaceholder = document.querySelector('#explain-video-upload-area .upload-placeholder');
                    const explainVideoProgress = document.getElementById('explain-video-progress');
                    const explainVideoPreview = document.getElementById('explain-video-preview');
                    const explainVideoUploadPreview = document.getElementById('explain-video-upload-preview');
                    
                    if (explainVideoPlaceholder) explainVideoPlaceholder.style.display = 'block';
                    if (explainVideoProgress) {
                        explainVideoProgress.style.display = 'none';
                        explainVideoProgress.innerHTML = `
                            <div class="progress-container">
                                <div class="progress-bar" id="explain-video-progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="explain-video-progress-text">0%</div>
                            <div class="file-info" id="explain-video-file-info">
                                <span id="explain-video-duration-info" style="display: none;">
                                    <i class="fas fa-clock"></i> 时长: <span id="explain-video-duration">0</span>秒
                                </span>
                            </div>
                        `;
                    }
                    if (explainVideoPreview) explainVideoPreview.style.display = 'none';
                    if (explainVideoUploadPreview) explainVideoUploadPreview.style.display = 'none';
                    
                    // 重置PDF上传区域UI
                    const pdfPlaceholder = document.querySelector('#pdf-upload-area .upload-placeholder');
                    const pdfProgress = document.getElementById('pdf-progress');
                    const pdfPreview = document.getElementById('pdf-preview');
                    const pdfUploadPreview = document.getElementById('pdf-upload-preview');
                    if (pdfPlaceholder) pdfPlaceholder.style.display = 'block';
                    if (pdfProgress) {
                        pdfProgress.style.display = 'none';
                        pdfProgress.innerHTML = `
                            <div class="progress-container">
                                <div class="progress-bar" id="pdf-progress-bar" style="width: 0%; background: linear-gradient(90deg, #722ed1, #a855f7);"></div>
                            </div>
                            <div class="progress-text" id="pdf-progress-text">0%</div>
                            <div class="file-info" id="pdf-file-info"></div>
                        `;
                    }
                    if (pdfPreview) pdfPreview.style.display = 'none';
                    if (pdfUploadPreview) pdfUploadPreview.style.display = 'none';
                    
                    // 聚焦到名称输入框
                    setTimeout(() => {
                        if (nameInput) nameInput.focus();
                    }, 100);
                }
            } catch (error) {
                console.error('打开创建视频模态框失败:', error);
                Utils.showNotification('检查权限失败', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', initVideoPage);

        // 加载当前俱乐部信息
        function loadCurrentClub() {
            console.log('正在加载当前俱乐部信息...');
            
            const hash = window.location.hash;
            console.log('当前hash:', hash);
            
            let clubId = null;
            let clubName = '视频管理';
            
            if (hash.includes('?')) {
                const params = new URLSearchParams(hash.split('?')[1]);
                clubId = params.get('clubId');
                clubName = params.get('clubName') || '视频管理';
                
                console.log('从URL获取俱乐部ID:', clubId, '名称:', clubName);
            }
            
            // 方法2：从 Clubs 模块获取
            if (!clubId && window.Clubs && window.Clubs.getCurrentClub) {
                const clubFromModule = window.Clubs.getCurrentClub();
                if (clubFromModule) {
                    currentClub = clubFromModule;
                    clubId = currentClub.id || currentClub.clubId;
                    clubName = currentClub.name;
                }
            }
            
            // 方法3：从本地存储获取
            if (!clubId && window.Utils) {
                const savedClub = Utils.getFromStorage('current_club');
                if (savedClub) {
                    currentClub = savedClub;
                    clubId = currentClub.id || currentClub.clubId;
                    clubName = currentClub.name;
                    console.log('从本地存储获取俱乐部:', currentClub);
                }
            }
            
            // 如果还没有俱乐部ID，尝试从 App 状态获取
            if (!clubId && window.App && window.App.state && window.App.state.currentClubId) {
                clubId = window.App.state.currentClubId;
                console.log('从App状态获取俱乐部ID:', clubId);
            }
            
            // 创建或更新当前俱乐部对象
            if (clubId) {
                if (!currentClub) {
                    currentClub = {
                        id: parseInt(clubId),
                        clubId: parseInt(clubId),
                        name: decodeURIComponent(clubName)
                    };
                } else {
                    currentClub.id = parseInt(clubId);
                    currentClub.clubId = parseInt(clubId);
                    currentClub.name = decodeURIComponent(clubName);
                }
                
                console.log('最终确定的当前俱乐部:', currentClub);
                
                // 保存到 Clubs 模块
                if (window.Clubs && window.Clubs.setCurrentClub) {
                    window.Clubs.setCurrentClub(currentClub);
                }
                
                // 保存到本地存储
                if (window.Utils) {
                    Utils.saveToStorage('current_club', currentClub);
                }
            }
            
            // 更新页面显示
            const clubNameElement = document.getElementById('club-name-display');
            const welcomeTitle = document.getElementById('welcome-title');
            const welcomeSubtitle = document.getElementById('welcome-subtitle');
            
            if (clubNameElement && currentClub) {
                clubNameElement.textContent = `${currentClub.name}俱乐部`;
            }
            if (welcomeTitle && currentClub) {
                welcomeTitle.textContent = `${currentClub.name} - 视频主题`;
            }
            if (welcomeSubtitle && currentClub) {
                welcomeSubtitle.textContent = `为${currentClub.name}俱乐部创建和管理教学视频主题`;
            }
            
            if (!currentClub || !currentClub.id) {
                console.warn('警告：无法确定当前俱乐部ID');
                Utils.showNotification('无法获取俱乐部信息，请返回重新选择俱乐部', 'warning');
            }
        }

        // 加载视频任务
        async function loadVideoTasks() {
    console.log('========== 开始加载视频任务 ==========');
    const container = document.getElementById('videoTaskList');
    
    if (!container) {
        console.error('找不到任务列表容器');
        return;
    }
    
    try {
        // 检查权限
        await checkAndUpdatePermissions();
        
        // 尝试从API获取任务列表
        const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
        if (!clubId) {
            console.warn('无法获取俱乐部ID');
            return;
        }
        
        console.log('获取俱乐部ID的任务列表，clubId:', clubId);
        
        // 显示加载状态
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>加载中...</h3>
            </div>
        `;
        
        // 关键修改：如果当前用户是创建者，我们需要一个特殊的API或者自己处理过滤
        // 先尝试获取所有任务
        console.log('调用API.getTasks，参数:', { clubId });
        const response = await API.getTasks(clubId);
        
        console.log('API.getTasks响应:', response);
        
        if (response && response.code === 0) {
            // 确保data是数组
            let tasksData = [];
            
            if (Array.isArray(response.data)) {
                tasksData = response.data;
                console.log('直接获取到数组，长度:', tasksData.length);
            } else if (response.data && Array.isArray(response.data.list)) {
                // 或者数据在list属性中
                tasksData = response.data.list;
                console.log('从list属性获取数组，长度:', tasksData.length);
            } else if (response.data && response.data.taskId) {
                // 单个任务对象
                tasksData = [response.data];
                console.log('单个任务对象');
            } else {
                console.warn('无法识别的响应格式:', response.data);
                tasksData = [];
            }
            
            // 处理每个任务，确保status字段存在（新增：用于手动解锁状态）
            videoTasks = tasksData.map(task => {
                const processedTask = {
                    taskId: task.taskId || task.id,
                    id: task.taskId || task.id,
                    title: task.title || '未命名任务',
                    description: task.description || '',
                    type: task.type || 'all',
                    clubId: task.clubId || clubId,
                    videoId: task.videoId || null,
                    pdfId: task.pdfId || null,  // 新增：教学设计PDF ID
                    explainVideoId: task.explainVideoId || null, // 新增：说课视频ID
                    // 新增：手动解锁状态字段
                    isUnlocked: task.isUnlocked === true,
                    createdAt: task.createdAt || new Date().toISOString(),
                };
                console.log('处理后的任务:', processedTask, '解锁状态:', processedTask.isUnlocked);
                return processedTask;
            });
            
            console.log('最终videoTasks数组:', videoTasks);
            console.log('videoTasks长度:', videoTasks.length);
            
            await renderVideoTasks();
        } else {
            console.warn('API返回错误码:', response?.code, '消息:', response?.msg);
            videoTasks = [];
            await renderVideoTasks();
        }
    } catch (error) {
        console.error('加载任务失败:', error);
        videoTasks = [];
        await renderVideoTasks();
    } finally {
        // 确保UI根据权限更新
        updatePermissionBasedUI();
    }
    console.log('========== 结束加载视频任务 ==========');
}

        // 渲染视频任务列表
        async function renderVideoTasks() {
    console.log('========== 开始渲染任务列表 ==========');
    const container = document.getElementById('videoTaskList');
    if (!container) {
        console.error('找不到任务列表容器');
        return;
    }
    
    // 确保权限状态已更新
    await checkAndUpdatePermissions();
    
    console.log('渲染时videoTasks:', videoTasks);
    console.log('videoTasks长度:', videoTasks ? videoTasks.length : 0);
    
    if (!videoTasks || videoTasks.length === 0) {
        console.log('没有任务数据，显示空状态');
        // 根据权限显示不同的空状态
        if (isClubCreator) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>暂无活动</h3>
                    <p>点击右上角"创建视频"按钮开始</p>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>暂无活动</h3>
                    <p>等待俱乐部创建者发布活动</p>
                </div>
            `;
        }
        return;
    }
    
    console.log('开始渲染', videoTasks.length, '个任务');
    
    // 按创建时间排序任务
    const sortedTasks = [...videoTasks].sort((a, b) => {
        const timeA = new Date(a.createdAt || 0).getTime();
        const timeB = new Date(b.createdAt || 0).getTime();
        return timeA - timeB;
    });
    
    console.log('排序后的任务:', sortedTasks);
    
    let tasksHTML = '';
    
    // 获取当前用户角色
    console.log('当前用户是创建者吗？', isClubCreator);
    
    // 遍历所有任务
    for (let i = 0; i < sortedTasks.length; i++) {
        const task = sortedTasks[i];
        console.log(`处理第${i+1}个任务:`, task);
        
        const taskId = task.taskId || task.id;
        const createdTime = task.createdAt ? formatDate(task.createdAt) : '刚刚';
        const taskTypeLabel = getTaskTypeLabel(task.type);
        
        // 关键修改：权限判断逻辑 - 简化为只检查手动解锁状态
        let isAccessible = false;
        let lockReason = '';
        
        if (isClubCreator) {
            // 创建者总是可以访问所有任务
            isAccessible = true;
        } else {
            // 普通成员：只检查是否手动解锁
            isAccessible = task.isUnlocked === true;
            if (!isAccessible) {
                lockReason = '等待俱乐部创建者解锁此活动';
            }
        }
        
        // 获取任务完成进度（仅对可访问的任务）
        let progressData = { percentage: 0, completed: 0, total: 0 };
        if (isAccessible) {
            progressData = await getTaskProgressData(taskId);
        }
        
        // 根据是否可访问决定卡片样式
        const cardClass = isAccessible ? 'video-task-card' : 'video-task-card locked';
        const cardStyle = isAccessible ? '' : 'opacity: 0.7; cursor: not-allowed;';
        
        // 解锁状态显示
        const unlockStatusDisplay = '';
        
      const managementButtonsHTML = isClubCreator ? `
    <div class="task-management-buttons" data-task-id="${taskId}" style="margin-top: 16px; margin-bottom: 12px; display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end;">
        <button class="btn-icon ${task.isUnlocked ? 'btn-icon-lock' : 'btn-icon-unlock'}" 
                onclick="event.stopPropagation(); toggleTaskLock(${taskId}, ${!task.isUnlocked})" 
                title="${task.isUnlocked ? '锁定活动' : '解锁活动'}">
            <i class="fas ${task.isUnlocked ? 'fa-lock' : 'fa-lock-open'}"></i>
        </button>
        <button class="btn-icon btn-warning" onclick="event.stopPropagation(); openEditTaskModal(${taskId})" title="修改任务">
            <i class="fas fa-edit"></i>
        </button>
        <button class="btn-icon btn-danger" onclick="event.stopPropagation(); confirmDeleteTask(${taskId})" title="删除任务">
            <i class="fas fa-trash"></i>
        </button>
    </div>
` : '';
        
        // 进度条（普通成员且任务可访问时显示）
        const progressBarHTML = !isClubCreator && isAccessible ? `
            <div class="progress-container">
                <div class="progress-bar" style="width: ${progressData.percentage}%"></div>
            </div>
            <div class="progress-text">完成度: ${progressData.completed}/${progressData.total}</div>
        ` : '';
        
        // 锁定原因提示（仅普通成员看到）
        const lockReasonHTML = !isClubCreator && !isAccessible && lockReason ? `
            <div style="font-size: 12px; color: #ff4d4f; margin-top: 8px; padding: 8px; background: rgba(255,77,79,0.1); border-radius: 4px;">
                <i class="fas fa-lock"></i> ${lockReason}
            </div>
        ` : '';
        
        // 创建者看到的提示信息
        const creatorHintHTML = isClubCreator ? `
            <div style="font-size: 12px; color: ${task.isUnlocked ? '#389e0d' : '#d46b08'}; margin-top: 8px; padding: 8px; background: rgba(${task.isUnlocked ? '82,196,26,0.1' : '255,122,69,0.1'}); border-radius: 4px;">
                <i class="fas fa-info-circle"></i> 此活动目前${task.isUnlocked ? '已解锁，成员可以参与' : '已锁定，成员无法访问'}
            </div>
        ` : '';
        
        tasksHTML += `
            <div class="${cardClass}" style="${cardStyle}" onclick="handleTaskCardClick(${taskId}, ${isAccessible})">
                ${!isAccessible && !isClubCreator ? `
                    <div class="task-lock-overlay">
                        <i class="fas fa-lock lock-icon"></i>
                    </div>
                ` : ''}
                
                <div class="video-task-header">
                    <div class="video-task-title">
                        <i class="fas fa-video" style="color: #1890ff; margin-right: 8px;"></i>
                        ${task.title || '未命名任务'}
                        ${unlockStatusDisplay}
                        ${!isAccessible && !isClubCreator ? '<i class="fas fa-lock" style="margin-left: 8px; color: #ff4d4f;"></i>' : ''}
                    </div>
                    <div class="video-task-status">
                        <span class="tag" style="background: #e6f7ff; color: #096dd9;">
                            <i class="fas fa-calendar-alt"></i> ${createdTime}
                        </span>
                    </div>
                </div>
                
                ${task.description ? `
                <div class="video-task-description">
                    ${task.description}
                </div>
                ` : ''}
                
                ${lockReasonHTML}
                ${creatorHintHTML}
                
                <!-- 进度条 -->
                ${progressBarHTML}
                
                <!-- 管理按钮区域（仅对创建者显示） -->
                ${managementButtonsHTML}
                
                <div class="video-task-footer">
                    <div class="video-task-meta" style="color: var(--text-sub); font-size: 13px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <i class="fas fa-layer-group" style="color: #1890ff;"></i>
                        ${taskTypeLabel}
                        ${task.videoId ? `<span style="background:#e6f7ff; color:#096dd9; padding:2px 8px; border-radius:10px; font-size:12px;"><i class="fas fa-video"></i> 有视频</span>` : ''}
                        ${task.explainVideoId ? `<span style="background:#fffbe6; color:#d48806; padding:2px 8px; border-radius:10px; font-size:12px;"><i class="fas fa-microphone-alt"></i> 有说课</span>` : ''}
                        ${task.pdfId ? `<span style="background:#f0e6ff; color:#722ed1; padding:2px 8px; border-radius:10px; font-size:12px;"><i class="fas fa-file-pdf"></i> 有PDF</span>` : ''}
                        ${!isAccessible && !isClubCreator ? '<i class="fas fa-lock" style="color: #ff4d4f; margin-left: auto;"></i>' : ''}
                    </div>
                    <div class="video-task-action">
                        ${isAccessible ? `
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); enterTaskPage(${taskId})">
                            <i class="fas fa-arrow-right"></i> 进入活动
                        </button>
                        ` : `
                        <button class="btn btn-outline btn-sm" disabled style="cursor: not-allowed;">
                            <i class="fas fa-lock"></i> ${isClubCreator ? '成员不可访问' : '活动锁定'}
                        </button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }
    
    console.log('生成的HTML长度:', tasksHTML.length);
    container.innerHTML = tasksHTML;
    console.log('========== 渲染任务列表完成 ==========');
}

        // 切换任务锁定状态
        async function toggleTaskLock(taskId, unlockStatus) {
            console.log('切换任务锁定状态，任务ID:', taskId, '解锁状态:', unlockStatus);
            
            try {
                // 检查权限
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('只有俱乐部创建者可以解锁/锁定任务', 'error');
                    return;
                }
                
                // 找到任务
                const taskIndex = videoTasks.findIndex(t => t.taskId === taskId || t.id === taskId);
                if (taskIndex === -1) {
                    Utils.showNotification('找不到该任务', 'error');
                    return;
                }
                
                const task = videoTasks[taskIndex];
                const action = unlockStatus ? '解锁' : '锁定';
                
                Utils.showNotification(`正在${action}任务...`, 'info');
                
                const result = await API.updateTask(taskId, {
    isUnlocked: unlockStatus
});
                
                console.log('更新任务解锁状态API响应:', result);
                
                if (result && result.code === 0) {
                    Utils.showNotification(`任务"${task.title}"已${action}！`, 'success');
                    
                    // 更新本地任务状态
                    videoTasks[taskIndex].isUnlocked = unlockStatus;
                    
                    // 重新渲染任务列表
                    await renderVideoTasks();
                } else {
                    Utils.showNotification(result?.msg || `${action}任务失败`, 'error');
                }
            } catch (error) {
                console.error('切换任务锁定状态失败:', error);
                Utils.showNotification('操作失败: ' + error.message, 'error');
            }
        }

        // 检查任务解锁条件 - 简化为只检查手动解锁状态
        async function checkTaskUnlockConditions(task, taskIndex, allTasks) {
            const result = {
                isAccessible: false,
                lockReason: ''
            };
            
            console.log(`检查任务解锁条件: 第${taskIndex+1}个任务 "${task.title}"`);
            
            if (isClubCreator) {
                // 创建者总是可以访问
                result.isAccessible = true;
                return result;
            }
            
            // 普通成员：只检查是否手动解锁
            result.isAccessible = task.isUnlocked === true;
            
            if (!result.isAccessible) {
                result.lockReason = '等待俱乐部创建者解锁此活动';
            }
            
            console.log(`任务 "${task.title}" 访问状态: ${result.isAccessible}, 原因: ${result.lockReason}`);
            return result;
        }

        // 获取任务完成百分比
        async function getTaskProgressData(taskId) {
            try {
                const taskDetail = await Tasks.getTaskDetail(taskId);
                
                if (!taskDetail || !taskDetail.taskInfo || !Array.isArray(taskDetail.taskInfo.subTasks)) {
                    return { percentage: 0, completed: 0, total: 0 };
                }
                
                const subTasks = taskDetail.taskInfo.subTasks;
                let completedCount = 0;
                
                subTasks.forEach(subTask => {
                    if (subTask.status === 'completed') {
                        completedCount++;
                    }
                });
                
                // 使用实际的子任务数量计算进度
                const totalSubTasks = subTasks.length;
                const percentage = totalSubTasks > 0 ? Math.round((completedCount / totalSubTasks) * 100) : 0;
                return {
                    percentage: percentage,
                    completed: completedCount,
                    total: totalSubTasks
                };
            } catch (error) {
                console.error('获取任务进度失败:', error);
                return { percentage: 0, completed: 0, total: 0 };
            }
        }

        // 处理任务卡片点击
        function handleTaskCardClick(taskId, isAccessible) {
            if (!isAccessible) {
                if (isClubCreator) {
                    Utils.showNotification('此活动已锁定，成员无法访问。您可以点击"解锁"按钮解锁。', 'warning');
                } else {
                    Utils.showNotification('活动尚未解锁，请等待俱乐部创建者解锁', 'warning');
                }
                return;
            }
            enterTaskPage(taskId);
        }

        // 格式化日期
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (error) {
                console.error('格式化日期失败:', error, dateString);
                return '日期错误';
            }
        }

        // 创建新任务
        async function createNewTask() {
    // 再次验证权限（以防万一）
    if (!currentClub || !currentClub.id) {
        Utils.showNotification('无法获取俱乐部信息', 'error');
        return;
    }
    
    try {
        const hasPermission = await Clubs.isClubCreator(currentClub.id);
        if (!hasPermission) {
            Utils.showNotification('只有俱乐部创建者可以创建任务', 'error');
            return;
        }
        
        const nameInput = document.getElementById('new-task-name');
        const descInput = document.getElementById('new-task-description');
        
        if (!nameInput) return;
        
        const taskName = nameInput.value.trim();
        const taskDescription = descInput ? descInput.value.trim() : '';
        
        // 验证输入 - 只验证主题名称
        if (!taskName) {
            Utils.showNotification('请输入任务名称', 'error');
            return;
        }

        // 检查是否有视频正在上传中（如果有视频文件且未上传完成）
        const videoFile = document.getElementById('video-file').files[0];
        if (videoFile) {
            const videoProgress = parseInt(document.getElementById('video-progress-text')?.textContent || '0');
            if (videoProgress < 100 && videoProgress > 0) {
                Utils.showNotification('请等待视频上传完成', 'warning');
                return;
            }
        }
        
        // 检查是否有说课视频正在上传中
        const explainVideoFile = document.getElementById('explain-video-file').files[0];
        if (explainVideoFile) {
            const explainVideoProgress = parseInt(document.getElementById('explain-video-progress-text')?.textContent || '0');
            if (explainVideoProgress < 100 && explainVideoProgress > 0) {
                Utils.showNotification('请等待说课视频上传完成', 'warning');
                return;
            }
        }
        
        // 检查是否有PDF正在上传中（如果有PDF文件且未上传完成）
        const pdfFile = document.getElementById('pdf-file').files[0];
        if (pdfFile) {
            const pdfProgress = parseInt(document.getElementById('pdf-progress-text')?.textContent || '0');
            if (pdfProgress < 100 && pdfProgress > 0) {
                Utils.showNotification('请等待PDF上传完成', 'warning');
                return;
            }
        }
        
        // 获取俱乐部ID
        const clubId = parseInt(currentClub.id || currentClub.clubId);
        
        if (!clubId) {
            Utils.showNotification('无法获取俱乐部信息', 'error');
            return;
        }
        
        // 构建请求参数
        const requestParams = {
            clubId: clubId,
            title: taskName,
            description: taskDescription,
            type: 'all',
            isUnlocked: false
        };
        
        // 只有在有视频ID时才添加videoId参数
        if (uploadedVideoId) {
            requestParams.videoId = uploadedVideoId;
        }

        // 只有在有说课视频ID时才添加explainVideoId参数
        if (uploadedExplainVideoId) {
            requestParams.explainVideoId = uploadedExplainVideoId;
        }

        // 只有在有PDF ID时才添加pdfId参数
        if (uploadedPdfId) {
            requestParams.pdfId = uploadedPdfId;
        }
        
        console.log('创建任务请求参数:', requestParams);
        
        Utils.showNotification('正在创建任务...', 'info');
        
        const result = await API.createTask(requestParams);
        
        console.log('创建任务API完整响应:', result);
        
        if (result && result.code === 0) {
            const successMsg = `任务"${taskName}"创建成功！（默认锁定状态）`;
            Utils.showNotification(successMsg, 'success');
            closeCreateTaskModal();
            
            // 直接添加到本地列表并渲染
            if (result.data && result.data.taskId) {
                const newTask = {
                    taskId: result.data.taskId,
                    id: result.data.taskId,
                    title: taskName,
                    description: taskDescription,
                    type: 'all',
                    clubId: clubId,
                    videoId: uploadedVideoId || null,
                    explainVideoId: uploadedExplainVideoId || null,
                    pdfId: uploadedPdfId || null,
                    isUnlocked: false, // 默认锁定
                    createdAt: new Date().toISOString(),
                };
                
                console.log('新创建的任务对象:', newTask);
                
                // 添加到本地任务列表
                videoTasks.push(newTask);
                
                console.log('当前任务列表（创建后）:', videoTasks);
                
                // 立即重新渲染
                await renderVideoTasks();
                
                // 后台同步
                setTimeout(async () => {
                    try {
                        const refreshResponse = await API.getTasks(clubId);
                        if (refreshResponse && refreshResponse.code === 0) {
                            // 更新本地列表
                            let refreshedTasks = [];
                            
                            if (Array.isArray(refreshResponse.data)) {
                                refreshedTasks = refreshResponse.data;
                            } else if (refreshResponse.data && Array.isArray(refreshResponse.data.list)) {
                                refreshedTasks = refreshResponse.data.list;
                            }
                            
                            videoTasks = refreshedTasks.map(task => ({
                                taskId: task.taskId || task.id,
                                id: task.taskId || task.id,
                                title: task.title || '未命名任务',
                                description: task.description || '',
                                type: task.type || 'all',
                                clubId: task.clubId || clubId,
                                videoId: task.videoId || null,
                                explainVideoId: task.explainVideoId || null,
                                pdfId: task.pdfId || null,
                                isUnlocked: task.isUnlocked === true,
                                createdAt: task.createdAt || new Date().toISOString(),
                            }));
                            await renderVideoTasks();
                        }
                    } catch (error) {
                        console.error('刷新任务列表失败:', error);
                    }
                }, 2000);
                
            } else {
                console.warn('API没有返回taskId，直接重新加载');
                // 如果没有taskId，直接重新加载
                setTimeout(async () => {
                    await loadVideoTasks();
                }, 500);
            }
            
        } else {
            console.error('创建任务API返回错误:', result?.msg || '未知错误');
            Utils.showNotification(result?.msg || '创建任务失败', 'error');
        }
    } catch (error) {
        console.error('创建任务失败:', error);
        Utils.showNotification('创建任务失败: ' + error.message, 'error');
    }
}

// 移除文件
function removeFile(fileType) {
    console.log('removeFile函数被调用，文件类型:', fileType);
    
    const fileLabel = fileType === 'video' ? '视频文件' : fileType === 'explain-video' ? '说课视频文件' : fileType === 'pdf' ? 'PDF文件' : '文件';
    if (!confirm(`确定要移除已上传的${fileLabel}吗？`)) {
        return;
    }
    
    // 重置文件输入
    const fileInput = document.getElementById(`${fileType}-file`);
    if (fileInput) {
        fileInput.value = '';
        console.log('文件输入已清空');
    }
    
    // 重置UI显示
    const placeholder = document.querySelector(`#${fileType}-upload-area .upload-placeholder`);
    const progress = document.getElementById(`${fileType}-progress`);
    const preview = document.getElementById(`${fileType}-preview`);
    
    if (placeholder) placeholder.style.display = 'block';
    if (progress) {
        progress.style.display = 'none';
        if (fileType === 'video') {
            progress.innerHTML = `
                <div class="progress-container">
                    <div class="progress-bar" id="video-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="video-progress-text">0%</div>
                <div class="file-info" id="video-file-info">
                    <span id="video-duration-info" style="display: none;">
                        <i class="fas fa-clock"></i> 时长: <span id="video-duration">0</span>秒
                    </span>
                </div>
            `;
        } else if (fileType === 'explain-video') {
            progress.innerHTML = `
                <div class="progress-container">
                    <div class="progress-bar" id="explain-video-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="explain-video-progress-text">0%</div>
                <div class="file-info" id="explain-video-file-info">
                    <span id="explain-video-duration-info" style="display: none;">
                        <i class="fas fa-clock"></i> 时长: <span id="explain-video-duration">0</span>秒
                    </span>
                </div>
            `;
        } else {
            progress.innerHTML = `
                <div class="progress-container">
                    <div class="progress-bar" id="${fileType}-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="${fileType}-progress-text">0%</div>
                <div class="file-info" id="${fileType}-file-info"></div>
            `;
        }
    }
    if (preview) preview.style.display = 'none';
    
    // 重置对应的上传ID
    if (fileType === 'video') {
        uploadedVideoId = null;
        const previewContainer = document.getElementById('upload-preview');
        if (previewContainer) previewContainer.style.display = 'none';
    }
    if (fileType === 'explain-video') {
        uploadedExplainVideoId = null;
        const previewContainer = document.getElementById('explain-video-upload-preview');
        if (previewContainer) previewContainer.style.display = 'none';
    }
    if (fileType === 'pdf') {
        uploadedPdfId = null;
        const previewContainer = document.getElementById('pdf-upload-preview');
        if (previewContainer) previewContainer.style.display = 'none';
    }
    
    alert(`${fileLabel}已移除`);
}


// 点击模态框外部关闭
document.addEventListener('DOMContentLoaded', function() {
    const previewModal = document.getElementById('preview-modal');
    if (previewModal) {
        previewModal.addEventListener('click', function(event) {
            if (event.target === previewModal) {
                closePreview();
            }
        });
    }
    
    // ESC键关闭预览
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const previewModal = document.getElementById('preview-modal');
            if (previewModal && previewModal.style.display === 'flex') {
                closePreview();
            }
        }
    });
});

// 预览文件函数
function previewFile(fileType) {
    const fileInput = document.getElementById(`${fileType}-file`);
    if (!fileInput || !fileInput.files[0]) return;
    
    const file = fileInput.files[0];
    const previewModal = document.getElementById('preview-modal');
    const previewContent = document.getElementById('preview-content');
    const previewTitle = document.getElementById('preview-title');
    
    if (previewModal && previewContent && previewTitle) {
        previewTitle.textContent = `预览 - ${file.name}`;
        
        if (fileType === 'video' || fileType === 'explain-video') {
            // 视频预览
            const videoUrl = URL.createObjectURL(file);
            previewContent.innerHTML = `
                <div class="video-preview-container">
                    <video controls autoplay style="max-width: 100%; max-height: 100%;">
                        <source src="${videoUrl}" type="${file.type}">
                        您的浏览器不支持视频播放
                    </video>
                </div>
            `;
        } else if (fileType === 'pdf') {
            // PDF预览
            const pdfUrl = URL.createObjectURL(file);
            previewContent.innerHTML = `
                <embed src="${pdfUrl}" type="application/pdf" width="100%" height="100%" />
            `;
        }
        
        previewModal.style.display = 'flex';
    }
}

// 关闭预览
function closePreview() {
    const previewModal = document.getElementById('preview-modal');
    if (previewModal) {
        previewModal.style.display = 'none';
        // 释放URL对象
        const previewContent = document.getElementById('preview-content');
        if (previewContent) {
            previewContent.innerHTML = '';
        }
    }
}

// 创建新视频（兼容旧函数名）
function createNewVideo() {
    createNewTask();
}

        // 关闭创建任务模态框
        function closeCreateTaskModal() {
            const modal = document.getElementById('create-task-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // 清空文件输入
            const videoFileInput = document.getElementById('video-file');
            if (videoFileInput) videoFileInput.value = '';
            const explainVideoFileInput = document.getElementById('explain-video-file');
            if (explainVideoFileInput) explainVideoFileInput.value = '';
            const pdfFileInput = document.getElementById('pdf-file');
            if (pdfFileInput) pdfFileInput.value = '';

            // 重置上传ID（关闭时清除，下次打开重新上传）
            uploadedVideoId = null;
            uploadedExplainVideoId = null;
            uploadedPdfId = null;
        }

        // 进入任务页面
        async function enterTaskPage(taskId) {
            console.log('进入任务页面，任务ID:', taskId);
            
            try {
                // 获取任务详情
                const taskDetail = await Tasks.getTaskDetail(taskId);
                
                if (!taskDetail) {
                    Utils.showNotification('获取任务信息失败', 'error');
                    return;
                }
                
                // 设置当前任务
                await Tasks.setCurrentTask(taskId);
                
                // 跳转到任务页面
                if (window.App && window.App.navigateTo) {
                    window.App.navigateTo('tasks');
                } else {
                    window.location.hash = 'tasks';
                }
            } catch (error) {
                console.error('进入任务页面失败:', error);
                Utils.showNotification('加载任务失败: ' + error.message, 'error');
            }
        }

        // 打开编辑任务模态框
        async function openEditTaskModal(taskId) {
            console.log('打开编辑任务模态框，任务ID:', taskId);
            
            try {
                // 检查权限
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('只有俱乐部创建者可以修改任务', 'error');
                    return;
                }
                
                // 获取任务详情
                const task = videoTasks.find(t => t.taskId === taskId || t.id === taskId);
                if (!task) {
                    Utils.showNotification('找不到该任务', 'error');
                    return;
                }
                
                // 创建编辑模态框（简化版，只保留基本编辑功能）
                createEditTaskModal(task);
                
            } catch (error) {
                console.error('打开编辑模态框失败:', error);
                Utils.showNotification('加载任务失败', 'error');
            }
        }

        // 创建编辑任务模态框（支持编辑视频和PDF）
        async function createEditTaskModal(task) {
            // 如果已有编辑模态框，先移除
            const existingModal = document.getElementById('edit-task-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // 重置编辑上传状态
            editUploadedVideoId = null;
            editUploadedPdfId = null;

            // 标记：是否用户点击了"移除"已有文件（用于保存时置空）
            // 用闭包变量跟踪
            window._editRemoveVideo = false;
            window._editRemovePdf = false;

            // 构建已有视频的显示HTML
            let existingVideoHTML = '';
            if (task.videoId) {
                existingVideoHTML = `
                    <div class="existing-file-card video-card" id="edit-existing-video">
                        <i class="fas fa-video efc-icon video-icon"></i>
                        <div class="efc-meta">
                            <div class="efc-name">已关联视频 (ID: ${task.videoId})</div>
                            <div class="efc-label video-label">点击下方上传区域可替换</div>
                        </div>
                        <button class="btn-remove-efc" onclick="editRemoveExisting('video')">移除</button>
                    </div>
                `;
            }

            // 构建已有说课视频的显示HTML
            let existingExplainVideoHTML = '';
            if (task.explainVideoId) {
                existingExplainVideoHTML = `
                    <div class="existing-file-card" id="edit-existing-explain-video" style="background: #fffbe6; border-color: #ffe58f;">
                        <i class="fas fa-microphone-alt efc-icon" style="color: #faad14;"></i>
                        <div class="efc-meta">
                            <div class="efc-name">已关联说课视频 (ID: ${task.explainVideoId})</div>
                            <div class="efc-label" style="color: #faad14;">点击下方上传区域可替换</div>
                        </div>
                        <button class="btn-remove-efc" onclick="editRemoveExisting('explain-video')">移除</button>
                    </div>
                `;
            }

            // 构建已有PDF的显示HTML
            let existingPdfHTML = '';
            if (task.pdfId) {
                existingPdfHTML = `
                    <div class="existing-file-card" id="edit-existing-pdf">
                        <i class="fas fa-file-pdf efc-icon"></i>
                        <div class="efc-meta">
                            <div class="efc-name">已关联PDF (ID: ${task.pdfId})</div>
                            <div class="efc-label">点击下方上传区域可替换</div>
                        </div>
                        <button class="btn-remove-efc" onclick="editRemoveExisting('pdf')">移除</button>
                    </div>
                `;
            }

            const modalHTML = `
                <div id="edit-task-modal" class="modal-overlay" style="display: flex;">
                    <div class="modal" style="max-width: 560px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px;"><i class="fas fa-edit"></i> 修改任务</h3>

                        <!-- 基本信息 -->
                        <div class="form-item">
                            <label class="required">任务名称</label>
                            <input type="text" id="edit-task-name" placeholder="请输入任务名称" value="${task.title || ''}">
                        </div>
                        <div class="form-item">
                            <label>任务描述（可选）</label>
                            <textarea id="edit-task-description" placeholder="请简要描述这个任务..." rows="4">${task.description || ''}</textarea>
                        </div>

                        <!-- 视频编辑区域 -->
                        <div class="edit-section-title"><i class="fas fa-video" style="color:#1890ff;"></i> 关联视频</div>
                        ${existingVideoHTML}
                        <div id="edit-video-new-upload" style="margin-top:${task.videoId ? '10px' : '0'};">
                            <div id="edit-video-placeholder" class="file-upload-area" style="padding:20px; cursor:pointer;"
                                 onclick="document.getElementById('edit-video-file').click()">
                                <input type="file" id="edit-video-file" accept="video/*" style="display:none;"
                                       onchange="handleEditFileSelect(event, 'video')">
                                <i class="fas fa-video" style="font-size:24px; color:#1890ff;"></i>
                                <p style="color:#999; font-size:13px; margin-top:8px;">${task.videoId ? '点击替换视频' : '点击上传视频（可选）'}</p>
                                <p style="color:#bbb; font-size:12px;">支持MP4、MOV等，最大2GB</p>
                            </div>
                            <div id="edit-video-progress-container" style="display:none; margin-top:8px;">
                                <div class="progress-container">
                                    <div class="progress-bar" id="edit-video-progress-bar" style="width:0%;"></div>
                                </div>
                                <div class="progress-text" id="edit-video-progress-text">0%</div>
                            </div>
                        </div>

                        <!-- 说课视频编辑区域 -->
                        <div class="edit-section-title" style="margin-top:20px;"><i class="fas fa-microphone-alt" style="color:#faad14;"></i> 说课视频（可选）</div>
                        ${existingExplainVideoHTML}
                        <div id="edit-explain-video-new-upload" style="margin-top:${task.explainVideoId ? '10px' : '0'};">
                            <div id="edit-explain-video-placeholder" class="file-upload-area" style="padding:20px; cursor:pointer; border-color: #faad14;"
                                 onclick="document.getElementById('edit-explain-video-file').click()">
                                <input type="file" id="edit-explain-video-file" accept="video/*" style="display:none;"
                                       onchange="handleEditFileSelect(event, 'explain-video')">
                                <i class="fas fa-microphone-alt" style="font-size:24px; color:#faad14;"></i>
                                <p style="color:#999; font-size:13px; margin-top:8px;">${task.explainVideoId ? '点击替换说课视频' : '点击上传说课视频（可选）'}</p>
                                <p style="color:#bbb; font-size:12px;">支持MP4、MOV等，最大2GB</p>
                            </div>
                            <div id="edit-explain-video-progress-container" style="display:none; margin-top:8px;">
                                <div class="progress-container">
                                    <div class="progress-bar" id="edit-explain-video-progress-bar" style="width:0%; background:linear-gradient(90deg,#faad14,#ffc53d);"></div>
                                </div>
                                <div class="progress-text" id="edit-explain-video-progress-text">0%</div>
                            </div>
                        </div>

                        <!-- PDF编辑区域 -->
                        <div class="edit-section-title" style="margin-top:20px;"><i class="fas fa-file-pdf" style="color:#722ed1;"></i> 教学设计案例PDF</div>
                        ${existingPdfHTML}
                        <div id="edit-pdf-new-upload" style="margin-top:${task.pdfId ? '10px' : '0'};">
                            <div id="edit-pdf-placeholder" class="file-upload-area" style="padding:20px; cursor:pointer;"
                                 onclick="document.getElementById('edit-pdf-file').click()">
                                <input type="file" id="edit-pdf-file" accept=".pdf" style="display:none;"
                                       onchange="handleEditFileSelect(event, 'pdf')">
                                <i class="fas fa-file-pdf" style="font-size:24px; color:#722ed1;"></i>
                                <p style="color:#999; font-size:13px; margin-top:8px;">${task.pdfId ? '点击替换PDF' : '点击上传PDF（可选）'}</p>
                                <p style="color:#bbb; font-size:12px;">仅支持PDF格式，最大50MB</p>
                            </div>
                            <div id="edit-pdf-progress-container" style="display:none; margin-top:8px;">
                                <div class="progress-container">
                                    <div class="progress-bar" id="edit-pdf-progress-bar" style="width:0%; background:linear-gradient(90deg,#722ed1,#a855f7);"></div>
                                </div>
                                <div class="progress-text" id="edit-pdf-progress-text">0%</div>
                            </div>
                        </div>

                        <!-- 按钮 -->
                        <div style="text-align:right; margin-top: 24px;">
                            <button class="btn btn-outline" onclick="closeEditTaskModal()">取消</button>
                            <button class="btn btn-primary" onclick="saveTaskChanges(${task.taskId || task.id})">保存修改</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 绑定点击外部关闭
            const modal = document.getElementById('edit-task-modal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeEditTaskModal();
                    }
                });
            }
            
            // 聚焦到名称输入框
            setTimeout(() => {
                const nameInput = document.getElementById('edit-task-name');
                if (nameInput) nameInput.focus();
            }, 100);
        }

        // 编辑弹窗中移除已有文件
        function editRemoveExisting(fileType) {
            if (fileType === 'video') {
                window._editRemoveVideo = true;
                const card = document.getElementById('edit-existing-video');
                if (card) card.style.display = 'none';
                // 更新上传区域文案
                const ph = document.getElementById('edit-video-placeholder');
                if (ph) {
                    const ps = ph.querySelectorAll('p');
                    if (ps[0]) ps[0].textContent = '点击上传视频（可选）';
                }
            }
            if (fileType === 'explain-video') {
                window._editRemoveExplainVideo = true;
                const card = document.getElementById('edit-existing-explain-video');
                if (card) card.style.display = 'none';
                const ph = document.getElementById('edit-explain-video-placeholder');
                if (ph) {
                    const ps = ph.querySelectorAll('p');
                    if (ps[0]) ps[0].textContent = '点击上传说课视频（可选）';
                }
            }
            if (fileType === 'pdf') {
                window._editRemovePdf = true;
                const card = document.getElementById('edit-existing-pdf');
                if (card) card.style.display = 'none';
                const ph = document.getElementById('edit-pdf-placeholder');
                if (ph) {
                    const ps = ph.querySelectorAll('p');
                    if (ps[0]) ps[0].textContent = '点击上传PDF（可选）';
                }
            }
            Utils.showNotification(`已标记移除${fileType === 'video' ? '视频' : fileType === 'explain-video' ? '说课视频' : 'PDF'}，保存时将生效`, 'info');
        }

        // 关闭编辑任务模态框
        function closeEditTaskModal() {
            const modal = document.getElementById('edit-task-modal');
            if (modal) {
                modal.remove();
            }
        }

        // 保存任务修改
        async function saveTaskChanges(taskId) {
            console.log('保存任务修改，任务ID:', taskId);
            
            try {
                // 检查权限
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('只有俱乐部创建者可以修改任务', 'error');
                    return;
                }
                
                // 获取输入值
                const nameInput = document.getElementById('edit-task-name');
                const descInput = document.getElementById('edit-task-description');
                
                if (!nameInput) return;
                
                const taskName = nameInput.value.trim();
                const taskDescription = descInput ? descInput.value.trim() : '';
                
                // 验证输入
                if (!taskName) {
                    Utils.showNotification('请输入任务名称', 'error');
                    return;
                }

                // 检查是否有文件正在上传中
                const videoProgressText = document.getElementById('edit-video-progress-text');
                const explainVideoProgressText = document.getElementById('edit-explain-video-progress-text');
                const pdfProgressText = document.getElementById('edit-pdf-progress-text');
                if (videoProgressText && videoProgressText.textContent && videoProgressText.textContent !== '0%') {
                    const vp = parseInt(videoProgressText.textContent);
                    if (vp > 0 && vp < 100) {
                        Utils.showNotification('请等待视频上传完成', 'warning');
                        return;
                    }
                }
                if (explainVideoProgressText && explainVideoProgressText.textContent && explainVideoProgressText.textContent !== '0%') {
                    const evp = parseInt(explainVideoProgressText.textContent);
                    if (evp > 0 && evp < 100) {
                        Utils.showNotification('请等待说课视频上传完成', 'warning');
                        return;
                    }
                }
                if (pdfProgressText && pdfProgressText.textContent && pdfProgressText.textContent !== '0%') {
                    const pp = parseInt(pdfProgressText.textContent);
                    if (pp > 0 && pp < 100) {
                        Utils.showNotification('请等待PDF上传完成', 'warning');
                        return;
                    }
                }
                
                Utils.showNotification('正在保存修改...', 'info');

                // 构建更新参数
                const updateParams = {
                    title: taskName,
                    description: taskDescription
                };

                // 视频逻辑：新上传 > 标记移除(置null) > 不变(不传)
                if (editUploadedVideoId) {
                    updateParams.videoId = editUploadedVideoId;
                } else if (window._editRemoveVideo) {
                    updateParams.videoId = null;
                }
                // else: 不传 videoId，后端保持不变

                // 说课视频逻辑：新上传 > 标记移除(置null) > 不变(不传)
                if (editUploadedExplainVideoId) {
                    updateParams.explainVideoId = editUploadedExplainVideoId;
                } else if (window._editRemoveExplainVideo) {
                    updateParams.explainVideoId = null;
                }
                // else: 不传 explainVideoId，后端保持不变

                // PDF逻辑：新上传 > 标记移除(置null) > 不变(不传)
                if (editUploadedPdfId) {
                    updateParams.pdfId = editUploadedPdfId;
                } else if (window._editRemovePdf) {
                    updateParams.pdfId = null;
                }
                // else: 不传 pdfId，后端保持不变
                
                console.log('更新任务参数:', updateParams);

                // 调用API更新任务
                const result = await API.updateTask(taskId, updateParams);
                
                console.log('更新任务API响应:', result);
                
                if (result && result.code === 0) {
                    Utils.showNotification(`任务"${taskName}"修改成功！`, 'success');
                    closeEditTaskModal();
                    
                    // 刷新任务列表
                    await loadVideoTasks();
                } else {
                    Utils.showNotification(result?.msg || '修改任务失败', 'error');
                }
            } catch (error) {
                console.error('修改任务失败:', error);
                Utils.showNotification('修改任务失败: ' + error.message, 'error');
                }
            }

        // 确认删除任务
        async function confirmDeleteTask(taskId) {
            console.log('确认删除任务，任务ID:', taskId);
            
            try {
                // 检查权限
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('只有俱乐部创建者可以删除任务', 'error');
                    return;
                }
                
                // 获取任务详情
                const task = videoTasks.find(t => t.taskId === taskId || t.id === taskId);
                if (!task) {
                    Utils.showNotification('找不到该任务', 'error');
                    return;
                }
                
                // 使用浏览器自带的 confirm
                const confirmed = confirm(`确定要删除任务"${task.title}"吗？\n\n此操作将删除所有子任务和完成记录，不可撤销`);
                
                if (confirmed) {
                    await deleteTask(taskId);
                }
            } catch (error) {
                console.error('确认删除任务失败:', error);
                Utils.showNotification('操作失败', 'error');
            }
        }

        // 删除任务
        async function deleteTask(taskId) {
            console.log('删除任务，任务ID:', taskId);
            
            try {
                // 检查权限
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('只有俱乐部创建者可以删除任务', 'error');
                    return;
                }
                
                Utils.showNotification('正在删除任务...', 'info');
                
                // 调用API删除任务
                const result = await API.deleteTask(taskId);
                
                console.log('删除任务API响应:', result);
                
                if (result && result.code === 0) {
                    Utils.showNotification('任务删除成功！', 'success');
                    
                    // 刷新任务列表
                    await loadVideoTasks();
                } else {
                    Utils.showNotification(result?.msg || '删除任务失败', 'error');
                }
            } catch (error) {
                console.error('删除任务失败:', error);
                Utils.showNotification('删除任务失败: ' + error.message, 'error');
            }
        }

        // 修复任务类型显示问题
        function getTaskTypeLabel(taskType) {
            if (!taskType) return '视频+研讨活动';
            
            const typeMap = {
                'all': '视频+研讨活动',
                'watch': '看视频任务',
                'research': '研视频任务',
            };
            
            return typeMap[taskType] || '视频+研讨活动';
        }

        // 返回首页
        function goBackToHome() {
            if (window.App && window.App.navigateTo) {
                window.App.navigateTo('home');
            } else {
                window.location.hash = 'home';
            }
        }

        // 绑定全局函数
        window.openCreateTaskModal = openCreateTaskModal;
        window.closeCreateTaskModal = closeCreateTaskModal;
        window.createNewTask = createNewTask;
        window.createNewVideo = createNewVideo;
        window.enterTaskPage = enterTaskPage;
        window.goBackToHome = goBackToHome;
        window.initVideoPage = initVideoPage;
        window.openEditTaskModal = openEditTaskModal;
        window.closeEditTaskModal = closeEditTaskModal;
        window.saveTaskChanges = saveTaskChanges;
        window.confirmDeleteTask = confirmDeleteTask;
        window.deleteTask = deleteTask;
        window.handleTaskCardClick = handleTaskCardClick;
        window.toggleTaskLock = toggleTaskLock;
        window.removeFile = removeFile;
        window.editRemoveExisting = editRemoveExisting;
        window.handleEditFileSelect = handleEditFileSelect;
        window.previewFile = previewFile;
        window.closePreview = closePreview;
        
        // 新增头像下拉菜单相关函数
        window.toggleUserDropdown = toggleUserDropdown;
        window.navigateToProfile = navigateToProfile;
        window.deleteAccount = deleteAccount;
        window.openNotifications = openNotifications;
        window.updateNotificationBadge = updateNotificationBadge;
        
        // 点击模态框外部关闭
        const modal = document.getElementById('create-task-modal');
        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeCreateTaskModal();
                }
            });
        }

        // 点击模态框外部关闭
document.addEventListener('DOMContentLoaded', function() {
    const previewModal = document.getElementById('preview-modal');
    if (previewModal) {
        previewModal.addEventListener('click', function(event) {
            if (event.target === previewModal) {
                closePreview();
            }
        });
    }
    
    // ESC键关闭预览
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const previewModal = document.getElementById('preview-modal');
            if (previewModal && previewModal.style.display === 'flex') {
                closePreview();
            }
        }
    });
    
    // 确保预览按钮可以点击
    const previewButtons = document.querySelectorAll('.btn-preview');
    previewButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // 防止事件冒泡
        });
    });
    
    // 确保移除按钮可以点击
    const removeButtons = document.querySelectorAll('.btn-remove');
    removeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // 防止事件冒泡
        });
    });
});
        
        // 立即尝试初始化（支持从home动态加载）
        initVideoPage();
    </script>

</body>
</html>