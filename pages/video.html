<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频主题管理 - 教师视频俱乐部</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* 视频页面特定样式 */
        .video-page-container {
            padding: 32px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .welcome-section {
            margin-bottom: 40px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.05), rgba(114, 46, 209, 0.05));
            border-radius: 16px;
            border-left: 4px solid #1890ff;
        }

        .welcome-section h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 8px;
        }

        .welcome-section p {
            font-size: 16px;
            color: #666;
        }

        .video-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .video-task-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 180px;
        }

        .video-task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: #40a9ff;
        }

        .video-task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #1890ff, #722ed1);
        }

        .video-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .video-task-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
            display: flex;
            align-items: center;
            line-height: 1.4;
        }

        .video-task-description {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: auto;
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
        }

        .video-task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid #eee;
            margin-top: 16px;
        }

        /* 锁定状态 */
        .video-task-card.locked {
            background: #fafafa;
            border-color: #e0e0e0;
        }

        .video-task-card.locked .video-task-title {
            color: #999;
        }

        .video-task-card.locked::before {
            background: #ccc;
        }

        .task-lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lock-icon {
            color: #999;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 提示框样式 */
        .usage-tips {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .usage-tips h4 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .usage-tips ul {
            list-style: none;
            padding-left: 0;
        }

        .usage-tips li {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            padding-left: 24px;
            position: relative;
        }

        .usage-tips li:before {
            content: '•';
            color: #1890ff;
            font-size: 18px;
            position: absolute;
            left: 8px;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .video-page-container {
                padding: 20px;
            }

            .video-list-container {
                grid-template-columns: 1fr;
            }
        }

        /* 图标按钮样式 */
        .btn-icon {
            padding: 6px;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
            background: #f5f5f5;
            color: #666;
        }

        .btn-icon:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-icon-lock {
            background: #f6ffed;
            color: #389e0d;
            border-color: #b7eb8f;
        }

        .btn-icon-lock:hover {
            background: #52c41a;
            color: white;
            border-color: #52c41a;
        }

        .btn-icon-unlock {
            background: #fff2e8;
            color: #d46b08;
            border-color: #ffd8bf;
        }

        .btn-icon-unlock:hover {
            background: #ff7a45;
            color: white;
            border-color: #ff7a45;
        }

        .btn-icon.btn-warning {
            background: #fffbe6;
            color: #d48806;
            border-color: #ffe58f;
        }

        .btn-icon.btn-warning:hover {
            background: #ffc53d;
            color: white;
            border-color: #ffc53d;
        }

        .btn-icon.btn-danger {
            background: #fff2f0;
            color: #ff4d4f;
            border-color: #ffccc7;
        }

        .btn-icon.btn-danger:hover {
            background: #ff7875;
            color: white;
            border-color: #ff7875;
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 12px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #722ed1);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }
        
        .form-item {
            margin-bottom: 20px;
        }
        
        .form-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-item label.required::after {
            content: '*';
            color: #ff4d4f;
            margin-left: 4px;
        }
        
        .form-item input, .form-item textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d9d9d9;
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        .error-message {
            color: #ff4d4f;
            font-size: 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        /* 模态框样式修正 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div id="page-video" class="page active">
        <div class="header">
            <div class="header-left">
                <button class="btn btn-text" onclick="goBackToHome()" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i> 返回
                </button>
                <span class="platform-name" id="club-name-display">视频管理</span>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="openCreateTaskModal()" style="margin-right:15px;">
                    <i class="fas fa-plus"></i> 创建主题
                </button>
                <div class="user-info">
                    <div class="avatar" id="video-user-avatar">U</div>
                    <span id="video-user-name">用户</span>
                </div>
            </div>
        </div>

        <div class="video-page-container">
            <div class="welcome-section">
                <h1 id="welcome-title">教学主题</h1>
                <p id="welcome-subtitle">为您的俱乐部创建和管理教学主题活动</p>
            </div>

            <div class="video-list-container" id="videoTaskList">
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>暂无主题</h3>
                    <p>点击右上角"创建主题"按钮开始</p>
                </div>
            </div>

            <div class="usage-tips">
                </div>
        </div>

        <div id="create-task-modal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <h3 style="margin-bottom: 24px;"><i class="fas fa-plus-circle"></i> 创建新的教学主题</h3>

                <div class="form-item">
                    <label class="required">主题名称</label>
                    <input type="text" id="new-task-name" placeholder="请输入主题名称（例如：勾股定理）">
                    <div class="error-message" id="task-name-error" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> 主题名称不能为空
                    </div>
                </div>
                <div class="form-item">
                    <label>主题描述（可选）</label>
                    <textarea id="new-task-description" placeholder="请简要描述这个主题的学习目标..." rows="4"></textarea>
                </div>

                <div style="text-align:right; margin-top: 24px;">
                    <button class="btn btn-outline" onclick="closeCreateTaskModal()">取消</button>
                    <button class="btn btn-primary" onclick="createNewTask()">创建主题</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // 使用立即执行函数 (IIFE) 包裹，防止变量重复声明导致页面崩溃
    (function() {
        console.log('Video page script loaded (Safe Mode)');

        // ==========================================
        // 局部变量 (只在当前闭包内有效)
        // ==========================================
        let currentClub = null;
        let videoTasks = [];
        let isClubCreator = false;

        // ==========================================
        // 核心逻辑函数
        // ==========================================

        // 页面初始化
        function initVideoPage() {
            console.log('视频/主题页面初始化...');
            updateUserDisplay();
            loadCurrentClub();
            loadVideoTasks();
            setTimeout(updatePermissionBasedUI, 100);
        }

        // 更新用户显示
        function updateUserDisplay() {
            if (window.Auth && window.Auth.getUser()) {
                const user = window.Auth.getUser();
                document.querySelectorAll('#video-user-avatar').forEach(el => el.textContent = user.name.charAt(0));
                document.querySelectorAll('#video-user-name').forEach(el => el.textContent = user.name);
            }
        }

        // 加载当前俱乐部信息
        function loadCurrentClub() {
            const hash = window.location.hash;
            let clubId = null;
            let clubName = '视频管理';

            if (hash.includes('?')) {
                const params = new URLSearchParams(hash.split('?')[1]);
                clubId = params.get('clubId');
                clubName = params.get('clubName') || '视频管理';
            }

            // 尝试从各种来源获取 clubId
            if (!clubId && window.Clubs && window.Clubs.getCurrentClub) {
                const clubFromModule = window.Clubs.getCurrentClub();
                if (clubFromModule) {
                    currentClub = clubFromModule;
                    clubId = currentClub.id || currentClub.clubId;
                    clubName = currentClub.name;
                }
            }

            if (!clubId && window.Utils) {
                const savedClub = Utils.getFromStorage('current_club');
                if (savedClub) {
                    currentClub = savedClub;
                    clubId = currentClub.id || currentClub.clubId;
                    clubName = currentClub.name;
                }
            }

            if (clubId) {
                if (!currentClub) {
                    currentClub = {
                        id: parseInt(clubId),
                        clubId: parseInt(clubId),
                        name: decodeURIComponent(clubName)
                    };
                } else {
                    currentClub.id = parseInt(clubId);
                    currentClub.clubId = parseInt(clubId);
                    currentClub.name = decodeURIComponent(clubName);
                }
            }

            const clubNameElement = document.getElementById('club-name-display');
            const welcomeTitle = document.getElementById('welcome-title');
            const welcomeSubtitle = document.getElementById('welcome-subtitle');

            if (clubNameElement && currentClub) {
                clubNameElement.textContent = `${currentClub.name}俱乐部`;
            }
            if (welcomeTitle && currentClub) {
                welcomeTitle.textContent = `${currentClub.name} - 教学主题`;
            }

            if (!currentClub || !currentClub.id) {
                if(window.Utils && Utils.showNotification) Utils.showNotification('无法获取俱乐部信息', 'warning');
            } else {
                console.log('当前俱乐部:', currentClub);
            }
        }

        // 检查权限并更新UI
        async function checkAndUpdatePermissions() {
            if (!currentClub || !currentClub.id) {
                isClubCreator = false;
                updatePermissionBasedUI();
                return false;
            }

            try {
                // 确保 Clubs 模块存在
                if (window.Clubs && window.Clubs.isClubCreator) {
                    isClubCreator = await Clubs.isClubCreator(currentClub.id);
                } else {
                    // 降级策略
                    console.warn('Clubs module missing, fallback check');
                    isClubCreator = true; // 调试时默认 true，或者 false
                }
                
                const createTaskBtn = document.querySelector('button[onclick="openCreateTaskModal()"]');
                if (createTaskBtn) {
                    createTaskBtn.style.display = isClubCreator ? 'inline-flex' : 'none';
                }
                updatePermissionBasedUI();
                return isClubCreator;
            } catch (error) {
                console.error('检查权限失败:', error);
                isClubCreator = false;
                updatePermissionBasedUI();
                return false;
            }
        }

        // 根据权限更新UI显示
        function updatePermissionBasedUI() {
            const welcomeSubtitle = document.getElementById('welcome-subtitle');
            const usageTips = document.querySelector('.usage-tips');

            if (welcomeSubtitle && currentClub) {
                welcomeSubtitle.textContent = isClubCreator ? 
                    `为${currentClub.name}俱乐部创建和管理教学主题` : 
                    `参与${currentClub.name}俱乐部的教学研讨活动`;
            }

            if (usageTips) {
                usageTips.innerHTML = isClubCreator ? `
                    <h4><i class="fas fa-lightbulb"></i> 使用提示</h4>
                    <ul>
                        <li>点击"创建主题"按钮创建一个新的教学单元或活动主题</li>
                        <li>创建主题后，进入详情页添加视频、文档和研讨活动</li>
                        <li>您可以随时修改主题名称或描述，或锁定主题暂停访问</li>
                    </ul>
                ` : `
                    <h4><i class="fas fa-lightbulb"></i> 使用提示</h4>
                    <ul>
                        <li>点击已解锁的主题卡片进入学习页面</li>
                        <li>在主题内您可以观看视频、阅读文档并参与研讨</li>
                    </ul>
                `;
            }
        }

        // 加载任务列表
        async function loadVideoTasks() {
            const container = document.getElementById('videoTaskList');
            if (!container) return;

            try {
                await checkAndUpdatePermissions();
                const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
                if (!clubId) return;

                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>加载中...</h3>
                    </div>`;

                const response = await API.getTasks(clubId);

                if (response && response.code === 0) {
                    let tasksData = [];
                    if (Array.isArray(response.data)) {
                        tasksData = response.data;
                    } else if (response.data && Array.isArray(response.data.list)) {
                        tasksData = response.data.list;
                    }

                    videoTasks = tasksData.map(task => ({
                        taskId: task.taskId || task.id,
                        id: task.taskId || task.id,
                        title: task.title || '未命名主题',
                        description: task.description || '',
                        type: task.type || 'all',
                        clubId: task.clubId || clubId,
                        isUnlocked: task.isUnlocked === true,
                        createdAt: task.createdAt || new Date().toISOString(),
                    }));

                    await renderVideoTasks();
                } else {
                    videoTasks = [];
                    await renderVideoTasks();
                }
            } catch (error) {
                console.error('加载任务失败:', error);
                container.innerHTML = `<div class="empty-state"><p style="color:red">加载失败: ${error.message}</p></div>`;
            }
        }

        // 渲染列表
        async function renderVideoTasks() {
            const container = document.getElementById('videoTaskList');
            if (!container) return;

            if (!videoTasks || videoTasks.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-layer-group"></i>
                    <h3>暂无教学主题</h3>
                    <p>${isClubCreator ? '点击右上角"创建主题"按钮开始' : '等待管理员发布'}</p>
                </div>`;
                return;
            }

            const sortedTasks = [...videoTasks].sort((a, b) => {
                return new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime();
            });

            let tasksHTML = '';

            for (let i = 0; i < sortedTasks.length; i++) {
                const task = sortedTasks[i];
                const taskId = task.taskId || task.id;
                const createdTime = formatDate(task.createdAt);

                let isAccessible = isClubCreator || task.isUnlocked === true;
                
                // 获取进度 (仅作参考)
                let progressData = { percentage: 0, completed: 0, total: 0 };
                if (isAccessible && window.Tasks) {
                     progressData = await getTaskProgressData(taskId);
                }

                const cardClass = isAccessible ? 'video-task-card' : 'video-task-card locked';
                const cardStyle = isAccessible ? '' : 'opacity: 0.8; cursor: not-allowed;';

                const managementButtonsHTML = isClubCreator ? `
                    <div class="task-management-buttons" style="margin-top: auto; display: flex; gap: 8px; justify-content: flex-end;">
                        <button class="btn-icon ${task.isUnlocked ? 'btn-icon-lock' : 'btn-icon-unlock'}" 
                                onclick="event.stopPropagation(); toggleTaskLock(${taskId}, ${!task.isUnlocked})" 
                                title="${task.isUnlocked ? '锁定主题' : '解锁主题'}">
                            <i class="fas ${task.isUnlocked ? 'fa-lock' : 'fa-lock-open'}"></i>
                        </button>
                        <button class="btn-icon btn-warning" onclick="event.stopPropagation(); openEditTaskModal(${taskId})" title="修改主题">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-danger" onclick="event.stopPropagation(); confirmDeleteTask(${taskId})" title="删除主题">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : '';

                const progressBarHTML = !isClubCreator && isAccessible ? `
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${progressData.percentage}%"></div>
                    </div>
                    <div class="progress-text">完成度: ${progressData.completed}/${progressData.total}</div>
                ` : '';
                
                const statusTagHTML = !isAccessible && !isClubCreator ? 
                    `<span class="tag" style="background: #fff1f0; color: #cf1322;"><i class="fas fa-lock"></i> 已锁定</span>` : 
                    `<span class="tag" style="background: #e6f7ff; color: #096dd9;">${createdTime}</span>`;

                tasksHTML += `
                    <div class="${cardClass}" style="${cardStyle}" onclick="handleTaskCardClick(${taskId}, ${isAccessible})">
                        ${!isAccessible && !isClubCreator ? `<div class="task-lock-overlay"><i class="fas fa-lock lock-icon"></i></div>` : ''}
                        
                        <div class="video-task-header">
                            <div class="video-task-title">
                                <i class="fas fa-book-open" style="color: #722ed1; margin-right: 10px; font-size: 1.2em;"></i>
                                ${task.title || '未命名主题'}
                            </div>
                            <div class="video-task-status">${statusTagHTML}</div>
                        </div>
                        
                        <div class="video-task-description">
                            ${task.description || '<span style="color:#999; font-style:italic;">暂无描述</span>'}
                        </div>
                        
                        ${progressBarHTML}
                        ${managementButtonsHTML}
                        
                        <div class="video-task-footer">
                            <div class="video-task-meta" style="color: #999; font-size: 13px;">
                                <i class="fas fa-layer-group"></i> 教学单元
                            </div>
                            <div class="video-task-action">
                                ${isAccessible ? `
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); enterTaskPage(${taskId})">
                                    进入学习 <i class="fas fa-arrow-right"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = tasksHTML;
        }

        async function getTaskProgressData(taskId) {
            try {
                if(!window.Tasks || !Tasks.getTaskDetail) return { percentage: 0, completed: 0, total: 0 };
                const taskDetail = await Tasks.getTaskDetail(taskId);
                if (!taskDetail || !taskDetail.taskInfo || !Array.isArray(taskDetail.taskInfo.subTasks)) {
                    return { percentage: 0, completed: 0, total: 0 };
                }
                const subTasks = taskDetail.taskInfo.subTasks;
                let completedCount = subTasks.filter(st => st.status === 'completed').length;
                const totalSubTasks = subTasks.length;
                const percentage = totalSubTasks > 0 ? Math.round((completedCount / totalSubTasks) * 100) : 0;
                return { percentage, completed: completedCount, total: totalSubTasks };
            } catch (error) {
                return { percentage: 0, completed: 0, total: 0 };
            }
        }

        // ==========================================
        // 暴露给 window 的全局函数 (供 HTML 调用)
        // ==========================================

        window.openCreateTaskModal = function() {
            if (!currentClub || !currentClub.id) {
                Utils.showNotification('无法获取俱乐部信息', 'error');
                return;
            }
            const modal = document.getElementById('create-task-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('new-task-name').value = '';
                document.getElementById('new-task-description').value = '';
                document.getElementById('task-name-error').style.display = 'none';
                setTimeout(() => document.getElementById('new-task-name').focus(), 100);
            }
        };

        window.closeCreateTaskModal = function() {
            const modal = document.getElementById('create-task-modal');
            if (modal) modal.style.display = 'none';
        };

        window.createNewTask = async function() {
            const nameInput = document.getElementById('new-task-name');
            const descInput = document.getElementById('new-task-description');
            const taskName = nameInput.value.trim();
            const taskDescription = descInput.value.trim();

            if (!taskName) {
                document.getElementById('task-name-error').style.display = 'block';
                return;
            }

            try {
                Utils.showNotification('正在创建主题...', 'info');
                const clubId = parseInt(currentClub.id || currentClub.clubId);

                const requestParams = {
                    clubId: clubId,
                    title: taskName,
                    description: taskDescription,
                    type: 'all',
                    isUnlocked: false // 默认锁定
                };

                const result = await API.createTask(requestParams);

                if (result && result.code === 0) {
                    Utils.showNotification('主题创建成功！请进入详情页添加子任务。', 'success');
                    window.closeCreateTaskModal();
                    await loadVideoTasks();
                } else {
                    Utils.showNotification(result?.msg || '创建失败', 'error');
                }
            } catch (error) {
                console.error(error);
                Utils.showNotification('创建失败: ' + error.message, 'error');
            }
        };

        window.openEditTaskModal = function(taskId) {
            const task = videoTasks.find(t => t.taskId === taskId || t.id === taskId);
            if (!task) return;

            const existing = document.getElementById('edit-task-modal');
            if (existing) existing.remove();

            const modalHTML = `
                <div id="edit-task-modal" class="modal-overlay" style="display: flex;">
                    <div class="modal" style="max-width: 500px; width: 90%;">
                        <h3 style="margin-bottom: 20px;"><i class="fas fa-edit"></i> 修改主题信息</h3>
                        <div class="form-item">
                            <label class="required">主题名称</label>
                            <input type="text" id="edit-task-name" value="${task.title || ''}">
                        </div>
                        <div class="form-item">
                            <label>主题描述</label>
                            <textarea id="edit-task-description" rows="4">${task.description || ''}</textarea>
                        </div>
                        <div style="text-align:right; margin-top: 24px;">
                            <button class="btn btn-outline" onclick="closeEditTaskModal()">取消</button>
                            <button class="btn btn-primary" onclick="saveTaskChanges(${task.taskId || task.id})">保存修改</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        };

        window.closeEditTaskModal = function() {
            const modal = document.getElementById('edit-task-modal');
            if (modal) modal.remove();
        };

        window.saveTaskChanges = async function(taskId) {
            const title = document.getElementById('edit-task-name').value.trim();
            const description = document.getElementById('edit-task-description').value.trim();

            if (!title) {
                Utils.showNotification('名称不能为空', 'warning');
                return;
            }

            try {
                Utils.showNotification('正在保存...', 'info');
                const result = await API.updateTask(taskId, { title, description });
                if (result && result.code === 0) {
                    Utils.showNotification('修改成功', 'success');
                    window.closeEditTaskModal();
                    await loadVideoTasks();
                } else {
                    throw new Error(result?.msg || '未知错误');
                }
            } catch (e) {
                Utils.showNotification('修改失败: ' + e.message, 'error');
            }
        };

        window.confirmDeleteTask = async function(taskId) {
            if (confirm('确定要删除这个主题吗？删除后将不可恢复，包含的所有子任务也会被删除。')) {
                try {
                    Utils.showNotification('正在删除...', 'info');
                    const result = await API.deleteTask(taskId);
                    if (result && result.code === 0) {
                        Utils.showNotification('删除成功', 'success');
                        await loadVideoTasks();
                    } else {
                        throw new Error(result?.msg);
                    }
                } catch (e) {
                    Utils.showNotification('删除失败: ' + e.message, 'error');
                }
            }
        };

        window.toggleTaskLock = async function(taskId, unlockStatus) {
            try {
                Utils.showNotification(unlockStatus ? '正在解锁...' : '正在锁定...', 'info');
                const result = await API.updateTask(taskId, { isUnlocked: unlockStatus });
                if (result && result.code === 0) {
                    Utils.showNotification('操作成功', 'success');
                    const task = videoTasks.find(t => t.taskId === taskId || t.id === taskId);
                    if(task) task.isUnlocked = unlockStatus;
                    renderVideoTasks();
                }
            } catch (e) {
                Utils.showNotification('操作失败', 'error');
            }
        };

        window.handleTaskCardClick = function(taskId, isAccessible) {
            if (!isAccessible) {
                if (isClubCreator) {
                    Utils.showNotification('该主题已锁定。您可以点击锁形图标解锁。', 'info');
                } else {
                    Utils.showNotification('主题尚未解锁，请等待管理员开放', 'warning');
                }
                return;
            }
            window.enterTaskPage(taskId);
        };

        window.enterTaskPage = async function(taskId) {
            if(window.Tasks && Tasks.setCurrentTask) await Tasks.setCurrentTask(taskId);
            if (window.App && window.App.navigateTo) {
                window.App.navigateTo('tasks');
            } else {
                window.location.hash = 'tasks';
            }
        };

        window.goBackToHome = function() {
            window.location.hash = 'home';
        };

        function formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleDateString('zh-CN', {month:'2-digit', day:'2-digit'});
            } catch(e) { return ''; }
        }

        // 绑定模态框点击事件
        const modalCreate = document.getElementById('create-task-modal');
        if (modalCreate) {
            modalCreate.addEventListener('click', function (event) {
                if (event.target === modalCreate) {
                    window.closeCreateTaskModal();
                }
            });
        }

        // 启动初始化
        initVideoPage();

    })(); // 立即执行 IIFE
    </script>
</body>
</html>