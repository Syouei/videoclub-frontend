<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ç®¡ç† - æ•™å¸ˆè§†é¢‘ä¿±ä¹éƒ¨</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qiniu-js/3.4.1/qiniu.min.js"></script>

    <style>
        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .file-upload-area {
            border: 2px dashed #d9d9d9;
            border-radius: 12px;
            padding: 32px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            margin-bottom: 12px;
        }

        .file-upload-area:hover {
            border-color: #1890ff;
            background: #f0f9ff;
        }

        .upload-placeholder {
            color: #666;
        }

        .upload-placeholder h4 {
            margin: 12px 0 8px;
            font-size: 16px;
            color: #333;
        }

        .upload-progress {
            text-align: left;
        }

        .file-info {
            font-size: 13px;
            color: #666;
            margin-top: 8px;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .btn-remove {
            padding: 4px 12px;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .btn-remove:hover {
            background: #ff4d4f;
            color: white;
            border-color: #ff4d4f;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            margin: 12px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1890ff, #722ed1);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }

        /* é”å®šçŠ¶æ€ */
        .video-task-card.locked {
            background: #fafafa;
            border-color: #e0e0e0;
        }

        .video-task-card.locked .video-task-title {
            color: #999;
        }

        .video-task-card.locked::before {
            background: #ccc;
        }

        .task-lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lock-icon {
            color: #999;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* è§£é”çŠ¶æ€æ ‡ç­¾ */
        .unlock-status-tag {
            background: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            gap: 4px;
        }

        .lock-status-tag {
            background: #fff2e8;
            color: #d46b08;
            border: 1px solid #ffd8bf;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            gap: 4px;
        }

        /* è§£é”æŒ‰é’®æ ·å¼ */
        .btn-unlock {
            padding: 4px 12px;
            background: #f6ffed;
            color: #389e0d;
            border: 1px solid #b7eb8f;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .btn-unlock:hover {
            background: #52c41a;
            color: white;
            border-color: #52c41a;
        }

        .btn-lock {
            padding: 4px 12px;
            background: #fff2e8;
            color: #d46b08;
            border: 1px solid #ffd8bf;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }

        .btn-lock:hover {
            background: #ff7a45;
            color: white;
            border-color: #ff7a45;
        }

        /* ================ ä¿®å¤PDFé¢„è§ˆé—®é¢˜ ================ */
        #preview-modal .modal {
            max-width: 95vw !important;
            max-height: 95vh !important;
            width: 95vw;
            height: 95vh;
            display: flex;
            flex-direction: column;
            padding: 0 !important;
            margin: 0 !important;
        }

        #preview-modal .modal-body {
            flex: 1;
            overflow: hidden;
            padding: 0 !important;
            width: 100%;
            height: 100%;
        }

        #preview-content {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }

        #preview-content embed {
            width: 100% !important;
            height: 100% !important;
            min-height: 600px;
            display: block;
        }

        #preview-content video {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }

        .video-preview-container {
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è§†é¢‘é¡µé¢ç‰¹å®šæ ·å¼ */
        .video-page-container {
            padding: 32px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .welcome-section {
            margin-bottom: 40px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(24, 144, 255, 0.05), rgba(114, 46, 209, 0.05));
            border-radius: 16px;
            border-left: 4px solid #1890ff;
        }

        .welcome-section h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 8px;
        }

        .welcome-section p {
            font-size: 16px;
            color: #666;
        }

        .video-list-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .video-task-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .video-task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: #40a9ff;
        }

        .video-task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #1890ff, #722ed1);
        }

        .video-task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .video-task-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .video-task-description {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
        }

        .video-task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .usage-tips {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .usage-tips h4 {
            font-size: 18px;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .usage-tips ul {
            list-style: none;
            padding-left: 0;
        }

        .usage-tips li {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            padding-left: 24px;
            position: relative;
        }

        .usage-tips li:before {
            content: 'â€¢';
            color: #1890ff;
            font-size: 18px;
            position: absolute;
            left: 8px;
        }

        .task-preview {
            margin-top: 20px;
        }

        .task-preview h4 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-card {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 12px;
            padding: 16px;
            border: 1px dashed #eee;
        }

        .preview-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #333;
        }

        .preview-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .preview-tips {
            font-size: 13px;
            color: #666;
        }

        .preview-tips p {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .preview-tips ul {
            list-style: none;
            padding-left: 20px;
            margin-top: 8px;
        }

        .preview-tips li {
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .video-page-container {
                padding: 20px;
            }

            .video-list-container {
                grid-template-columns: 1fr;
            }

            .video-task-header {
                flex-direction: column;
                gap: 12px;
            }

            .video-task-footer {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }

            .video-task-action {
                align-self: flex-end;
            }
        }

        /* å›¾æ ‡æŒ‰é’®æ ·å¼ */
        .btn-icon {
            padding: 6px;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            cursor: pointer;
            background: #f5f5f5;
            color: #666;
        }

        .btn-icon:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-icon-lock {
            background: #f6ffed;
            color: #389e0d;
            border-color: #b7eb8f;
        }

        .btn-icon-lock:hover {
            background: #52c41a;
            color: white;
            border-color: #52c41a;
        }

        .btn-icon-unlock {
            background: #fff2e8;
            color: #d46b08;
            border-color: #ffd8bf;
        }

        .btn-icon-unlock:hover {
            background: #ff7a45;
            color: white;
            border-color: #ff7a45;
        }

        .btn-icon.btn-warning {
            background: #fffbe6;
            color: #d48806;
            border-color: #ffe58f;
        }

        .btn-icon.btn-warning:hover {
            background: #ffc53d;
            color: white;
            border-color: #ffc53d;
        }

        .btn-icon.btn-danger {
            background: #fff2f0;
            color: #ff4d4f;
            border-color: #ffccc7;
        }

        .btn-icon.btn-danger:hover {
            background: #ff7875;
            color: white;
            border-color: #ff7875;
        }

        /* PDF ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .pdf-upload-area {
            border: 2px dashed #d9d9d9;
            border-radius: 12px;
            padding: 28px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            margin-bottom: 12px;
        }

        .pdf-upload-area:hover {
            border-color: #722ed1;
            background: #f9f0ff;
        }

        .pdf-upload-area .upload-placeholder {
            color: #666;
        }

        .pdf-upload-area .upload-placeholder .pdf-icon {
            color: #722ed1;
        }

        /* ç¼–è¾‘å¼¹çª— - å·²æœ‰æ–‡ä»¶å±•ç¤ºå¡ç‰‡ */
        .existing-file-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f6f0ff;
            border: 1px solid #d3b6ff;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
        }

        .existing-file-card .efc-icon {
            font-size: 22px;
            color: #722ed1;
            flex-shrink: 0;
        }

        .existing-file-card .efc-icon.video-icon {
            color: #1890ff;
        }

        .existing-file-card .efc-meta {
            flex: 1;
            min-width: 0;
        }

        .existing-file-card .efc-meta .efc-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .existing-file-card .efc-meta .efc-label {
            font-size: 12px;
            color: #722ed1;
        }

        .existing-file-card .efc-meta .efc-label.video-label {
            color: #1890ff;
        }

        .existing-file-card .btn-remove-efc {
            padding: 4px 10px;
            background: #fff0f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .existing-file-card .btn-remove-efc:hover {
            background: #ff4d4f;
            color: white;
            border-color: #ff4d4f;
        }

        .existing-file-card.video-card {
            background: #f0f7ff;
            border-color: #b3d9ff;
        }

        /* ç¼–è¾‘å¼¹çª—åˆ†éš”æ ‡é¢˜ */
        .edit-section-title {
            font-size: 13px;
            color: #888;
            margin: 16px 0 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .edit-section-title i {
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div id="page-video" class="page active">
        <div class="header">
            <div class="header-left">
                <button class="btn btn-text" onclick="goBackToHome()" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i> è¿”å›
                </button>
                <span class="platform-name" id="club-name-display">è§†é¢‘ç®¡ç†</span>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="openCreateTaskModal()" style="margin-right:15px;">
                    <i class="fas fa-plus"></i> åˆ›å»ºè§†é¢‘
                </button>
                <div class="user-info">
                    <div class="avatar" id="video-user-avatar">ç‹</div>
                    <span id="video-user-name">ç‹è€å¸ˆ</span>
                </div>
            </div>
        </div>

        <div class="video-page-container">
            <div class="welcome-section">
                <h1 id="welcome-title">è§†é¢‘ä¸»é¢˜</h1>
                <p id="welcome-subtitle">ä¸ºæ‚¨çš„ä¿±ä¹éƒ¨åˆ›å»ºå’Œç®¡ç†æ•™å­¦è§†é¢‘ä¸»é¢˜</p>
            </div>

            <div class="video-list-container" id="videoTaskList">
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>æš‚æ— ä»»åŠ¡</h3>
                    <p>ç‚¹å‡»å³ä¸Šè§’"åˆ›å»ºè§†é¢‘"æŒ‰é’®å¼€å§‹</p>
                </div>
            </div>

            <div class="usage-tips">
                <h4><i class="fas fa-lightbulb"></i> ä½¿ç”¨æç¤º</h4>
                <ul>
                    <li>ç‚¹å‡»"åˆ›å»ºè§†é¢‘"æŒ‰é’®åˆ›å»ºæ–°çš„æ•™å­¦è§†é¢‘</li>
                    <li>åˆ›å»ºè§†é¢‘æ—¶ï¼Œéœ€å¡«å†™è§†é¢‘åç§°</li>
                    <li>ç‚¹å‡»è§†é¢‘å¡ç‰‡å¯ä»¥è¿›å…¥è§†é¢‘è¯¦æƒ…é¡µ</li>
                </ul>
            </div>
        </div>

        <div id="create-task-modal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <h3 style="margin-bottom: 24px;"><i class="fas fa-plus-circle"></i> åˆ›å»ºæ–°çš„è§†é¢‘ä¸»é¢˜</h3>

                <div class="form-item">
                    <label class="required">ä¸»é¢˜åç§°</label>
                    <input type="text" id="new-task-name" placeholder="è¯·è¾“å…¥ä¸»é¢˜åç§°ï¼ˆä¾‹å¦‚ï¼šå‹¾è‚¡å®šç†ï¼‰">
                    <div class="error-message" id="task-name-error" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> ä¸»é¢˜åç§°ä¸èƒ½ä¸ºç©º
                    </div>
                </div>
                <div class="form-item">
                    <label>ä¸»é¢˜æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="new-task-description" placeholder="è¯·ç®€è¦æè¿°è¿™ä¸ªä¸»é¢˜..." rows="3"></textarea>
                </div>

                <div class="form-item">
                    <label class="required">ç‚¹å‡»ä¸Šä¼ æ•™å­¦è§†é¢‘</label>
                    <div class="file-upload-area" id="video-upload-area">
                        <input type="file" id="video-file" accept="video/*" style="display: none;">
                        <div class="upload-placeholder" onclick="document.getElementById('video-file').click()">
                            <i class="fas fa-video" style="font-size: 32px; color: #1890ff; margin-bottom: 12px;"></i>
                            <p style="color: #999; font-size: 14px;">æ”¯æŒMP4ã€MOVç­‰æ ¼å¼ï¼Œæœ€å¤§20GB</p>
                        </div>
                        <div class="upload-progress" id="video-progress" style="display: none;">
                            <div class="progress-container">
                                <div class="progress-bar" id="video-progress-bar" style="width: 0%"></div>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 4px;">
                                <span id="video-upload-speed">0 KB/s</span> <span id="video-progress-text">0%</span>
                            </div>
                            <div class="file-info" id="video-file-info">
                                <span id="video-duration-info" style="display: none;">
                                    <i class="fas fa-clock"></i> æ—¶é•¿: <span id="video-duration">0</span>ç§’
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="error-message" id="video-error" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> <span id="video-error-text">è¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶</span>
                    </div>
                </div>

                <div class="form-item" id="upload-preview" style="display: none;">
                    <div class="preview-container">
                        <div class="preview-item" id="video-preview">
                            <div class="preview-icon">
                                <i class="fas fa-video"></i>
                            </div>
                            <div class="preview-info">
                                <div class="preview-title" id="video-preview-title"></div>
                                <div class="preview-size" id="video-preview-size"></div>
                                <div class="preview-duration" id="video-preview-duration"></div>
                                <div class="preview-actions">
                                    <button class="btn-remove" onclick="removeFile('video')">
                                        <i class="fas fa-times"></i> ç§»é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-item">
                    <label class="required">ä¸Šä¼ æ•™å­¦è®¾è®¡æ¡ˆä¾‹ï¼ˆPDFï¼‰</label>
                    <div class="pdf-upload-area" id="pdf-upload-area">
                        <input type="file" id="pdf-file" accept=".pdf" style="display: none;">
                        <div class="upload-placeholder" onclick="document.getElementById('pdf-file').click()">
                            <i class="fas fa-file-pdf pdf-icon" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <h4 style="margin: 8px 0 4px; font-size: 15px; color: #333;">ç‚¹å‡»ä¸Šä¼  PDF æ–‡ä»¶</h4>
                            <p style="color: #999; font-size: 13px;">ä»…æ”¯æŒ PDF æ ¼å¼</p>
                        </div>
                        <div class="upload-progress" id="pdf-progress" style="display: none;">
                            <div class="progress-container">
                                <div class="progress-bar" id="pdf-progress-bar"
                                    style="width: 0%; background: linear-gradient(90deg, #722ed1, #a855f7);"></div>
                            </div>
                            <div class="progress-text" id="pdf-progress-text">0%</div>
                            <div class="file-info" id="pdf-file-info"></div>
                        </div>
                    </div>
                    <div class="error-message" id="pdf-error" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> <span id="pdf-error-text">è¯·ä¸Šä¼ PDFæ–‡ä»¶</span>
                    </div>
                </div>
                <div class="form-item" id="pdf-upload-preview" style="display: none;">
                    <div class="preview-container">
                        <div class="preview-item" id="pdf-preview" style="display:none;">
                            <div class="preview-icon" style="color:#722ed1;">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="preview-info">
                                <div class="preview-title" id="pdf-preview-title"></div>
                                <div class="preview-size" id="pdf-preview-size"></div>
                                <div class="preview-actions">
                                    <button class="btn-remove" onclick="removeFile('pdf')">
                                        <i class="fas fa-times"></i> ç§»é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="preview-modal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 95%; max-height: 95%;">
                        <div class="modal-header">
                            <h3 id="preview-title">æ–‡ä»¶é¢„è§ˆ</h3>
                            <button class="btn-close" onclick="closePreview()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="preview-content" style="flex:1;overflow:hidden;">
                        </div>
                    </div>
                </div>
                <div style="text-align:right; margin-top: 24px;">
                    <button class="btn btn-outline" onclick="closeCreateTaskModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="createNewTask()">åˆ›å»ºä»»åŠ¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ã€æ ¸å¿ƒä¿®å¤ã€‘å†…è” AliyunVodUploader é€»è¾‘
        // è§£å†³ SPA æ¨¡å¼ä¸‹è„šæœ¬åŠ è½½å¤±è´¥å’Œ UploadAuth è®¾ç½®æ—¶æœºé—®é¢˜
        // ==========================================
        window.AliyunVodUploader = {
            ensureLoaded: function () {
                return new Promise((resolve, reject) => {
                    // 1. æ£€æŸ¥å…¨å±€å˜é‡æ˜¯å¦å·²å­˜åœ¨
                    if (window.AliyunUpload && window.AliyunUpload.Vod) {
                        return resolve();
                    }

                    // è¾…åŠ©å‡½æ•°ï¼šåŠ è½½è„šæœ¬
                    function loadScript(src) {
                        return new Promise((res, rej) => {
                            // æ£€æŸ¥æ˜¯å¦é‡å¤åŠ è½½
                            if (document.querySelector(`script[src="${src}"]`)) {
                                res(); return;
                            }
                            const s = document.createElement('script');
                            s.src = src;
                            s.onload = res;
                            s.onerror = () => rej(new Error(`åŠ è½½å¤±è´¥: ${src}`));
                            document.head.appendChild(s);
                        });
                    }

                    // --- é…ç½®è·¯å¾„ ---
                    // 1. OSS SDK (å®˜æ–¹å…¬å…±CDNï¼Œç¨³å®š)
                    const ossUrl = 'https://gosspublic.alicdn.com/aliyun-oss-sdk-6.17.1.min.js';
                    
                    // 2. Upload SDK (è¯·ç¡®ä¿æ–‡ä»¶å·²æ”¾å…¥è¯¥æœ¬åœ°è·¯å¾„!)
                    // æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»æ˜¯ä½ æœ¬åœ°å­˜æ”¾æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
                    const uploadUrl = 'js/lib/aliyun-upload-sdk-1.5.7.min.js'; 

                    console.log('å¼€å§‹åŠ è½½ SDK...');

                    // ä¸²è¡ŒåŠ è½½ï¼šå¿…é¡»å…ˆåŠ è½½ OSSï¼Œå†åŠ è½½ Upload
                    loadScript(ossUrl)
                        .then(() => {
                            console.log('âœ… OSS SDK åŠ è½½æˆåŠŸ');
                            return loadScript(uploadUrl);
                        })
                        .then(() => {
                            // åŒé‡æ£€æŸ¥
                            if (window.AliyunUpload && window.AliyunUpload.Vod) {
                                console.log('âœ… Aliyun Upload SDK åŠ è½½æˆåŠŸ');
                                resolve();
                            } else {
                                reject(new Error('SDK è„šæœ¬åŠ è½½å®Œæˆï¼Œä½† window.AliyunUpload æœªå®šä¹‰'));
                            }
                        })
                        .catch((err) => {
                            console.error('âŒ SDK åŠ è½½å¤±è´¥:', err);
                            console.error('è¯·æ£€æŸ¥ frontend/js/lib/ ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨ aliyun-upload-sdk-1.5.7.min.js æ–‡ä»¶');
                            reject(err);
                        });
                });
            },

            // ä¸Šä¼ é€»è¾‘ (ä¿æŒä¸å˜ï¼Œå·²å…¼å®¹ 1.5.x)
            uploadVideo: function (file, token, onProgress) {
                return new Promise((resolve, reject) => {
                    if (!window.AliyunUpload || !window.AliyunUpload.Vod) {
                        return reject(new Error('SDK æœªåŠ è½½'));
                    }

                    try {
                        var uploader = new window.AliyunUpload.Vod({
                            userId: "123", // å¿…å¡«ï¼Œä»»æ„å€¼
                            partSize: 1048576,
                            parallel: 5,
                            retryCount: 3,
                            retryDuration: 2,
                            // å¼€å§‹ä¸Šä¼ å›è°ƒ
                            onUploadstarted: function (uploadInfo) {
                                console.log("SDK: onUploadstarted", uploadInfo);
                                uploader.setUploadAuthAndAddress(
                                    uploadInfo,
                                    token.uploadAuth,
                                    token.uploadAddress,
                                    uploadInfo.videoId || token.videoId
                                );
                            },
                            // æˆåŠŸå›è°ƒ
                            onUploadSucceed: function (uploadInfo) {
                                console.log("SDK: onUploadSucceed", uploadInfo);
                                resolve({ videoId: uploadInfo.videoId || token.videoId });
                            },
                            // å¤±è´¥å›è°ƒ
                            onUploadFailed: function (uploadInfo, code, message) {
                                console.error("SDK: onUploadFailed", code, message);
                                reject(new Error(`ä¸Šä¼ å¤±è´¥: ${message} (${code})`));
                            },
                            // è¿›åº¦å›è°ƒ
                            onUploadProgress: function (uploadInfo, totalSize, progress) {
                                var pct = Math.ceil(progress * 100);
                                if (onProgress) onProgress(pct, "");
                            },
                            // å‡­è¯è¿‡æœŸ
                            onUploadTokenExpired: function (uploadInfo) {
                                console.error("SDK: Token Expired");
                                reject(new Error('å‡­è¯è¿‡æœŸ'));
                            }
                        });

                        // æ·»åŠ æ–‡ä»¶
                        uploader.addFile(file, null, null, null, '{"Vod":{}}');
                        
                        // å¯åŠ¨
                        console.log('ğŸš€ å¯åŠ¨ä¸Šä¼ ...');
                        uploader.startUpload();

                    } catch (error) {
                        console.error('åˆå§‹åŒ–å¼‚å¸¸:', error);
                        reject(error);
                    }
                });
            }
        };

        // ==========================================
        // åŸæœ‰é¡µé¢é€»è¾‘
        // ==========================================

        // å…¨å±€å˜é‡
        let currentClub = null;
        let videoTasks = [];
        let currentTaskId = null;
        let videoPageInitialized = false;
        let isClubCreator = false;
        let uploadedVideoId = null;
        let uploadedPdfId = null;
        let currentVideoSubscription = null;
        let currentPdfSubscription = null;
        let currentEditTaskId = null;
        let currentEditVideoId = null;
        let currentEditPdfId = null;

        function buildTaskTargetObject(taskId) {
            if (taskId === undefined || taskId === null) return undefined;
            return { task_id: taskId };
        }

        function sendFileAnalytics(eventName, fileType, fileId, taskId) {
            if (!window.Utils || !Utils.sendAnalyticsEvent) return;
            if (fileId === undefined || fileId === null) return;
            Utils.sendAnalyticsEvent(eventName, {
                category: 'teaching',
                target_type: fileType,
                target_id: fileId,
                target_object: buildTaskTargetObject(taskId)
            });
        }

        // é¡µé¢åˆå§‹åŒ–
        function initVideoPage() {
            if (!videoPageInitialized) {
                videoPageInitialized = true;
                console.log('è§†é¢‘é¡µé¢åˆå§‹åŒ–');
                updateUserDisplay();
                loadCurrentClub();
                initFileUpload();
                window.isVideoPage = true;
            }
            // æ¯æ¬¡è¿›é¡µé¢éƒ½é‡æ–°æ‹‰æ•°æ®
            loadVideoTasks();
            setTimeout(() => {
                updatePermissionBasedUI();
            }, 100);
        }

        // è®¡ç®—æ–‡ä»¶çš„ETag
        async function calculateETag(file) {
            try {
                if (window.crypto && window.crypto.subtle) {
                    const maxBytes = Math.min(file.size, 1024 * 1024);
                    const blob = file.slice(0, maxBytes);
                    const arrayBuffer = await blob.arrayBuffer();
                    const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    const etag = `${hashHex}-${file.size}`;
                    return etag;
                } else {
                    const fileInfo = [
                        file.name,
                        file.size,
                        file.lastModified || Date.now(),
                        file.type || ''
                    ].join('|');
                    let hash = 0;
                    for (let i = 0; i < fileInfo.length; i++) {
                        const char = fileInfo.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    const hashHex = Math.abs(hash).toString(16).padStart(16, '0');
                    const etag = `${hashHex}-${file.size}`;
                    return etag;
                }
            } catch (error) {
                console.error('è®¡ç®—ETagå¤±è´¥:', error);
                throw new Error(`è®¡ç®—ETagå¤±è´¥ï¼š${error.message}`);
            }
        }


        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
        function initFileUpload() {
            const videoFileInput = document.getElementById('video-file');
            if (videoFileInput) {
                videoFileInput.addEventListener('change', function (e) {
                    handleFileSelect(e, 'video');
                });
            }

            const pdfFileInput = document.getElementById('pdf-file');
            if (pdfFileInput) {
                pdfFileInput.addEventListener('change', function (e) {
                    handleFileSelect(e, 'pdf');
                });
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;

            // æ¸…é™¤é”™è¯¯æç¤º
            const uploadArea = document.getElementById(`${fileType}-upload-area`);
            const errorDiv = document.getElementById(`${fileType}-error`);
            if (uploadArea) {
                uploadArea.style.borderColor = '';
                uploadArea.style.background = '';
            }
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }

            // éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°
            if (!validateFile(file, fileType)) {
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯å’Œä¸Šä¼ è¿›åº¦åŒºåŸŸ
            showFileInfo(file, fileType);

            // å¦‚æœæ˜¯è§†é¢‘ï¼Œè¿›è¡ŒçœŸå®ä¸Šä¼ æµç¨‹
            if (fileType === 'video') {
                try {
                    const duration = await getVideoDuration(file);
                    const durationEl = document.getElementById('video-duration');
                    const durationInfoEl = document.getElementById('video-duration-info');
                    if (durationEl) durationEl.textContent = duration;
                    if (durationInfoEl) durationInfoEl.style.display = 'inline';

                    await uploadVideo(file, duration);
                } catch (error) {
                    console.error('è§†é¢‘å¤„ç†å¤±è´¥:', error);
                    showFileError('video', 'è§†é¢‘å¤„ç†å¤±è´¥: ' + error.message);
                }
            }

            // å¦‚æœæ˜¯PDFï¼Œè¿›è¡Œä¸Šä¼ æµç¨‹
            if (fileType === 'pdf') {
                try {
                    await uploadPdf(file);
                } catch (error) {
                    console.error('PDFå¤„ç†å¤±è´¥:', error);
                    showFileError('pdf', 'PDFä¸Šä¼ å¤±è´¥: ' + error.message);
                }
            }
        }

        // çœŸå®è§†é¢‘ä¸Šä¼ æµç¨‹
        async function uploadVideo(file, duration) {
            const fileType = 'video';
            currentVideoSubscription = null;

            if (uploadedVideoId) {
                console.log('è§†é¢‘å·²ä¸Šä¼ ï¼Œä½¿ç”¨å·²æœ‰çš„videoId:', uploadedVideoId);
                Utils.showNotification('è§†é¢‘å·²ä¸Šä¼ ï¼Œæ— éœ€é‡å¤ä¸Šä¼ ', 'info');
                return;
            }

            try {
                // 1. è®¡ç®—ETag
                Utils.showNotification('æ­£åœ¨è®¡ç®—æ–‡ä»¶ç‰¹å¾...', 'info');
                const etag = await calculateETag(file);

                // 2. ç§’ä¼ æ£€æµ‹
                Utils.showNotification('æ­£åœ¨è¿›è¡Œç§’ä¼ æ£€æµ‹...', 'info');
                const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
                const config = window.AppConfig;
                const token = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);

                let fastUploadResult = null;
                let isNetworkError = false;
                try {
                    const response = await fetch(config.API_BASE_URL + '/videos/fast-upload', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            clubId: clubId,
                            title: file.name,
                            etag: etag,
                        })
                    });
                    if (!response.ok) throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    fastUploadResult = await response.json();
                } catch (error) {
                    isNetworkError = true;
                }

                if (fastUploadResult && fastUploadResult.code === 0) {
                    if (fastUploadResult.data && fastUploadResult.data.videoId) {
                        uploadedVideoId = fastUploadResult.data.videoId;
                        showUploadComplete(fileType);
                        Utils.showNotification('ç§’ä¼ æˆåŠŸï¼è§†é¢‘å·²å­˜åœ¨', 'success');
                        sendFileAnalytics('file_upload_video', 'video', uploadedVideoId, null);
                        return;
                    }
                }

                Utils.showNotification('ç§’ä¼ æ£€æµ‹æœªé€šè¿‡ï¼Œå‡†å¤‡ä¸Šä¼ ...', 'info');

                // 3. è·å–ä¸Šä¼ å‡­è¯
                const tokenResult = await API.getUploadToken();
                if (!tokenResult || tokenResult.code !== 0) {
                    throw new Error(tokenResult?.msg || 'è·å–ä¸Šä¼ å‡­è¯å¤±è´¥');
                }
                const vodToken = tokenResult.data;

                // 4. ç¡®ä¿SDKåŠ è½½å¹¶å¼€å§‹ä¸Šä¼ 
                // ä½¿ç”¨åˆšåˆšå®šä¹‰çš„ window.AliyunVodUploader
                await window.AliyunVodUploader.ensureLoaded();

                Utils.showNotification('æ­£åœ¨ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ VOD...', 'info');

                const vodResp = await window.AliyunVodUploader.uploadVideo(file, vodToken, (pct, speed) => {
                    const progressBar = document.getElementById(`${fileType}-progress-bar`);
                    const progressText = document.getElementById(`${fileType}-progress-text`);
                    const speedText = document.getElementById('video-upload-speed');
                    if (progressBar) progressBar.style.width = `${pct}%`;
                    if (progressText) progressText.textContent = `${Math.round(pct)}%`;
                    if (speedText && speed) speedText.textContent = speed;
                });

                const videoIdFromVod = vodResp?.videoId;
                if (!videoIdFromVod) throw new Error('é˜¿é‡Œäº‘ä¸Šä¼ æœªè¿”å› videoId');

                // 5. ä¿å­˜è§†é¢‘ä¿¡æ¯
                Utils.showNotification('æ­£åœ¨ä¿å­˜è§†é¢‘ä¿¡æ¯...', 'info');
                const saveResult = await API.saveVideoInfo({
                    clubId: clubId,
                    title: file.name,
                    videoId: videoIdFromVod,
                    etag: etag,
                    duration: duration,
                    mimeType: file.type,
                    fileSize: file.size
                });

                if (saveResult && saveResult.code === 0) {
                    uploadedVideoId = videoIdFromVod;
                    showUploadComplete(fileType);
                    Utils.showNotification('è§†é¢‘ä¸Šä¼ æˆåŠŸï¼', 'success');
                    sendFileAnalytics('file_upload_video', 'video', uploadedVideoId, null);
                } else {
                    throw new Error(saveResult?.msg || 'ä¿å­˜è§†é¢‘ä¿¡æ¯å¤±è´¥');
                }

            } catch (error) {
                console.error('è§†é¢‘ä¸Šä¼ å¤±è´¥:', error);
                showFileError(fileType, 'ä¸Šä¼ å¤±è´¥: ' + error.message);
                throw error;
            }
        }

        // ä¸Šä¼ PDFåˆ°ä¸ƒç‰›äº‘ï¼ˆä½¿ç”¨ SDK åˆ†ç‰‡ä¸Šä¼ æ–¹å¼ - ä¼˜åŒ–ç‰ˆï¼‰
        async function uploadToQiniu(file, uploadData, objectKey, fileType, onProgress) {
            return new Promise((resolve, reject) => {
                // 1. é…ç½®åŒºåŸŸ
                let regionConfig = qiniu.region.z1;
                const regionMap = {
                    'z0': qiniu.region.z0,
                    'z1': qiniu.region.z1,
                    'z2': qiniu.region.z2,
                    'na0': qiniu.region.na0,
                    'as0': qiniu.region.as0,
                    'cn-east-2': qiniu.region.cn_east_2
                };

                if (uploadData.region && regionMap[uploadData.region]) {
                    regionConfig = regionMap[uploadData.region];
                }

                const config = {
                    useCdnDomain: true, // ä½¿ç”¨ CDN åŠ é€Ÿ
                    region: regionConfig,
                    retryCount: 2,      // å¤±è´¥é‡è¯•æ¬¡æ•°
                    concurrentRequestLimit: 4, // ã€ä¼˜åŒ–ã€‘å¢åŠ å¹¶å‘è¯·æ±‚æ•°ï¼ˆé»˜è®¤æ˜¯3ï¼‰ï¼Œæé«˜å¸¦å®½åˆ©ç”¨ç‡
                    chunkSize: 64 // åˆ†ç‰‡å¤§å°ã€‚ä¸å»ºè®®è®¾ç½®è¿‡å¤§ï¼Œå¦åˆ™å¼±ç½‘ä¸‹å®¹æ˜“å¤±è´¥ã€‚
                };

                // 2. é…ç½®ä¸Šä¼ å‚æ•°
                const putExtra = {
                    fname: file.name,
                    mimeType: file.type || null,
                    checkCrc: 1,
                    params: {}
                };

                let lastLoaded = 0;           // ä¸Šæ¬¡è®°å½•çš„å·²ä¸Šä¼ å­—èŠ‚æ•°
                let lastTime = Date.now();    // ä¸Šæ¬¡è®°å½•çš„æ—¶é—´æˆ³
                let speedStr = '0 KB/s';

                // 3. å¼€å§‹ä¸Šä¼ 
                const observable = qiniu.upload(file, objectKey, uploadData.uploadToken, putExtra, config);

                // 4. è®¢é˜…ä¸Šä¼ çŠ¶æ€
                const subscription = observable.subscribe({
                    next(res) {
                        const now = Date.now();
                        // æ¯ 1000ms (1ç§’) æ›´æ–°ä¸€æ¬¡é€Ÿåº¦
                        if (now - lastTime >= 1000) {
                            const loadedDiff = res.total.loaded - lastLoaded;
                            const timeDiff = (now - lastTime) / 1000;

                            if (timeDiff > 0) {
                                const bytesPerSecond = loadedDiff / timeDiff;
                                speedStr = formatSpeed(bytesPerSecond);
                            }

                            // æ›´æ–°åŸºå‡†ç‚¹
                            lastLoaded = res.total.loaded;
                            lastTime = now;
                        }

                        if (onProgress) {
                            onProgress(res.total.percent, speedStr);
                        }
                    },
                    error(err) {
                        console.error('Qiniu SDK Error:', err);
                        reject(new Error(err.message || 'ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯'));
                    },
                    complete(res) {
                        console.log('ä¸ƒç‰›äº‘ä¸Šä¼ å®Œæˆ:', res);
                        onProgress(100);
                        resolve(res);
                    },

                });

                if (fileType === 'pdf') {
                    currentPdfSubscription = subscription;
                }
            });
        }

        // PDF ä¸Šä¼ æµç¨‹
        async function uploadPdf(file) {
            currentPdfSubscription = null;

            if (uploadedPdfId) {
                Utils.showNotification('PDFå·²ä¸Šä¼ ï¼Œæ— éœ€é‡å¤ä¸Šä¼ ', 'info');
                return;
            }

            try {
                Utils.showNotification('æ­£åœ¨è®¡ç®—æ–‡ä»¶ç‰¹å¾...', 'info');
                const etag = await calculateETag(file);
                const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;

                // ç§’ä¼ æ£€æµ‹
                Utils.showNotification('æ­£åœ¨è¿›è¡Œç§’ä¼ æ£€æµ‹...', 'info');
                const config = window.AppConfig;
                const token = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);
                let fastUploadResult = null;
                try {
                    const response = await fetch(config.API_BASE_URL + '/resources/fast-upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ clubId, title: file.name, filename: file.name, etag })
                    });
                    if (response.ok) fastUploadResult = await response.json();
                } catch (error) { }

                if (fastUploadResult && fastUploadResult.code === 0 && fastUploadResult.data?.resourceId) {
                    uploadedPdfId = fastUploadResult.data.resourceId;
                    showUploadComplete('pdf');
                    Utils.showNotification('ç§’ä¼ æˆåŠŸï¼PDFå·²å­˜åœ¨', 'success');
                    sendFileAnalytics('file_upload_pdf', 'pdf', uploadedPdfId, null);
                    return;
                }

                Utils.showNotification('å‡†å¤‡ä¸Šä¼ PDF...', 'info');

                // è·å–å‡­è¯
                const tokenResponse = await fetch(config.API_BASE_URL + '/resources/token', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
                });
                if (!tokenResponse.ok) throw new Error('è·å–ä¸Šä¼ å‡­è¯å¤±è´¥');
                const tokenResult = await tokenResponse.json();
                if (!tokenResult || tokenResult.code !== 0) throw new Error(tokenResult?.msg || 'è·å–ä¸Šä¼ å‡­è¯å¤±è´¥');
                const uploadData = tokenResult.data;

                const objectKey = `resource/${etag}/${file.name}`;

                await uploadToQiniu(file, uploadData, objectKey, 'pdf', (progress) => {
                    const progressBar = document.getElementById('pdf-progress-bar');
                    const progressText = document.getElementById('pdf-progress-text');
                    if (progressBar) progressBar.style.width = `${progress}%`;
                    if (progressText) progressText.textContent = `${Math.round(progress)}%`;
                });

                Utils.showNotification('æ­£åœ¨ä¿å­˜èµ„æºä¿¡æ¯...', 'info');
                const saveResponse = await fetch(config.API_BASE_URL + '/resources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        clubId, title: file.name, filename: file.name, objectKey, etag,
                        bucket: uploadData.bucket, region: uploadData.region,
                        fileSize: file.size, mimeType: file.type
                    })
                });
                const saveResult = await saveResponse.json();

                if (saveResult && saveResult.code === 0) {
                    uploadedPdfId = saveResult.data?.resourceId;
                    showUploadComplete('pdf');
                    Utils.showNotification('PDFä¸Šä¼ æˆåŠŸï¼', 'success');
                    sendFileAnalytics('file_upload_pdf', 'pdf', uploadedPdfId, null);
                } else {
                    throw new Error(saveResult?.msg || 'ä¿å­˜èµ„æºä¿¡æ¯å¤±è´¥');
                }

            } catch (error) {
                console.error('PDFä¸Šä¼ å¤±è´¥:', error);
                showFileError('pdf', 'ä¸Šä¼ å¤±è´¥: ' + error.message);
                throw error;
            }
        }

        // ================ ç¼–è¾‘å¼¹çª—å†…çš„åŠ¨æ€ä¸Šä¼ ï¼ˆç”¨äºç¼–è¾‘ä»»åŠ¡æ—¶ä¸Šä¼ æ–°è§†é¢‘/PDFï¼‰ ================
        let editUploadedVideoId = null;
        let editUploadedPdfId = null;

        async function handleEditFileSelect(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;
            if (!validateFile(file, fileType)) return;

            const progressContainer = document.getElementById(`edit-${fileType}-progress-container`);
            const placeholderEl = document.getElementById(`edit-${fileType}-placeholder`);
            if (placeholderEl) placeholderEl.style.display = 'none';
            if (progressContainer) progressContainer.style.display = 'block';

            try {
                if (fileType === 'video') {
                    const duration = await getVideoDuration(file);
                    await uploadEditFile(file, 'video', duration);
                } else {
                    await uploadEditFile(file, 'pdf');
                }
            } catch (error) {
                console.error(`ç¼–è¾‘å¼¹çª— ${fileType} ä¸Šä¼ å¤±è´¥:`, error);
                Utils.showNotification(`${fileType === 'video' ? 'è§†é¢‘' : 'PDF'} ä¸Šä¼ å¤±è´¥: ` + error.message, 'error');
                if (placeholderEl) placeholderEl.style.display = 'block';
                if (progressContainer) progressContainer.style.display = 'none';
            }
        }

        async function uploadEditFile(file, fileType, duration) {
            const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
            const etag = await calculateETag(file);

            // ç§’ä¼ æ£€æµ‹
            const apiPath = fileType === 'video' ? '/videos/fast-upload' : '/resources/fast-upload';
            const config = window.AppConfig;
            const token = Utils.getFromStorage(config.STORAGE_KEYS.USER_TOKEN);
            let fastResult = null;
            try {
                const requestBody = fileType === 'video'
                    ? { clubId, title: file.name, etag }
                    : { clubId, title: file.name, filename: file.name, etag };
                const resp = await fetch(config.API_BASE_URL + apiPath, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(requestBody)
                });
                if (resp.ok) fastResult = await resp.json();
            } catch (e) { }

            const idKey = fileType === 'video' ? 'videoId' : 'resourceId';
            if (fastResult && fastResult.code === 0 && fastResult.data?.[idKey]) {
                if (fileType === 'video') editUploadedVideoId = fastResult.data.videoId;
                else editUploadedPdfId = fastResult.data.resourceId;
                showEditUploadComplete(fileType, file.name);
                Utils.showNotification('ç§’ä¼ æˆåŠŸï¼', 'success');
                const uploadedId = fileType === 'video' ? editUploadedVideoId : editUploadedPdfId;
                sendFileAnalytics(fileType === 'video' ? 'file_upload_video' : 'file_upload_pdf', fileType, uploadedId, currentEditTaskId);
                return;
            }

            // ä¸Šä¼ 
            if (fileType === 'video') {
                const tokenResult = await API.getUploadToken();
                if (!tokenResult || tokenResult.code !== 0) throw new Error(tokenResult?.msg || 'è·å–ä¸Šä¼ å‡­è¯å¤±è´¥');
                const vodToken = tokenResult.data;

                // ä½¿ç”¨å†…è”å¯¹è±¡
                await window.AliyunVodUploader.ensureLoaded();
                const vodResp = await window.AliyunVodUploader.uploadVideo(file, vodToken, (pct) => {
                    const bar = document.getElementById(`edit-${fileType}-progress-bar`);
                    const txt = document.getElementById(`edit-${fileType}-progress-text`);
                    if (bar) bar.style.width = `${pct}%`;
                    if (txt) txt.textContent = `${Math.round(pct)}%`;
                });
                editUploadedVideoId = vodResp.videoId;

                // ä¿å­˜è§†é¢‘ä¿¡æ¯
                const saveResp = await fetch(config.API_BASE_URL + '/videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        clubId, title: file.name, objectKey: vodResp.videoId, // Keyå³ID
                        etag, fileSize: file.size, mimeType: file.type, duration
                    })
                });
                const saveResult = await saveResp.json();
                if (saveResult && saveResult.code === 0) {
                    editUploadedVideoId = saveResult.data.videoId;
                }

            } else {
                // PDF ä¾ç„¶èµ°ä¸ƒç‰›
                const tokenResp = await fetch(config.API_BASE_URL + '/resources/token', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
                });
                const tokenResult = await tokenResp.json();
                const uploadData = tokenResult.data;
                const objectKey = `resource/${etag}/${file.name}`;

                await uploadToQiniu(file, uploadData, objectKey, 'pdf', (progress) => {
                    const bar = document.getElementById(`edit-${fileType}-progress-bar`);
                    const txt = document.getElementById(`edit-${fileType}-progress-text`);
                    if (bar) bar.style.width = `${progress}%`;
                    if (txt) txt.textContent = `${Math.round(progress)}%`;
                });

                // ä¿å­˜èµ„æº
                const saveResp = await fetch(config.API_BASE_URL + '/resources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        clubId, title: file.name, filename: file.name, objectKey, etag,
                        bucket: uploadData.bucket, region: uploadData.region, fileSize: file.size, mimeType: file.type
                    })
                });
                const saveResult = await saveResp.json();
                if (saveResult && saveResult.code === 0) {
                    editUploadedPdfId = saveResult.data.resourceId;
                }
            }

            showEditUploadComplete(fileType, file.name);
            Utils.showNotification(`${fileType === 'video' ? 'è§†é¢‘' : 'PDF'}ä¸Šä¼ æˆåŠŸï¼`, 'success');
        }

        function showEditUploadComplete(fileType, fileName) {
            const container = document.getElementById(`edit-${fileType}-progress-container`);
            if (container) {
                container.innerHTML = `
            <div style="text-align:center; color:#52c41a; padding:10px; background:#f6ffed; border-radius:8px; border:1px solid #b7eb8f;">
                <i class="fas fa-check-circle" style="font-size:20px;"></i>
                <div style="font-size:13px; margin-top:4px;">${fileType === 'video' ? 'è§†é¢‘' : 'PDF'} "${fileName}" ä¸Šä¼ æˆåŠŸ</div>
            </div>
        `;
            }
        }

        function validateFile(file, fileType) {
            if (fileType === 'video') {
                const maxSize = 20 * 1024 * 1024 * 1024; // 20GB
                const allowedTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/x-matroska'];
                if (file.size > maxSize) {
                    showFileError(fileType, 'æ–‡ä»¶å¤ªå¤§ï¼Œè§†é¢‘æœ€å¤§æ”¯æŒ 20GB');
                    return false;
                }
                if (!allowedTypes.includes(file.type)) {
                    showFileError(fileType, 'è¯·ä¸Šä¼ è§†é¢‘æ ¼å¼æ–‡ä»¶');
                    return false;
                }
            }

            if (fileType === 'pdf') {
                const maxSize = 50 * 1024 * 1024; // 50MB
                if (file.size > maxSize) {
                    showFileError(fileType, 'PDFæ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§æ”¯æŒ 50MB');
                    return false;
                }
                if (file.type !== 'application/pdf') {
                    showFileError(fileType, 'è¯·ä¸Šä¼  PDF æ ¼å¼æ–‡ä»¶');
                    return false;
                }
            }

            hideFileError(fileType);
            return true;
        }

        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        function showFileInfo(file, fileType) {
            const area = document.getElementById(`${fileType}-upload-area`);
            const placeholder = area.querySelector('.upload-placeholder');
            const progress = document.getElementById(`${fileType}-progress`);
            const preview = document.getElementById(`${fileType}-preview`);

            // éšè—å ä½ç¬¦ï¼Œæ˜¾ç¤ºè¿›åº¦
            if (placeholder) placeholder.style.display = 'none';
            if (progress) progress.style.display = 'block';

            // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
            const fileInfo = document.getElementById(`${fileType}-file-info`);
            if (fileInfo) {
                fileInfo.innerHTML = `
            <span><i class="fas fa-file"></i> ${file.name}</span>
            <span><i class="fas fa-hdd"></i> ${formatFileSize(file.size)}</span>
        `;
            }

            // æ›´æ–°é¢„è§ˆ
            if (preview) {
                preview.style.display = 'flex';
                const title = document.getElementById(`${fileType}-preview-title`);
                const size = document.getElementById(`${fileType}-preview-size`);

                if (title) title.textContent = file.name;
                if (size) size.textContent = formatFileSize(file.size);
            }

            // æ˜¾ç¤ºé¢„è§ˆå®¹å™¨
            const previewContainer = document.getElementById('upload-preview');
            if (previewContainer) {
                previewContainer.style.display = 'block';
            }
        }

        // æ˜¾ç¤ºä¸Šä¼ å®Œæˆ
        function showUploadComplete(fileType) {
            const progress = document.getElementById(`${fileType}-progress`);
            if (progress) {
                progress.innerHTML = `
            <div style="text-align: center; color: #52c41a; padding: 12px;">
                <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 8px;"></i>
                <h4 style="margin-bottom: 4px; font-size: 14px;">ä¸Šä¼ æˆåŠŸï¼</h4>
            </div>
        `;
            }

            // æ›´æ–°é¢„è§ˆçŠ¶æ€
            const preview = document.getElementById(`${fileType}-preview`);
            if (preview) {
                preview.style.background = '#f6ffed';
                preview.style.borderColor = '#b7eb8f';
                preview.style.borderLeft = '3px solid #52c41a';
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶é”™è¯¯
        function showFileError(fileType, message) {
            const errorElement = document.getElementById(`${fileType}-error`);
            const errorText = document.getElementById(`${fileType}-error-text`);

            if (errorElement) errorElement.style.display = 'flex';
            if (errorText) errorText.textContent = message;

            // é‡ç½®æ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById(`${fileType}-file`);
            if (fileInput) fileInput.value = '';
        }

        // éšè—æ–‡ä»¶é”™è¯¯
        function hideFileError(fileType) {
            const errorElement = document.getElementById(`${fileType}-error`);
            if (errorElement) errorElement.style.display = 'none';
        }

        function formatSpeed(bytesPerSecond) {
            if (!bytesPerSecond || bytesPerSecond < 0) return '0 KB/s';

            if (bytesPerSecond >= 1024 * 1024) {
                return (bytesPerSecond / (1024 * 1024)).toFixed(1) + ' MB/s';
            } else if (bytesPerSecond >= 1024) {
                return (bytesPerSecond / 1024).toFixed(0) + ' KB/s';
            } else {
                return bytesPerSecond.toFixed(0) + ' B/s';
            }
        }

        function getVideoDuration(file) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.preload = 'metadata';

                video.onloadedmetadata = function () {
                    URL.revokeObjectURL(video.src);
                    resolve(Math.round(video.duration));
                };

                video.onerror = function () {
                    reject(new Error("æ— æ³•è§£æè§†é¢‘æ–‡ä»¶"));
                };

                video.src = URL.createObjectURL(file);
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ£€æŸ¥æƒé™å¹¶æ›´æ–°UI
        async function checkAndUpdatePermissions() {
            if (!currentClub || !currentClub.id) {
                console.warn('æ— æ³•è·å–ä¿±ä¹éƒ¨ä¿¡æ¯ï¼Œæ— æ³•æ£€æŸ¥æƒé™');
                isClubCreator = false;
                updatePermissionBasedUI();
                return false;
            }

            try {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ä¿±ä¹éƒ¨åˆ›å»ºè€…ï¼ˆmanagerï¼‰
                const hasPermission = await Clubs.isClubCreator(currentClub.id);
                isClubCreator = hasPermission;
                console.log('æƒé™æ£€æŸ¥ç»“æœ - æ˜¯å¦æ˜¯åˆ›å»ºè€…:', isClubCreator);

                const createTaskBtn = document.querySelector('button[onclick="openCreateTaskModal()"]');
                if (createTaskBtn) {
                    if (!hasPermission) {
                        createTaskBtn.style.display = 'none';
                    } else {
                        createTaskBtn.style.display = 'inline-flex';
                        createTaskBtn.disabled = false;
                    }
                }
                updatePermissionBasedUI();

                return hasPermission;
            } catch (error) {
                console.error('æ£€æŸ¥æƒé™å¤±è´¥:', error);
                isClubCreator = false;
                updatePermissionBasedUI();
                return false;
            }
        }

        // æ ¹æ®æƒé™æ›´æ–°UIæ˜¾ç¤º
        function updatePermissionBasedUI() {
            const welcomeSubtitle = document.getElementById('welcome-subtitle');
            const usageTips = document.querySelector('.usage-tips');

            if (welcomeSubtitle && currentClub) {
                if (isClubCreator) {
                    welcomeSubtitle.textContent = `ä¸º${currentClub.name}ä¿±ä¹éƒ¨åˆ›å»ºå’Œç®¡ç†æ•™å­¦è§†é¢‘`;
                    welcomeSubtitle.style.display = 'block';
                } else {
                    welcomeSubtitle.textContent = `å‚ä¸${currentClub.name}ä¿±ä¹éƒ¨çš„æ•™å­¦è§†é¢‘ç ”è®¨æ´»åŠ¨`;
                    welcomeSubtitle.style.display = 'block';
                }
            }

            if (usageTips) {
                if (isClubCreator) {
                    usageTips.innerHTML = `
                        <h4><i class="fas fa-lightbulb"></i> ä½¿ç”¨æç¤º</h4>
                        <ul>
                            <li>ç‚¹å‡»"åˆ›å»ºè§†é¢‘"æŒ‰é’®åˆ›å»ºæ–°çš„æ•™å­¦è§†é¢‘ï¼Œéœ€è¦ä¸Šä¼ æ•™å­¦è§†é¢‘å’Œæ•™å­¦è®¾è®¡PDFæ–‡æ¡£</li>
                            <li>ç¼–è¾‘è§†é¢‘æ—¶ï¼Œå¯ä»¥ç›´æ¥ä¸Šä¼ æ–°çš„æ•™å­¦è§†é¢‘æˆ–æ•™å­¦è®¾è®¡PDFæ–‡æ¡£ï¼Œä¼šè‡ªåŠ¨è¦†ç›–åŸæœ‰çš„è§†é¢‘æˆ–æ–‡æ¡£</li>
                            <li>åˆ›å»ºè§†é¢‘åï¼Œå¯æ‰‹åŠ¨é”å®š/è§£é”ä¾›æˆå‘˜å‚ä¸</li>
                        </ul>
                    `;
                    usageTips.style.display = 'block';
                } else {
                    usageTips.innerHTML = `
                        <h4><i class="fas fa-lightbulb"></i> ä½¿ç”¨æç¤º</h4>
                        <ul>
                            <li>ç‚¹å‡»å·²è§£é”çš„æ´»åŠ¨å¡ç‰‡æŸ¥çœ‹å’Œå®Œæˆæ´»åŠ¨</li>
                            <li>å·²è§£é”çš„æ´»åŠ¨éƒ½å¯ä»¥ç›´æ¥å‚ä¸</li>
                        </ul>
                    `;
                    usageTips.style.display = 'block';
                }
            }
        }

        async function openCreateTaskModal() {
            if (!currentClub || !currentClub.id) {
                Utils.showNotification('æ— æ³•è·å–ä¿±ä¹éƒ¨ä¿¡æ¯', 'error');
                return;
            }

            try {
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('åªæœ‰ä¿±ä¹éƒ¨åˆ›å»ºè€…å¯ä»¥åˆ›å»ºè§†é¢‘', 'error');
                    return;
                }

                const modal = document.getElementById('create-task-modal');
                if (modal) {
                    modal.style.display = 'flex';

                    if (window.Utils && Utils.sendAnalyticsEvent) {
                        Utils.sendAnalyticsEvent('task_open_create_modal', {
                            category: 'teaching',
                            club_id: currentClub ? (currentClub.id || currentClub.clubId) : null
                        });
                    }

                    const nameInput = document.getElementById('new-task-name');
                    const descInput = document.getElementById('new-task-description');
                    const errorElement = document.getElementById('task-name-error');

                    if (nameInput) nameInput.value = '';
                    if (descInput) descInput.value = '';
                    if (errorElement) errorElement.style.display = 'none';

                    if (!uploadedVideoId) {
                        uploadedVideoId = null;
                    }
                    const videoFileInput = document.getElementById('video-file');
                    if (videoFileInput) videoFileInput.value = '';

                    uploadedPdfId = null;
                    const pdfFileInput = document.getElementById('pdf-file');
                    if (pdfFileInput) pdfFileInput.value = '';

                    const videoPlaceholder = document.querySelector('#video-upload-area .upload-placeholder');
                    const videoProgress = document.getElementById('video-progress');
                    const videoPreview = document.getElementById('video-preview');
                    const uploadPreview = document.getElementById('upload-preview');

                    if (videoPlaceholder) videoPlaceholder.style.display = 'block';
                    if (videoProgress) {
                        videoProgress.style.display = 'none';
                        videoProgress.innerHTML = `
                            <div class="progress-container">
                                <div class="progress-bar" id="video-progress-bar" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="video-progress-text">0%</div>
                            <div class="file-info" id="video-file-info">
                                <span id="video-duration-info" style="display: none;">
                                    <i class="fas fa-clock"></i> æ—¶é•¿: <span id="video-duration">0</span>ç§’
                                </span>
                            </div>
                        `;
                    }
                    if (videoPreview) videoPreview.style.display = 'none';
                    if (uploadPreview) uploadPreview.style.display = 'none';

                    const pdfPlaceholder = document.querySelector('#pdf-upload-area .upload-placeholder');
                    const pdfProgress = document.getElementById('pdf-progress');
                    const pdfPreview = document.getElementById('pdf-preview');
                    const pdfUploadPreview = document.getElementById('pdf-upload-preview');
                    if (pdfPlaceholder) pdfPlaceholder.style.display = 'block';
                    if (pdfProgress) {
                        pdfProgress.style.display = 'none';
                        pdfProgress.innerHTML = `
                            <div class="progress-container">
                                <div class="progress-bar" id="pdf-progress-bar" style="width: 0%; background: linear-gradient(90deg, #722ed1, #a855f7);"></div>
                            </div>
                            <div class="progress-text" id="pdf-progress-text">0%</div>
                            <div class="file-info" id="pdf-file-info"></div>
                        `;
                    }
                    if (pdfPreview) pdfPreview.style.display = 'none';
                    if (pdfUploadPreview) pdfUploadPreview.style.display = 'none';

                    setTimeout(() => {
                        if (nameInput) nameInput.focus();
                    }, 100);
                }
            } catch (error) {
                console.error('æ‰“å¼€åˆ›å»ºè§†é¢‘æ¨¡æ€æ¡†å¤±è´¥:', error);
                Utils.showNotification('æ£€æŸ¥æƒé™å¤±è´¥', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', initVideoPage);

        // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
        function updateUserDisplay() {
            if (window.Auth && window.Auth.getUser()) {
                const user = window.Auth.getUser();
                const avatarElements = document.querySelectorAll('#video-user-avatar');
                const nameElements = document.querySelectorAll('#video-user-name');

                avatarElements.forEach(element => {
                    if (element) element.textContent = user.name.charAt(0);
                });
                nameElements.forEach(element => {
                    if (element) element.textContent = user.name;
                });
            }
        }

        // åŠ è½½å½“å‰ä¿±ä¹éƒ¨ä¿¡æ¯
        function loadCurrentClub() {
            const hash = window.location.hash;
            let clubId = null;
            let clubName = 'è§†é¢‘ç®¡ç†';

            if (hash.includes('?')) {
                const params = new URLSearchParams(hash.split('?')[1]);
                clubId = params.get('clubId');
                clubName = params.get('clubName') || 'è§†é¢‘ç®¡ç†';
            }

            if (!clubId && window.Clubs && window.Clubs.getCurrentClub) {
                const clubFromModule = window.Clubs.getCurrentClub();
                if (clubFromModule) {
                    currentClub = clubFromModule;
                    clubId = currentClub.id || currentClub.clubId;
                    clubName = currentClub.name;
                }
            }

            if (!clubId && window.Utils) {
                const savedClub = Utils.getFromStorage('current_club');
                if (savedClub) {
                    currentClub = savedClub;
                    clubId = currentClub.id || currentClub.clubId;
                    clubName = currentClub.name;
                }
            }

            if (!clubId && window.App && window.App.state && window.App.state.currentClubId) {
                clubId = window.App.state.currentClubId;
            }

            if (clubId) {
                if (!currentClub) {
                    currentClub = {
                        id: parseInt(clubId),
                        clubId: parseInt(clubId),
                        name: decodeURIComponent(clubName)
                    };
                } else {
                    currentClub.id = parseInt(clubId);
                    currentClub.clubId = parseInt(clubId);
                    currentClub.name = decodeURIComponent(clubName);
                }

                if (window.Clubs && window.Clubs.setCurrentClub) {
                    window.Clubs.setCurrentClub(currentClub);
                }

                if (window.Utils) {
                    Utils.saveToStorage('current_club', currentClub);
                }
            }

            const clubNameElement = document.getElementById('club-name-display');
            const welcomeTitle = document.getElementById('welcome-title');
            const welcomeSubtitle = document.getElementById('welcome-subtitle');

            if (clubNameElement && currentClub) {
                clubNameElement.textContent = `${currentClub.name}ä¿±ä¹éƒ¨`;
            }
            if (welcomeTitle && currentClub) {
                welcomeTitle.textContent = `${currentClub.name} - è§†é¢‘ä¸»é¢˜`;
            }
            if (welcomeSubtitle && currentClub) {
                welcomeSubtitle.textContent = `ä¸º${currentClub.name}ä¿±ä¹éƒ¨åˆ›å»ºå’Œç®¡ç†æ•™å­¦è§†é¢‘ä¸»é¢˜`;
            }

            if (!currentClub || !currentClub.id) {
                Utils.showNotification('æ— æ³•è·å–ä¿±ä¹éƒ¨ä¿¡æ¯ï¼Œè¯·è¿”å›é‡æ–°é€‰æ‹©ä¿±ä¹éƒ¨', 'warning');
            }
        }

        // åŠ è½½è§†é¢‘ä»»åŠ¡
        async function loadVideoTasks() {
            const container = document.getElementById('videoTaskList');

            if (!container) return;

            try {
                await checkAndUpdatePermissions();
                const clubId = currentClub ? parseInt(currentClub.id || currentClub.clubId) : null;
                if (!clubId) return;

                container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>åŠ è½½ä¸­...</h3>
            </div>
        `;

                const response = await API.getTasks(clubId);

                if (response && response.code === 0) {
                    let tasksData = [];

                    if (Array.isArray(response.data)) {
                        tasksData = response.data;
                    } else if (response.data && Array.isArray(response.data.list)) {
                        tasksData = response.data.list;
                    } else if (response.data && response.data.taskId) {
                        tasksData = [response.data];
                    } else {
                        tasksData = [];
                    }

                    videoTasks = tasksData.map(task => {
                        const processedTask = {
                            taskId: task.taskId || task.id,
                            id: task.taskId || task.id,
                            title: task.title || 'æœªå‘½åä»»åŠ¡',
                            description: task.description || '',
                            type: task.type || 'all',
                            clubId: task.clubId || clubId,
                            videoId: task.videoId || null,
                            pdfId: task.pdfId || null,
                            isUnlocked: task.isUnlocked === true,
                            createdAt: task.createdAt || new Date().toISOString(),
                        };
                        return processedTask;
                    });

                    await renderVideoTasks();
                } else {
                    videoTasks = [];
                    await renderVideoTasks();
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                videoTasks = [];
                await renderVideoTasks();
            } finally {
                updatePermissionBasedUI();
            }
        }

        // æ¸²æŸ“è§†é¢‘ä»»åŠ¡åˆ—è¡¨
        async function renderVideoTasks() {
            const container = document.getElementById('videoTaskList');
            if (!container) return;

            await checkAndUpdatePermissions();

            if (!videoTasks || videoTasks.length === 0) {
                if (isClubCreator) {
                    container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>æš‚æ— æ´»åŠ¨</h3>
                    <p>ç‚¹å‡»å³ä¸Šè§’"åˆ›å»ºè§†é¢‘"æŒ‰é’®å¼€å§‹</p>
                </div>
            `;
                } else {
                    container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-tasks"></i>
                    <h3>æš‚æ— æ´»åŠ¨</h3>
                    <p>ç­‰å¾…ä¿±ä¹éƒ¨åˆ›å»ºè€…å‘å¸ƒæ´»åŠ¨</p>
                </div>
            `;
                }
                return;
            }

            const sortedTasks = [...videoTasks].sort((a, b) => {
                const timeA = new Date(a.createdAt || 0).getTime();
                const timeB = new Date(b.createdAt || 0).getTime();
                return timeA - timeB;
            });

            let tasksHTML = '';

            for (let i = 0; i < sortedTasks.length; i++) {
                const task = sortedTasks[i];
                const taskId = task.taskId || task.id;
                const createdTime = task.createdAt ? formatDate(task.createdAt) : 'åˆšåˆš';
                const taskTypeLabel = getTaskTypeLabel(task.type);

                let isAccessible = false;
                let lockReason = '';

                if (isClubCreator) {
                    isAccessible = true;
                } else {
                    isAccessible = task.isUnlocked === true;
                    if (!isAccessible) {
                        lockReason = 'ç­‰å¾…ä¿±ä¹éƒ¨åˆ›å»ºè€…è§£é”æ­¤æ´»åŠ¨';
                    }
                }

                let progressData = { percentage: 0, completed: 0, total: 0 };
                if (isAccessible) {
                    progressData = await getTaskProgressData(taskId);
                }

                const cardClass = isAccessible ? 'video-task-card' : 'video-task-card locked';
                const cardStyle = isAccessible ? '' : 'opacity: 0.7; cursor: not-allowed;';
                const unlockStatusDisplay = '';

                const managementButtonsHTML = isClubCreator ? `
    <div class="task-management-buttons" data-task-id="${taskId}" style="margin-top: 16px; margin-bottom: 12px; display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end;">
        <button class="btn-icon ${task.isUnlocked ? 'btn-icon-lock' : 'btn-icon-unlock'}" 
                onclick="event.stopPropagation(); toggleTaskLock(${taskId}, ${!task.isUnlocked})" 
                title="${task.isUnlocked ? 'é”å®šæ´»åŠ¨' : 'è§£é”æ´»åŠ¨'}">
            <i class="fas ${task.isUnlocked ? 'fa-lock' : 'fa-lock-open'}"></i>
        </button>
        <button class="btn-icon btn-warning" onclick="event.stopPropagation(); openEditTaskModal(${taskId})" title="ä¿®æ”¹ä»»åŠ¡">
            <i class="fas fa-edit"></i>
        </button>
        <button class="btn-icon btn-danger" onclick="event.stopPropagation(); confirmDeleteTask(${taskId})" title="åˆ é™¤ä»»åŠ¡">
            <i class="fas fa-trash"></i>
        </button>
    </div>
` : '';

                const progressBarHTML = !isClubCreator && isAccessible ? `
            <div class="progress-container">
                <div class="progress-bar" style="width: ${progressData.percentage}%"></div>
            </div>
            <div class="progress-text">å®Œæˆåº¦: ${progressData.completed}/${progressData.total}</div>
        ` : '';

                const lockReasonHTML = !isClubCreator && !isAccessible && lockReason ? `
            <div style="font-size: 12px; color: #ff4d4f; margin-top: 8px; padding: 8px; background: rgba(255,77,79,0.1); border-radius: 4px;">
                <i class="fas fa-lock"></i> ${lockReason}
            </div>
        ` : '';

                const creatorHintHTML = isClubCreator ? `
            <div style="font-size: 12px; color: ${task.isUnlocked ? '#389e0d' : '#d46b08'}; margin-top: 8px; padding: 8px; background: rgba(${task.isUnlocked ? '82,196,26,0.1' : '255,122,69,0.1'}); border-radius: 4px;">
                <i class="fas fa-info-circle"></i> æ­¤æ´»åŠ¨ç›®å‰${task.isUnlocked ? 'å·²è§£é”ï¼Œæˆå‘˜å¯ä»¥å‚ä¸' : 'å·²é”å®šï¼Œæˆå‘˜æ— æ³•è®¿é—®'}
            </div>
        ` : '';

                tasksHTML += `
            <div class="${cardClass}" style="${cardStyle}" onclick="handleTaskCardClick(${taskId}, ${isAccessible})">
                ${!isAccessible && !isClubCreator ? `
                    <div class="task-lock-overlay">
                        <i class="fas fa-lock lock-icon"></i>
                    </div>
                ` : ''}
                
                <div class="video-task-header">
                    <div class="video-task-title">
                        <i class="fas fa-video" style="color: #1890ff; margin-right: 8px;"></i>
                        ${task.title || 'æœªå‘½åä»»åŠ¡'}
                        ${unlockStatusDisplay}
                        ${!isAccessible && !isClubCreator ? '<i class="fas fa-lock" style="margin-left: 8px; color: #ff4d4f;"></i>' : ''}
                    </div>
                    <div class="video-task-status">
                        <span class="tag" style="background: #e6f7ff; color: #096dd9;">
                            <i class="fas fa-calendar-alt"></i> ${createdTime}
                        </span>
                    </div>
                </div>
                
                ${task.description ? `
                <div class="video-task-description">
                    ${task.description}
                </div>
                ` : ''}
                
                ${lockReasonHTML}
                ${creatorHintHTML}
                
                ${progressBarHTML}
                
                ${managementButtonsHTML}
                
                <div class="video-task-footer">
                    <div class="video-task-meta" style="color: var(--text-sub); font-size: 13px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <i class="fas fa-layer-group" style="color: #1890ff;"></i>
                        ${taskTypeLabel}
                        ${task.videoId ? `<span style="background:#e6f7ff; color:#096dd9; padding:2px 8px; border-radius:10px; font-size:12px;"><i class="fas fa-video"></i> æœ‰è§†é¢‘</span>` : ''}
                        ${task.pdfId ? `<span style="background:#f0e6ff; color:#722ed1; padding:2px 8px; border-radius:10px; font-size:12px;"><i class="fas fa-file-pdf"></i> æœ‰PDF</span>` : ''}
                        ${!isAccessible && !isClubCreator ? '<i class="fas fa-lock" style="color: #ff4d4f; margin-left: auto;"></i>' : ''}
                    </div>
                    <div class="video-task-action">
                        ${isAccessible ? `
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); enterTaskPage(${taskId})">
                            <i class="fas fa-arrow-right"></i> è¿›å…¥æ´»åŠ¨
                        </button>
                        ` : `
                        <button class="btn btn-outline btn-sm" disabled style="cursor: not-allowed;">
                            <i class="fas fa-lock"></i> ${isClubCreator ? 'æˆå‘˜ä¸å¯è®¿é—®' : 'æ´»åŠ¨é”å®š'}
                        </button>
                        `}
                    </div>
                </div>
            </div>
        `;
            }
            container.innerHTML = tasksHTML;
        }

        async function toggleTaskLock(taskId, unlockStatus) {
            try {
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('åªæœ‰ä¿±ä¹éƒ¨åˆ›å»ºè€…å¯ä»¥è§£é”/é”å®šä»»åŠ¡', 'error');
                    return;
                }

                const taskIndex = videoTasks.findIndex(t => t.taskId === taskId || t.id === taskId);
                if (taskIndex === -1) {
                    Utils.showNotification('æ‰¾ä¸åˆ°è¯¥ä»»åŠ¡', 'error');
                    return;
                }

                const task = videoTasks[taskIndex];
                const action = unlockStatus ? 'è§£é”' : 'é”å®š';
                Utils.showNotification(`æ­£åœ¨${action}ä»»åŠ¡...`, 'info');

                const result = await API.updateTask(taskId, {
                    isUnlocked: unlockStatus
                });

                if (result && result.code === 0) {
                    Utils.showNotification(`ä»»åŠ¡"${task.title}"å·²${action}ï¼`, 'success');
                    if (window.Utils && Utils.sendAnalyticsEvent) {
                        Utils.sendAnalyticsEvent(unlockStatus ? 'task_unlock' : 'task_lock', {
                            category: 'teaching',
                            target_type: 'task',
                            target_id: taskId
                        });
                    }

                    videoTasks[taskIndex].isUnlocked = unlockStatus;
                    await renderVideoTasks();
                } else {
                    Utils.showNotification(result?.msg || `${action}ä»»åŠ¡å¤±è´¥`, 'error');
                }
            } catch (error) {
                console.error('åˆ‡æ¢ä»»åŠ¡é”å®šçŠ¶æ€å¤±è´¥:', error);
                Utils.showNotification('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function getTaskProgressData(taskId) {
            try {
                const taskDetail = await Tasks.getTaskDetail(taskId);

                if (!taskDetail || !taskDetail.taskInfo || !Array.isArray(taskDetail.taskInfo.subTasks)) {
                    return { percentage: 0, completed: 0, total: 0 };
                }

                const subTasks = taskDetail.taskInfo.subTasks;
                let completedCount = 0;

                subTasks.forEach(subTask => {
                    if (subTask.status === 'completed') {
                        completedCount++;
                    }
                });

                const totalSubTasks = subTasks.length;
                const percentage = totalSubTasks > 0 ? Math.round((completedCount / totalSubTasks) * 100) : 0;
                return {
                    percentage: percentage,
                    completed: completedCount,
                    total: totalSubTasks
                };
            } catch (error) {
                console.error('è·å–ä»»åŠ¡è¿›åº¦å¤±è´¥:', error);
                return { percentage: 0, completed: 0, total: 0 };
            }
        }

        function handleTaskCardClick(taskId, isAccessible) {
            if (!isAccessible) {
                if (isClubCreator) {
                    Utils.showNotification('æ­¤æ´»åŠ¨å·²é”å®šï¼Œæˆå‘˜æ— æ³•è®¿é—®ã€‚æ‚¨å¯ä»¥ç‚¹å‡»"è§£é”"æŒ‰é’®è§£é”ã€‚', 'warning');
                } else {
                    Utils.showNotification('æ´»åŠ¨å°šæœªè§£é”ï¼Œè¯·ç­‰å¾…ä¿±ä¹éƒ¨åˆ›å»ºè€…è§£é”', 'warning');
                }
                return;
            }
            enterTaskPage(taskId);
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (error) {
                return 'æ—¥æœŸé”™è¯¯';
            }
        }

        async function createNewTask() {
            if (!currentClub || !currentClub.id) {
                Utils.showNotification('æ— æ³•è·å–ä¿±ä¹éƒ¨ä¿¡æ¯', 'error');
                return;
            }

            try {
                const hasPermission = await Clubs.isClubCreator(currentClub.id);
                if (!hasPermission) {
                    Utils.showNotification('åªæœ‰ä¿±ä¹éƒ¨åˆ›å»ºè€…å¯ä»¥åˆ›å»ºä»»åŠ¡', 'error');
                    return;
                }

                const nameInput = document.getElementById('new-task-name');
                const descInput = document.getElementById('new-task-description');

                if (!nameInput) return;

                const taskName = nameInput.value.trim();
                const taskDescription = descInput ? descInput.value.trim() : '';

                if (!taskName) {
                    Utils.showNotification('è¯·è¾“å…¥ä»»åŠ¡åç§°', 'error');
                    return;
                }

                const videoFile = document.getElementById('video-file').files[0];
                if (videoFile) {
                    const videoProgress = parseInt(document.getElementById('video-progress-text')?.textContent || '0');
                    if (videoProgress < 100 && videoProgress > 0) {
                        Utils.showNotification('è¯·ç­‰å¾…è§†é¢‘ä¸Šä¼ å®Œæˆ', 'warning');
                        return;
                    }
                }

                if (!uploadedVideoId && !videoFile) {
                    Utils.showNotification('è¯·ä¸Šä¼ æ•™å­¦è§†é¢‘ï¼ˆå¿…å¡«ï¼‰', 'error');
                    const videoUploadArea = document.getElementById('video-upload-area');
                    const videoError = document.getElementById('video-error');
                    if (videoUploadArea) {
                        videoUploadArea.style.borderColor = '#ff4d4f';
                        videoUploadArea.style.background = 'rgba(255, 77, 79, 0.05)';
                    }
                    if (videoError) {
                        videoError.style.display = 'flex';
                        document.getElementById('video-error-text').textContent = 'è¯·ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼ˆå¿…å¡«ï¼‰';
                    }
                    return;
                }

                const pdfFile = document.getElementById('pdf-file').files[0];
                if (pdfFile) {
                    const pdfProgress = parseInt(document.getElementById('pdf-progress-text')?.textContent || '0');
                    if (pdfProgress < 100 && pdfProgress > 0) {
                        Utils.showNotification('è¯·ç­‰å¾…PDFä¸Šä¼ å®Œæˆ', 'warning');
                        return;
                    }
                }

                if (!uploadedPdfId && !pdfFile) {
                    Utils.showNotification('è¯·ä¸Šä¼ æ•™å­¦è®¾è®¡æ¡ˆä¾‹PDFæ–‡ä»¶ï¼ˆå¿…å¡«ï¼‰', 'error');
                    const pdfUploadArea = document.getElementById('pdf-upload-area');
                    const pdfError = document.getElementById('pdf-error');
                    if (pdfUploadArea) {
                        pdfUploadArea.style.borderColor = '#ff4d4f';
                        pdfUploadArea.style.background = 'rgba(255, 77, 79, 0.05)';
                    }
                    if (pdfError) {
                        pdfError.style.display = 'flex';
                        document.getElementById('pdf-error-text').textContent = 'è¯·ä¸Šä¼ PDFæ–‡ä»¶ï¼ˆå¿…å¡«ï¼‰';
                    }
                    return;
                }

                const clubId = parseInt(currentClub.id || currentClub.clubId);

                const requestParams = {
                    clubId: clubId,
                    title: taskName,
                    description: taskDescription,
                    type: 'all',
                    isUnlocked: false
                };

                if (uploadedVideoId) {
                    requestParams.videoId = uploadedVideoId;
                }

                if (uploadedPdfId) {
                    requestParams.pdfId = uploadedPdfId;
                }

                Utils.showNotification('æ­£åœ¨åˆ›å»ºä»»åŠ¡...', 'info');

                const result = await API.createTask(requestParams);

                if (result && result.code === 0) {
                    const successMsg = `ä»»åŠ¡"${taskName}"åˆ›å»ºæˆåŠŸï¼ï¼ˆé»˜è®¤é”å®šçŠ¶æ€ï¼‰`;
                    Utils.showNotification(successMsg, 'success');
                    closeCreateTaskModal(false);

                    if (window.Utils && Utils.sendAnalyticsEvent) {
                        Utils.sendAnalyticsEvent('task_create', {
                            category: 'teaching',
                            target_type: 'task',
                            target_id: result.data?.taskId,
                            club_id: clubId
                        });
                    }

                    if (result.data && result.data.taskId) {
                        const newTask = {
                            taskId: result.data.taskId,
                            id: result.data.taskId,
                            title: taskName,
                            description: taskDescription,
                            type: 'all',
                            clubId: clubId,
                            videoId: uploadedVideoId || null,
                            pdfId: uploadedPdfId || null,
                            isUnlocked: false,
                            createdAt: new Date().toISOString(),
                        };

                        videoTasks.push(newTask);
                        await renderVideoTasks();

                        setTimeout(async () => {
                            try {
                                const refreshResponse = await API.getTasks(clubId);
                                if (refreshResponse && refreshResponse.code === 0) {
                                    let refreshedTasks = [];
                                    if (Array.isArray(refreshResponse.data)) {
                                        refreshedTasks = refreshResponse.data;
                                    } else if (refreshResponse.data && Array.isArray(refreshResponse.data.list)) {
                                        refreshedTasks = refreshResponse.data.list;
                                    }

                                    videoTasks = refreshedTasks.map(task => ({
                                        taskId: task.taskId || task.id,
                                        id: task.taskId || task.id,
                                        title: task.title || 'æœªå‘½åä»»åŠ¡',
                                        description: task.description || '',
                                        type: task.type || 'all',
                                        clubId: task.clubId || clubId,
                                        videoId: task.videoId || null,
                                        pdfId: task.pdfId || null,
                                        isUnlocked: task.isUnlocked === true,
                                        createdAt: task.createdAt || new Date().toISOString(),
                                    }));
                                    await renderVideoTasks();
                                }
                            } catch (error) {
                                console.error('åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                            }
                        }, 2000);

                    } else {
                        setTimeout(async () => {
                            await loadVideoTasks();
                        }, 500);
                    }

                } else {
                    Utils.showNotification(result?.msg || 'åˆ›å»ºä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                Utils.showNotification('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function removeFile(fileType) {
            const fileLabel = fileType === 'video' ? 'è§†é¢‘æ–‡ä»¶' : fileType === 'pdf' ? 'PDFæ–‡ä»¶' : 'æ–‡ä»¶';
            if (!confirm(`ç¡®å®šè¦ç§»é™¤å·²ä¸Šä¼ çš„${fileLabel}å—ï¼Ÿ`)) {
                return;
            }

            if (fileType === 'video' && currentVideoSubscription) {
                try {
                    currentVideoSubscription.unsubscribe();
                } catch (error) { }
                currentVideoSubscription = null;
            }

            if (fileType === 'pdf' && currentPdfSubscription) {
                try {
                    currentPdfSubscription.unsubscribe();
                } catch (error) { }
                currentPdfSubscription = null;
            }

            if (fileType === 'video' && uploadedVideoId) {
                try {
                    await API.deleteVideo(uploadedVideoId);
                } catch (error) { }
            }

            if (fileType === 'pdf' && uploadedPdfId) {
                const removedId = uploadedPdfId;
                try {
                    const result = await API.deleteResource(removedId);
                    if (result && result.code === 0) {
                        sendFileAnalytics('file_remove_pdf', 'pdf', removedId, null);
                    }
                } catch (error) { }
            }

            const fileInput = document.getElementById(`${fileType}-file`);
            if (fileInput) fileInput.value = '';

            const placeholder = document.querySelector(`#${fileType}-upload-area .upload-placeholder`);
            const progress = document.getElementById(`${fileType}-progress`);
            const preview = document.getElementById(`${fileType}-preview`);

            if (placeholder) placeholder.style.display = 'block';
            if (progress) {
                progress.style.display = 'none';
                if (fileType === 'video') {
                    progress.innerHTML = `
                <div class="progress-container">
                    <div class="progress-bar" id="video-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="video-progress-text">0%</div>
                <div class="file-info" id="video-file-info">
                    <span id="video-duration-info" style="display: none;">
                        <i class="fas fa-clock"></i> æ—¶é•¿: <span id="video-duration">0</span>ç§’
                    </span>
                </div>
            `;
                } else {
                    progress.innerHTML = `
                <div class="progress-container">
                    <div class="progress-bar" id="${fileType}-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="${fileType}-progress-text">0%</div>
                <div class="file-info" id="${fileType}-file-info"></div>
            `;
                }
            }
            if (preview) preview.style.display = 'none';

            if (fileType === 'video') {
                uploadedVideoId = null;
                const previewContainer = document.getElementById('upload-preview');
                if (previewContainer) previewContainer.style.display = 'none';
            }
            if (fileType === 'pdf') {
                uploadedPdfId = null;
                const previewContainer = document.getElementById('pdf-upload-preview');
                if (previewContainer) previewContainer.style.display = 'none';
            }

            alert(`${fileLabel}å·²ç§»é™¤`);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const previewModal = document.getElementById('preview-modal');
            if (previewModal) {
                previewModal.addEventListener('click', function (event) {
                    if (event.target === previewModal) {
                        closePreview();
                    }
                });
            }

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    const previewModal = document.getElementById('preview-modal');
                    if (previewModal && previewModal.style.display === 'flex') {
                        closePreview();
                    }
                }
            });
        });

        async function closeCreateTaskModal(shouldCleanup = true) {
            const modal = document.getElementById('create-task-modal');
            if (modal) {
                modal.style.display = 'none';
            }

            if (shouldCleanup) {
                if (uploadedVideoId) {
                    const removedId = uploadedVideoId;
                    try {
                        const result = await API.deleteVideo(removedId);
                        if (result && result.code === 0) {
                            sendFileAnalytics('file_remove_video', 'video', removedId, null);
                        }
                    } catch (error) { }
                }

                if (uploadedPdfId) {
                    const removedId = uploadedPdfId;
                    try {
                        const result = await API.deleteResource(removedId);
                        if (result && result.code === 0) {
                            sendFileAnalytics('file_remove_pdf', 'pdf', removedId, null);
                        }
                    } catch (error) { }
                }
            }

            const videoFileInput = document.getElementById('video-file');
            if (videoFileInput) videoFileInput.value = '';
            const pdfFileInput = document.getElementById('pdf-file');
            if (pdfFileInput) pdfFileInput.value = '';

            uploadedVideoId = null;
            uploadedPdfId = null;
        }

        async function enterTaskPage(taskId) {
            try {
                const taskDetail = await Tasks.getTaskDetail(taskId);

                if (!taskDetail) {
                    Utils.showNotification('è·å–ä»»åŠ¡ä¿¡æ¯å¤±è´¥', 'error');
                    return;
                }

                await Tasks.setCurrentTask(taskId);

                if (window.App && window.App.navigateTo) {
                    window.App.navigateTo('tasks');
                } else {
                    window.location.hash = 'tasks';
                }
            } catch (error) {
                console.error('è¿›å…¥ä»»åŠ¡é¡µé¢å¤±è´¥:', error);
                Utils.showNotification('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function openEditTaskModal(taskId) {
            try {
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('åªæœ‰ä¿±ä¹éƒ¨åˆ›å»ºè€…å¯ä»¥ä¿®æ”¹ä»»åŠ¡', 'error');
                    return;
                }

                const task = videoTasks.find(t => t.taskId === taskId || t.id === taskId);
                if (!task) {
                    Utils.showNotification('æ‰¾ä¸åˆ°è¯¥ä»»åŠ¡', 'error');
                    return;
                }

                if (window.Utils && Utils.sendAnalyticsEvent) {
                    Utils.sendAnalyticsEvent('task_open_edit_modal', {
                        category: 'teaching',
                        target_type: 'task',
                        target_id: taskId
                    });
                }

                createEditTaskModal(task);

            } catch (error) {
                console.error('æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†å¤±è´¥:', error);
                Utils.showNotification('åŠ è½½ä»»åŠ¡å¤±è´¥', 'error');
            }
        }

        async function createEditTaskModal(task) {
            const existingModal = document.getElementById('edit-task-modal');
            if (existingModal) {
                existingModal.remove();
            }

            editUploadedVideoId = null;
            editUploadedPdfId = null;
            currentEditTaskId = task.taskId || task.id;
            currentEditVideoId = task.videoId || null;
            currentEditPdfId = task.pdfId || null;

            window._editRemoveVideo = false;
            window._editRemovePdf = false;

            let existingVideoHTML = '';
            if (task.videoId) {
                existingVideoHTML = `
                    <div class="existing-file-card video-card" id="edit-existing-video">
                        <i class="fas fa-video efc-icon video-icon"></i>
                        <div class="efc-meta">
                            <div class="efc-name">å·²å…³è”è§†é¢‘ (ID: ${task.videoId})</div>
                            <div class="efc-label video-label">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ åŒºåŸŸå¯æ›¿æ¢</div>
                        </div>
                        <button class="btn-remove-efc" onclick="editRemoveExisting('video')">ç§»é™¤</button>
                    </div>
                `;
            }

            let existingPdfHTML = '';
            if (task.pdfId) {
                existingPdfHTML = `
                    <div class="existing-file-card" id="edit-existing-pdf">
                        <i class="fas fa-file-pdf efc-icon"></i>
                        <div class="efc-meta">
                            <div class="efc-name">å·²å…³è”PDF (ID: ${task.pdfId})</div>
                            <div class="efc-label">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ åŒºåŸŸå¯æ›¿æ¢</div>
                        </div>
                        <button class="btn-remove-efc" onclick="editRemoveExisting('pdf')">ç§»é™¤</button>
                    </div>
                `;
            }

            const modalHTML = `
                <div id="edit-task-modal" class="modal-overlay" style="display: flex;">
                    <div class="modal" style="max-width: 560px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px;"><i class="fas fa-edit"></i> ä¿®æ”¹ä»»åŠ¡</h3>

                        <div class="form-item">
                            <label class="required">ä»»åŠ¡åç§°</label>
                            <input type="text" id="edit-task-name" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°" value="${task.title || ''}">
                        </div>
                        <div class="form-item">
                            <label>ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea id="edit-task-description" placeholder="è¯·ç®€è¦æè¿°è¿™ä¸ªä»»åŠ¡..." rows="3">${task.description || ''}</textarea>
                        </div>

                        <div class="edit-section-title"><i class="fas fa-video" style="color:#1890ff;"></i> å…³è”è§†é¢‘</div>
                        ${existingVideoHTML}
                        <div id="edit-video-new-upload" style="margin-top:${task.videoId ? '10px' : '0'};">
                            <div id="edit-video-placeholder" class="file-upload-area" style="padding:20px; cursor:pointer;"
                                 onclick="document.getElementById('edit-video-file').click()">
                                <input type="file" id="edit-video-file" accept="video/*" style="display:none;"
                                       onchange="handleEditFileSelect(event, 'video')">
                                <i class="fas fa-video" style="font-size:24px; color:#1890ff;"></i>
                                <p style="color:#999; font-size:13px; margin-top:8px;">${task.videoId ? 'ç‚¹å‡»æ›¿æ¢è§†é¢‘' : 'ç‚¹å‡»ä¸Šä¼ è§†é¢‘ï¼ˆå¯é€‰ï¼‰'}</p>
                                <p style="color:#bbb; font-size:12px;">æ”¯æŒMP4ã€MOVç­‰ï¼Œæœ€å¤§20GB</p>
                            </div>
                            <div id="edit-video-progress-container" style="display:none; margin-top:8px;">
                                <div class="progress-container">
                                    <div class="progress-bar" id="edit-video-progress-bar" style="width:0%;"></div>
                                </div>
                                <div class="progress-text" id="edit-video-progress-text">0%</div>
                            </div>
                        </div>

                        <div class="edit-section-title" style="margin-top:20px;"><i class="fas fa-file-pdf" style="color:#722ed1;"></i> æ•™å­¦è®¾è®¡æ¡ˆä¾‹PDF</div>
                        ${existingPdfHTML}
                        <div id="edit-pdf-new-upload" style="margin-top:${task.pdfId ? '10px' : '0'};">
                            <div id="edit-pdf-placeholder" class="file-upload-area" style="padding:20px; cursor:pointer;"
                                 onclick="document.getElementById('edit-pdf-file').click()">
                                <input type="file" id="edit-pdf-file" accept=".pdf" style="display:none;"
                                       onchange="handleEditFileSelect(event, 'pdf')">
                                <i class="fas fa-file-pdf" style="font-size:24px; color:#722ed1;"></i>
                                <p style="color:#999; font-size:13px; margin-top:8px;">${task.pdfId ? 'ç‚¹å‡»æ›¿æ¢PDF' : 'ç‚¹å‡»ä¸Šä¼ PDFï¼ˆå¯é€‰ï¼‰'}</p>
                                <p style="color:#bbb; font-size:12px;">ä»…æ”¯æŒPDFæ ¼å¼</p>
                            </div>
                            <div id="edit-pdf-progress-container" style="display:none; margin-top:8px;">
                                <div class="progress-container">
                                    <div class="progress-bar" id="edit-pdf-progress-bar" style="width:0%; background:linear-gradient(90deg,#722ed1,#a855f7);"></div>
                                </div>
                                <div class="progress-text" id="edit-pdf-progress-text">0%</div>
                            </div>
                        </div>

                        <div style="text-align:right; margin-top: 24px;">
                            <button class="btn btn-outline" onclick="closeEditTaskModal()">å–æ¶ˆ</button>
                            <button class="btn btn-primary" onclick="saveTaskChanges(${task.taskId || task.id})">ä¿å­˜ä¿®æ”¹</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            const modal = document.getElementById('edit-task-modal');
            if (modal) {
                modal.addEventListener('click', function (event) {
                    if (event.target === modal) {
                        closeEditTaskModal();
                    }
                });
            }

            setTimeout(() => {
                const nameInput = document.getElementById('edit-task-name');
                if (nameInput) nameInput.focus();
            }, 100);
        }

        function editRemoveExisting(fileType) {
            if (fileType === 'video') {
                window._editRemoveVideo = true;
                const card = document.getElementById('edit-existing-video');
                if (card) card.style.display = 'none';
                const ph = document.getElementById('edit-video-placeholder');
                if (ph) {
                    const ps = ph.querySelectorAll('p');
                    if (ps[0]) ps[0].textContent = 'ç‚¹å‡»ä¸Šä¼ è§†é¢‘ï¼ˆå¯é€‰ï¼‰';
                }
            }
            if (fileType === 'pdf') {
                window._editRemovePdf = true;
                const card = document.getElementById('edit-existing-pdf');
                if (card) card.style.display = 'none';
                const ph = document.getElementById('edit-pdf-placeholder');
                if (ph) {
                    const ps = ph.querySelectorAll('p');
                    if (ps[0]) ps[0].textContent = 'ç‚¹å‡»ä¸Šä¼ PDFï¼ˆå¯é€‰ï¼‰';
                }
            }
            Utils.showNotification(`å·²æ ‡è®°ç§»é™¤${fileType === 'video' ? 'è§†é¢‘' : 'PDF'}ï¼Œä¿å­˜æ—¶å°†ç”Ÿæ•ˆ`, 'info');
        }

        function closeEditTaskModal() {
            const modal = document.getElementById('edit-task-modal');
            if (modal) {
                modal.remove();
            }
            currentEditTaskId = null;
            currentEditVideoId = null;
            currentEditPdfId = null;
            window._editRemoveVideo = false;
            window._editRemovePdf = false;
        }

        async function saveTaskChanges(taskId) {
            try {
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('åªæœ‰ä¿±ä¹éƒ¨åˆ›å»ºè€…å¯ä»¥ä¿®æ”¹ä»»åŠ¡', 'error');
                    return;
                }

                const nameInput = document.getElementById('edit-task-name');
                const descInput = document.getElementById('edit-task-description');

                if (!nameInput) return;

                const taskName = nameInput.value.trim();
                const taskDescription = descInput ? descInput.value.trim() : '';

                if (!taskName) {
                    Utils.showNotification('è¯·è¾“å…¥ä»»åŠ¡åç§°', 'error');
                    return;
                }

                const videoProgressText = document.getElementById('edit-video-progress-text');
                const pdfProgressText = document.getElementById('edit-pdf-progress-text');
                if (videoProgressText && videoProgressText.textContent && videoProgressText.textContent !== '0%') {
                    const vp = parseInt(videoProgressText.textContent);
                    if (vp > 0 && vp < 100) {
                        Utils.showNotification('è¯·ç­‰å¾…è§†é¢‘ä¸Šä¼ å®Œæˆ', 'warning');
                        return;
                    }
                }
                if (pdfProgressText && pdfProgressText.textContent && pdfProgressText.textContent !== '0%') {
                    const pp = parseInt(pdfProgressText.textContent);
                    if (pp > 0 && pp < 100) {
                        Utils.showNotification('è¯·ç­‰å¾…PDFä¸Šä¼ å®Œæˆ', 'warning');
                        return;
                    }
                }

                Utils.showNotification('æ­£åœ¨ä¿å­˜ä¿®æ”¹...', 'info');

                const updateParams = {
                    title: taskName,
                    description: taskDescription
                };

                if (editUploadedVideoId) {
                    updateParams.videoId = editUploadedVideoId;
                } else if (window._editRemoveVideo) {
                    updateParams.videoId = null;
                }

                if (editUploadedPdfId) {
                    updateParams.pdfId = editUploadedPdfId;
                } else if (window._editRemovePdf) {
                    updateParams.pdfId = null;
                }

                const result = await API.updateTask(taskId, updateParams);

                if (result && result.code === 0) {
                    Utils.showNotification(`ä»»åŠ¡"${taskName}"ä¿®æ”¹æˆåŠŸï¼`, 'success');
                    if (window.Utils && Utils.sendAnalyticsEvent) {
                        Utils.sendAnalyticsEvent('task_save_edit', {
                            category: 'teaching',
                            target_type: 'task',
                            target_id: taskId
                        });
                    }
                    if (window._editRemoveVideo && currentEditVideoId) {
                        sendFileAnalytics('file_remove_video', 'video', currentEditVideoId, taskId);
                    }
                    if (window._editRemovePdf && currentEditPdfId) {
                        sendFileAnalytics('file_remove_pdf', 'pdf', currentEditPdfId, taskId);
                    }
                    closeEditTaskModal();

                    await loadVideoTasks();
                } else {
                    Utils.showNotification(result?.msg || 'ä¿®æ”¹ä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ä¿®æ”¹ä»»åŠ¡å¤±è´¥:', error);
                Utils.showNotification('ä¿®æ”¹ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function confirmDeleteTask(taskId) {
            try {
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('åªæœ‰ä¿±ä¹éƒ¨åˆ›å»ºè€…å¯ä»¥åˆ é™¤ä»»åŠ¡', 'error');
                    return;
                }

                const task = videoTasks.find(t => t.taskId === taskId || t.id === taskId);
                if (!task) {
                    Utils.showNotification('æ‰¾ä¸åˆ°è¯¥ä»»åŠ¡', 'error');
                    return;
                }

                const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${task.title}"å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å­ä»»åŠ¡å’Œå®Œæˆè®°å½•ï¼Œä¸å¯æ’¤é”€`);

                if (confirmed) {
                    await deleteTask(taskId);
                }
            } catch (error) {
                console.error('ç¡®è®¤åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                Utils.showNotification('æ“ä½œå¤±è´¥', 'error');
            }
        }

        async function deleteTask(taskId) {
            try {
                const hasPermission = await checkAndUpdatePermissions();
                if (!hasPermission) {
                    Utils.showNotification('åªæœ‰ä¿±ä¹éƒ¨åˆ›å»ºè€…å¯ä»¥åˆ é™¤ä»»åŠ¡', 'error');
                    return;
                }

                const task = videoTasks.find(t => t.taskId === taskId || t.id === taskId);
                if (!task) {
                    Utils.showNotification('æ‰¾ä¸åˆ°è¯¥ä»»åŠ¡', 'error');
                    return;
                }

                const videoId = task.videoId;
                const pdfId = task.pdfId;

                Utils.showNotification('æ­£åœ¨åˆ é™¤ä»»åŠ¡...', 'info');

                if (videoId) {
                    try {
                        await API.deleteVideo(videoId);
                    } catch (error) { }
                }

                if (pdfId) {
                    try {
                        await API.deleteResource(pdfId);
                    } catch (error) { }
                }

                const result = await API.deleteTask(taskId);

                if (result && result.code === 0) {
                    Utils.showNotification('ä»»åŠ¡åˆ é™¤æˆåŠŸï¼', 'success');

                    if (window.Utils && Utils.sendAnalyticsEvent) {
                        Utils.sendAnalyticsEvent('task_delete', {
                            category: 'teaching',
                            target_type: 'task',
                            target_id: taskId
                        });
                    }

                    await loadVideoTasks();
                } else {
                    Utils.showNotification(result?.msg || 'åˆ é™¤ä»»åŠ¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                Utils.showNotification('åˆ é™¤ä»»åŠ¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        function getTaskTypeLabel(taskType) {
            if (!taskType) return 'è§†é¢‘+ç ”è®¨æ´»åŠ¨';

            const typeMap = {
                'all': 'è§†é¢‘+ç ”è®¨æ´»åŠ¨',
                'watch': 'çœ‹è§†é¢‘ä»»åŠ¡',
                'research': 'ç ”è§†é¢‘ä»»åŠ¡',
            };

            return typeMap[taskType] || 'è§†é¢‘+ç ”è®¨æ´»åŠ¨';
        }

        function goBackToHome() {
            if (window.App && window.App.navigateTo) {
                window.App.navigateTo('home');
            } else {
                window.location.hash = 'home';
            }
        }

        window.openCreateTaskModal = openCreateTaskModal;
        window.closeCreateTaskModal = closeCreateTaskModal;
        window.createNewTask = createNewTask;
        window.enterTaskPage = enterTaskPage;
        window.goBackToHome = goBackToHome;
        window.initVideoPage = initVideoPage;
        window.openEditTaskModal = openEditTaskModal;
        window.closeEditTaskModal = closeEditTaskModal;
        window.saveTaskChanges = saveTaskChanges;
        window.confirmDeleteTask = confirmDeleteTask;
        window.deleteTask = deleteTask;
        window.handleTaskCardClick = handleTaskCardClick;
        window.toggleTaskLock = toggleTaskLock;
        window.removeFile = removeFile;
        window.editRemoveExisting = editRemoveExisting;
        window.handleEditFileSelect = handleEditFileSelect;

        const modalCreate = document.getElementById('create-task-modal');
        if (modalCreate) {
            modalCreate.addEventListener('click', function (event) {
                if (event.target === modalCreate) {
                    closeCreateTaskModal();
                }
            });
        }

        initVideoPage();
    </script>
</body>

</html>